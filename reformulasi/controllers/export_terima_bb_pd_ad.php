 
        <?php
        /* Generated by Sovdev 2 ERP CRUD Generator 2018-02-20 08:46:51 */
        /* Location: ./modules/home/controllers/export_terima_bb_pd_ad.php */
        /* Please DO NOT modify this information : */ 
         
        if ( ! defined('BASEPATH')) exit('No direct script access allowed');
        class export_terima_bb_pd_ad extends MX_Controller {
            function __construct() {
                parent::__construct();
                $this->load->library('auth_export');
                $this->db = $this->load->database('formulasi', false, true);
                $this->user = $this->auth_export->user();
                $this->load->library('lib_utilitas');
            }
            function index($action = '') {
                $action = $this->input->get('action');
                //Bikin Object Baru Nama nya $grid      
                $grid = new Grid;
                $grid->setTitle('Terima BB oleh PD & AD');
                $grid->setTable('reformulasi.export_ro');      
                $grid->setUrl('export_terima_bb_pd_ad');

                //List Table
                $grid->addList('vRo_no','ipo_id','iClose_po','employee.vName','dTgl_terima','isupplier_id'); 
                $grid->setSortBy('iexport_ro');
                $grid->setSortOrder('DESC');  

                //List field
                $grid->addFields('vRo_no','ipo_id','iClose_po','cTerima_pr','dTgl_terima','isupplier_id','detail'); 

                //Setting Grid Width Name 
                /*
                    Kamu bisa merubah nama label dari sini, Contoh :
                    $grid->setLabel('nama field','nama field yang akan diubah');

                */
        
                $grid->setWidth('vRo_no', '100');
                $grid->setAlign('vRo_no', 'left');
                $grid->setLabel('vRo_no','No Penerimaan');
            
                $grid->setWidth('ipo_id', '100');
                $grid->setAlign('ipo_id', 'left');
                $grid->setLabel('ipo_id','No PO');
            
                $grid->setWidth('iClose_po', '100');
                $grid->setAlign('iClose_po', 'left');
                $grid->setLabel('iClose_po','Tutup PO');
                
                

                $grid->setWidth('employee.vName', '300');
                $grid->setAlign('employee.vName', 'left');
                $grid->setLabel('employee.vName','Penerima dari Supplier');


                $grid->setWidth('cTerima_pr', '100');
                $grid->setAlign('cTerima_pr', 'left');
                $grid->setLabel('cTerima_pr','Penerima dari Supplier');
            
                $grid->setWidth('dTgl_terima', '100');
                $grid->setAlign('dTgl_terima', 'left');
                $grid->setLabel('dTgl_terima','Tanggal Terima');
            
                $grid->setWidth('isupplier_id', '250');
                $grid->setAlign('isupplier_id', 'left');
                $grid->setLabel('isupplier_id','Supplier');
            
                $grid->setWidth('iSubmit', '100');
                $grid->setAlign('iSubmit', 'left');
                $grid->setLabel('iSubmit','ISUBMIT');
            
                $grid->setWidth('iApprove_pr', '100');
                $grid->setAlign('iApprove_pr', 'left');
                $grid->setLabel('iApprove_pr','IAPPROVE_PR');
            
                $grid->setWidth('cApprove_pr', '100');
                $grid->setAlign('cApprove_pr', 'left');
                $grid->setLabel('cApprove_pr','CAPPROVE_PR');
            
                $grid->setWidth('dApprove_pr', '100');
                $grid->setAlign('dApprove_pr', 'left');
                $grid->setLabel('dApprove_pr','DAPPROVE_PR');
            
                $grid->setWidth('vRemark', '100');
                $grid->setAlign('vRemark', 'left');
                $grid->setLabel('vRemark','VREMARK');
            
                $grid->setWidth('dCreate', '100');
                $grid->setAlign('dCreate', 'left');
                $grid->setLabel('dCreate','DCREATE');
            
                $grid->setWidth('cCreated', '100');
                $grid->setAlign('cCreated', 'left');
                $grid->setLabel('cCreated','CCREATED');
            
                $grid->setWidth('dupdate', '100');
                $grid->setAlign('dupdate', 'left');
                $grid->setLabel('dupdate','DUPDATE');
            
                $grid->setWidth('cUpdate', '100');
                $grid->setAlign('cUpdate', 'left');
                $grid->setLabel('cUpdate','CUPDATE');
            
                $grid->setWidth('lDeleted', '100');
                $grid->setAlign('lDeleted', 'left');
                $grid->setLabel('lDeleted','LDELETED');
                

                //Example modifikasi GRID ERP
                /*
                    - Set Query
                        $grid->setQuery('lDeleted = 0 ', null); 
                        $grid->setQuery('plc2_upb.iupb_id IN (select distinct(bk.iupb_id) from plc2.plc2_upb_spesifikasi_fg bk where bk.iappqa=2 and bk.ldeleted=0)', null);  

                    - Join Table
                        $grid->setJoinTable('hrd.employee', 'employee.cNip = pk_master.vnip', 'inner');

                    - Change Field Name
                        
                */
                $grid->setRelation('isupplier_id','hrd.mnf_supplier','isupplier_id','vnmsupp','','inner',array('ldeleted'=>0),array('vnmsupp'=>'asc'));

                $grid->setRelation('ipo_id','reformulasi.export_po','ipo_id','vpo_nomor','','inner',array('ldeleted'=>0),array('vpo_nomor'=>'asc'));

                $grid->setJoinTable('hrd.employee', 'employee.cNip = export_ro.cTerima_pr', 'inner');


                $grid->changeFieldType('iClose_po','combobox','',array(''=>'Pilih',0=>'Tidak',1=>'Ya'));
                 //set search
                $grid->setSearch('vRo_no','ipo_id','iClose_po');
                
                //set required
                $grid->setRequired('vRo_no','ipo_id','iClose_po','cTerima_pr','dTgl_terima','isupplier_id','iSubmit','iApprove_pr','cApprove_pr','dApprove_pr','vRemark','dCreate','cCreated','dupdate','cUpdate','lDeleted'); 

                $grid->setGridView('grid');

                switch ($action) {
                    case 'json':
                            $grid->getJsonData();
                            break;
                    case 'view':
                            $grid->render_form($this->input->get('id'), true);
                            break;
                    case 'create':
                            $grid->render_form();
                            break;
                    case 'createproses':
                            echo $grid->saved_form();
                            break;
                    case 'update':
                            $grid->render_form($this->input->get('id'));
                            break;
                    case 'updateprosesx':
                            echo $grid->updated_form();
                            break;
                    case 'updateproses':

                            
                                

                            $isUpload = $this->input->get('isUpload');
                            $sql = array();
                            $sql1 = array();
                            $file_name= "";
                            $file_name1= "";
                            
                            $fileId = array();
                            $path = realpath("files/reformulasi/export/ro_detail_matrik");
                            if($isUpload) {
                                foreach ($this->input->post('iexport_ro_detail') as $key => $idRoDetail) {
                                    

                                    if($isUpload) {
                                        /* Upload Trial */ 
                                        if (!file_exists( $path."/".$idRoDetail )) {
                                            if (!mkdir($path."/".$idRoDetail, 0777, true)) { 
                                                die('Failed upload, try again!');
                                            }
                                        } 
                                        $fileketerangan = array();
                                        foreach($_POST as $key=>$value) {                       
                                            if ($key == 'file_vKeterangan'.$idRoDetail) {
                                                foreach($value as $k=>$v) {
                                                    $fileketerangan[$idRoDetail][$k] = $v;
                                                }
                                            }
                                        } 

                                        //print_r($fileketerangan);
                                        //exit;
                                        $i=0; 

                                        $sql = array();
                                        if (isset($_FILES['fileupload'.$idRoDetail])) {
                                            //$this->hapusfile($path, $file_name, 'export_ro_detail_matrik', $idRoDetail);
                                            $j = 0;
                                            foreach ($_FILES['fileupload'.$idRoDetail]["error"] as $key => $error) {
                                                if ($error == UPLOAD_ERR_OK) {
                                                    $tmp_name = $_FILES['fileupload'.$idRoDetail]["tmp_name"][$key];
                                                    $name = $_FILES['fileupload'.$idRoDetail]["name"][$key];
                                                    $data['vFilename'] = $name;
                                                    $data['nip']=$this->user->gNIP;
                                                    $data['dCreate'] = date('Y-m-d H:i:s');

                                                        if(move_uploaded_file($tmp_name, $path."/".$idRoDetail."/".$name)) 
                                                    {                                   
                                                        $sql[] = "INSERT INTO reformulasi.export_ro_detail_matrik(iexport_ro_detail, vFilename, dCreate, vKeterangan,cCreate) 
                                                            VALUES ('".$idRoDetail."', '".$data['vFilename']."','".$data['dCreate']."','".$fileketerangan[$idRoDetail][$j]."','".$data['nip']."')";                                                                      
                                                        $j++;                                                                           
                                                    }
                                                    else{
                                                    echo "Upload ke folder gagal";  
                                                    }
                                                }
                                            }
                                            foreach($sql as $q) {
                                                try {
                                                    $this->db->query($q);
                                                }catch(Exception $e) {
                                                die($e);
                                                }
                                            } 
                                        }
                                    }
                                }

                                $r['message']="Data Berhasil Disimpan";
                                $r['status'] = TRUE;
                                $r['last_id'] = $this->input->get('lastId');                    
                                echo json_encode($r);

                            }else{
                                foreach ($this->input->post('iexport_ro_detail') as $key => $idRoDetail) {
                                    $fileid1='0';
                                    foreach($_POST as $key=>$value) {
                                        if ($key == 'fileid') {
                                            $i=0;
                                            foreach($value as $k=>$v) {
                                                if($v <> ''){
                                                    if($i > 0){
                                                        //$fileid1 .= "'".$v."'";
                                                    //}else{
                                                        $fileid1 .= ",'".$v."'";
                                                    }

                                                }else{

                                                }
                                                
                                                $i++;
                                            }
                                        }
                                    } 
                                    $tgl= date('Y-m-d H:i:s');
                                    $sql1="update reformulasi.export_ro_detail_matrik set lDeleted=1, 
                                        dupdate='".$tgl."', cUpdate='".$this->user->gNIP."' where 
                                        iexport_ro_detail='".$idRoDetail."' and 
                                        iexport_ro_detail_matrik not in (".$fileid1.")";
                                        //echo $sql1;
                                    $this->db->query($sql1); 
                                }
                               

                                echo $grid->updated_form();
                            }

                            

                    
                            /*$file_vKeterangan = array();
                    
                            foreach($_POST as $key=>$value) {
                                
                                if ($key == 'iexport_ro_detailF') {
                                    foreach($value as $y=>$u) {
                                        $iexport_ro_detail[$y] = $u;
                                    }
                                }

                                if ($key == 'file_vKeterangan') {
                                    foreach($value as $y=>$u) {
                                        $file_vKeterangan[$y] = $u;
                                    }
                                }
                                
                                
                                
                                //
                                if ($key == 'namafile') {
                                    foreach($value as $k=>$v) {
                                        $file_name[$k] = $v;
                                    }
                                }
                                
                                
                                
                                //
                                if ($key == 'fileid') {
                                    foreach($value as $k=>$v) {
                                        $fileId[$k] = $v;
                                    }
                                }
                            }*/
                    
                    
                            /*$last_index = 0;
                            
                    
                            if($isUpload) {

                                $j = $last_index;               
                                                            
                                if (isset($_FILES['fileupload'])) {
                                    $this->hapusfile($path, $file_name, 'export_ro_detail_matrik', $this->input->post('iexport_ro_detail'));
                                    foreach ($_FILES['fileupload']["error"] as $key => $error) {    
                                        if ($error == UPLOAD_ERR_OK) {
                                            $tmp_name = $_FILES['fileupload']["tmp_name"][$key];
                                            $name = $_FILES['fileupload']["name"][$key];
                                            $data['vFilename'] = $name;
                                            $data['id']=$this->input->post('iexport_ro_detail');
                                            $data['nip']=$this->user->gNIP;
                                            $data['dCreate'] = date('Y-m-d H:i:s');
                                            //$file_tanggal[$i] = date('l, F jS, Y', strtotime($file_tanggal[$i]));     
                                            if(move_uploaded_file($tmp_name, $path."/".$this->input->post('iexport_ro_detail')."/".$name)) 
                                            {                                   
                                                $sql[] = "INSERT INTO reformulasi.export_ro_detail_matrik(iexport_ro_detail, vFilename, dCreate, vKeterangan,cCreate) 
                                                    VALUES ('".$iexport_ro_detail[$j]."', '".$data['vFilename']."','".$data['dCreate']."','".$file_vKeterangan[$j]."','".$data['nip']."')";                                                                      
                                                $j++;                                                                           
                                            }
                                            else{
                                            echo "Upload ke folder gagal";  
                                            }
                                        }
                                        
                                    }                       
                                        
                                                            
                                    foreach($sql as $q) {
                                            try {
                                                    $this->db->query($q);
                                            }catch(Exception $e) {
                                                    die($e);
                                            }
                                    }
                                }   
                                
                                
                                $r['status'] = TRUE;
                                $r['last_id'] = $this->input->get('lastId');                    
                                echo json_encode($r);
                                exit();
                            }  else {
                                if (is_array($file_name)) {                                 
                                    $this->hapusfile($path, $file_name, 'export_ro_detail_matrik', $this->input->post('iexport_ro_detail'));
                                }
                                */
                                                    
                                //echo $grid->updated_form();
                            //}
                            break;
                      
                    
                    case 'delete':
                            echo $grid->delete_row();
                            break; 
                    
                    case 'download':
                            $this->download($this->input->get('file'));
                            break;

                    /*
                        //Ini Merupakan Standart Case Untuk Approve

                        case 'approve':
                            echo $this->approve_view();
                            break;
                        case 'approve_process':
                            echo $this->approve_process();
                            break;
                        case 'reject':
                            echo $this->reject_view();
                            break;
                        case 'reject_process':
                            echo $this->reject_process();
                            break; 
                    */ 
                    default:
                            $grid->render_grid();
                            break;
                }
            }
            //Create Manipulate Field 

            //Jika Ingin Menambahkan Seting grid seperti button edit enable dalam kondisi tertentu
            /* 
            function listBox_Action($row, $actions) {
                if ($row->vNo_Or<>'' || $row->vNo_Or<>NULL) { 
                        unset($actions['edit']);
                }
                return $actions;
            } 
            */
            function download($vFilename) {
                $this->load->helper('download');        
                $name = $vFilename;
                $id = $_GET['id'];
                $tempat = $_GET['path'];
                $path = file_get_contents('./files/reformulasi/export/'.$tempat.'/'.$id.'/'.$name);    
                force_download($name, $path);
            }
            function readDirektory($path, $empty="") {
                $vFilename = array();
                        
                if (empty($empty)) {
                    if ($handle = opendir($path)) {     
                        while (false !== ($entry = readdir($handle))) {
                           if ($entry != '.' && $entry != '..' && $entry != '.svn') {                   
                                //unlink($path."/".$entry);
                                $vFilename[] = $entry;
                            }
                        }       
                        closedir($handle);
                    }
                        
                    $x =  $vFilename;
                } else {
                    if ($handle = opendir($path)) {     
                        while (false !== ($entry = readdir($handle))) {
                           if ($entry != '.' && $entry != '..' && $entry != '.svn') {                   
                                //echo $path."/".$entry;
                                unlink($path."/".$entry);                   
                            }
                        }       
                        closedir($handle);
                    }
                    
                    $x = "";
                }
                
                return $x;
            }

            function hapusfile($path, $file_name, $table, $lastId){
                $path = $path."/".$lastId;
                $path = str_replace("\\", "/", $path);
                //echo 'aa : '.$file_name;
                //
                if (is_array($file_name)) {
                                
                    $list_dir  = $this->readDirektory($path);
                    $list_sql  = $this->readSQL($table, $lastId);
                    asort($file_name);      
                    asort($list_dir);       
                    asort($list_sql);
                    
                    //print_r($list_dir);
                    //print_r($list_sql);
                    //print_r($file_name);
                    //$del = array();
                    foreach($list_dir as $v) {              
                        if (!in_array($v, $file_name)) {                
                            unlink($path.'/'.$v);   
                        }           
                    }
                    foreach($list_sql as $v) {
                        if (!in_array($v, $file_name)) {                
                            $del = "delete from reformulasi.".$table." where iexport_ro_detail = {$lastId} and vFilename= '{$v}'";
                            mysql_query($del);  
                        }
                        
                    }
                    
                    //print_r($del);
                    //exit;
                } else {
                    $this->readDirektory($path, 1);
                    $this->readSQL($table, $lastId, 1);
                }
            } 

            function readSQL($table, $lastId, $empty="") {
                $list_file = array();
                if (empty($empty)) {
                    $sql = "SELECT vFilename from reformulasi.".$table." where iexport_ro_detail=".$lastId;
                    $query = mysql_query($sql);
                    while($row = mysql_fetch_array($query, MYSQL_ASSOC)) {  
                        $list_file[] = $row['vFilename'];
                    }
                    
                    $x = $list_file;
                } else {            
                    $sql = "SELECT vFilename from reformulasi.".$table." where iexport_ro_detail=".$lastId;
                    $query = mysql_query($sql);
                    $sql2 = array();
                    while($row = mysql_fetch_array($query, MYSQL_ASSOC)) {
                        $sql2[] = "DELETE FROM reformulasi.".$table." where iexport_ro_detail=".$lastId." and vFilename='".$row['vFilename']."'";         
                    }
                    
                    foreach($sql2 as $q) {
                        try {
                            mysql_query($q);
                        }catch(Exception $e) {
                            die($e);
                        }
                    }
                    
                  $x = "";
                }
                
                return $x;
            } 

            
            function whoAmI($nip){
                $sql = 'select b.vDescription as vdepartemen,a.*,b.*,c.iLvlemp 
                        from hrd.employee a 
                        join hrd.msdepartement b on b.iDeptID=a.iDepartementID
                        join hrd.position c on c.iPostId=a.iPostID
                        where a.cNip ="'.$nip.'"
                        ';
                $data = $this->db->query($sql)->row_array();
                return $data;
            }


            function insertBox_export_terima_bb_pd_ad_detail($field, $id) {
                $o = '<label title="Auto Number">Save First</label>';
                return $o;
            }



            function updateBox_export_terima_bb_pd_ad_iClose_po($field, $id, $value, $rowData) {
                $lmarketing = array(0=>'Tidak', 1=>'Ya');
                $o = "<input type='hidden' name='".$field."' id='".$id."' readonly='readonly' value='".$value."'/>";
                $o .= $lmarketing[$value];
                return  $o;
                

                
            }

            function updateBox_export_terima_bb_pd_ad_detail($field, $id, $value, $rowData) {
                $data['rowData'] = $rowData;
                $data['controller'] = $this;
                return $this->load->view('export/sample/detail_terima_bb_pd_ad', $data,TRUE);
                //return 'xxx';

                
            }


            function insertBox_export_terima_bb_pd_ad_vRo_no($field, $id) {
                $o = '<label title="Auto Number">Auto Number</label>';
                $o .= '<input type="hidden" name="isdraft" id="isdraft">';
                

                return $o;
            }



            function updateBox_export_terima_bb_pd_ad_vRo_no($field, $id, $value, $rowData) {
                $o = "<input type='hidden' name='".$field."' id='".$id."' readonly='readonly' value='".$value."'/>";
                $o .= "<label title='Auto Number'>".$value."</label>";
                $o .= '<input type="hidden" name="isdraft" id="isdraft">';
                return $o;
            }

            function insertBox_export_terima_bb_pd_ad_ipo_id($field, $id) {
                $return = '<script>
                                $( "button.icon_pop" ).button({
                                    icons: {
                                        primary: "ui-icon-newwin"
                                    },
                                    text: false
                                })
                            </script>';
                $return .= '<input type="hidden" name="'.$field.'" id="'.$id.'" class="input_rows1 required" />';
                $return .= '<input type="text" name="'.$field.'_dis" disabled="TRUE" id="'.$id.'_dis" class="input_rows1" size="20" />';
                $return .= '&nbsp;<button class="icon_pop"  onclick="browse(\''.base_url().'processor/reformulasi/browse/po/export?field=export_terima_bb_pd_ad&col=ipo_id\',\'List PO\')" type="button">&nbsp;</button>';
                
                return $return;
            }
            
            function updateBox_export_terima_bb_pd_ad_ipo_id($field, $id, $value) {
                $row = $this->db->get_where('reformulasi.export_po', array('ipo_id'=>$value))->row_array();
                $return = '<script>
                                $( "button.icon_pop" ).button({
                                    icons: {
                                        primary: "ui-icon-newwin"
                                    },
                                    text: false
                                })
                            </script>';
                $return .= '<input type="hidden" value="'.$value.'" name="'.$field.'" id="'.$id.'" class="input_rows1 required" />';
                $return .= $row['vpo_nomor'];
                /*$return .= '<input type="text" value="'.$row['vpo_nomor'].'" name="'.$field.'_dis" disabled="TRUE" id="'.$id.'_dis" class="input_rows1" size="10" />';*/
               /* $return .= '&nbsp;<button class="icon_pop"  onclick="browse(\''.base_url().'processor/reformulasi/browse/po/export?field=export_terima_bb_pd_ad&col=ipo_id\',\'List PO\')" type="button">&nbsp;</button>';*/
                
                return $return;
            }

            /*function insertBox_export_terima_bb_pd_ad_ipo_id($field, $id) {
                $return = '<input type="text" name="'.$field.'"  id="'.$id.'"  class="input_rows1 required" size="30" />';
                $return .= '<script>
                                $("#'.$id.'").keyup(function() {
                                     this.value = this.value.replace(/[^0-9\.]/g,"");
                                });
                             </script>';
                return $return;
            }
            function updateBox_export_terima_bb_pd_ad_ipo_id($field, $id, $value, $rowData) {
                if ($this->input->get('action') == 'view') {
                     $return= $value; 
                }else{
                $return = '<input type="text" name="'.$field.'"  id="'.$id.'"  class="input_rows1 required" size="30" value="'.$value.'"/>';
                $return .= '<script>
                                $("#'.$id.'").keyup(function() {
                                     this.value = this.value.replace(/[^0-9\.]/g,"");
                                });
                             </script>';
                } 
                return $return;
            }*/   
            
            function insertBox_export_terima_bb_pd_ad_cTerima_pr($field, $id) {
                $nip = $this->user->gNIP;
                $iAm = $this->whoAmI($this->user->gNIP);

                $return = '<input type="hidden" name="'.$field.'"  id="'.$id.'" value="'.$nip.'" readonly="readonly" class="input_rows1 required" size="8" />';
                $return .=  $iAm['cNip'].' - '.$iAm['vName'];

                return $return;
            }
            function updateBox_export_terima_bb_pd_ad_cTerima_pr($field, $id, $value, $rowData) {
                if ($this->input->get('action') == 'view') {
                    
                    $iAm = $this->whoAmI($value);

                    $return = '<input type="hidden" name="'.$field.'"  id="'.$id.'" value="'.$iAm['cNip'].'" readonly="readonly" class="input_rows1 required" size="8" />';
                    $return .=  $iAm['cNip'].' - '.$iAm['vName'];

                }else{
                    $iAm = $this->whoAmI($value);

                    $return = '<input type="hidden" name="'.$field.'"  id="'.$id.'" value="'.$iAm['cNip'].'" readonly="readonly" class="input_rows1 required" size="8" />';
                    $return .=  $iAm['cNip'].' - '.$iAm['vName'];

                } 
                return $return;
            }  

            
            function insertBox_export_terima_bb_pd_ad_dTgl_terima($field, $id) {
                $return = '<input type="text" name="'.$field.'"  id="'.$id.'"  class="input_rows1 required" size="8" />';
                $return .= '<script>
                                $("#'.$id.'").datepicker({  changeMonth:true,
                                        changeYear:true,
                                        dateFormat:"yy-mm-dd"}); 
                             </script>';
                return $return;
            }
            function updateBox_export_terima_bb_pd_ad_dTgl_terima($field, $id, $value, $rowData) {
                if ($this->input->get('action') == 'view') {
                     $return= $value; 
                }else{
                $return = '<input type="hidden" name="'.$field.'"  id="'.$id.'"  class="input_rows1 required" size="8" value="'.$value.'"/>';
                $return .= $value; 
                $return .= '<script>
                                $("#'.$id.'").datepicker({
                                    changeMonth:true,
                                    changeYear:true,
                                    dateFormat:"yy-mm-dd"
                                });
                             </script>';
                } 
                return $return;
            }   
            
            function insertBox_export_terima_bb_pd_ad_isupplier_id($field, $id) {
                $return = '<script>
                                $( "button.icon_pop" ).button({
                                    icons: {
                                        primary: "ui-icon-newwin"
                                    },
                                    text: false
                                })
                            </script>';
                $return .= '<input type="hidden" name="'.$field.'" id="'.$id.'" class="input_rows1 required" />';
                $return .= '<input type="text" name="'.$field.'_dis" disabled="TRUE" id="'.$id.'_dis" class="input_rows1" size="50" />';
                $return .= '&nbsp;<button class="icon_pop"  onclick="browse(\''.base_url().'processor/reformulasi/supplier/list/popup?field=export_terima_bb_pd_ad&col=isupplier_id\',\'List Supplier\')" type="button">&nbsp;</button>';
                
                return $return;
            }
            
            function updateBox_export_terima_bb_pd_ad_isupplier_id($field, $id, $value) {
                $row = $this->db->get_where('hrd.mnf_supplier', array('isupplier_id'=>$value))->row_array();
                $return = '<script>
                                $( "button.icon_pop" ).button({
                                    icons: {
                                        primary: "ui-icon-newwin"
                                    },
                                    text: false
                                })
                            </script>';
                $return .= '<input type="hidden" value="'.$value.'" name="'.$field.'" id="'.$id.'" class="input_rows1 required" />';
                $return .= $row['vnmsupp'];
                /*$return .= '<input type="text" value="'.$row['vnmsupp'].'" name="'.$field.'_dis" disabled="TRUE" id="'.$id.'_dis" class="input_rows1" size="50" />';
                $return .= '&nbsp;<button class="icon_pop"  onclick="browse(\''.base_url().'processor/reformulasi/supplier/list/popup?field=export_terima_bb_pd_ad&col=isupplier_id\',\'List Supplier\')" type="button">&nbsp;</button>';*/
                
                return $return;
            }

            
            function insertBox_export_terima_bb_pd_ad_iSubmit($field, $id) {
                $return = '<input type="text" name="'.$field.'"  id="'.$id.'"  class="input_rows1 required" size="30" />';
                $return .= '<script>
                                $("#'.$id.'").keyup(function() {
                                     this.value = this.value.replace(/[^0-9\.]/g,"");
                                });
                             </script>';
                return $return;
            }
            function updateBox_export_terima_bb_pd_ad_iSubmit($field, $id, $value, $rowData) {
                if ($this->input->get('action') == 'view') {
                     $return= $value; 
                }else{
                $return = '<input type="text" name="'.$field.'"  id="'.$id.'"  class="input_rows1 required" size="30" value="'.$value.'"/>';
                $return .= '<script>
                                $("#'.$id.'").keyup(function() {
                                     this.value = this.value.replace(/[^0-9\.]/g,"");
                                });
                             </script>';
                } 
                return $return;
            }   
            
            function insertBox_export_terima_bb_pd_ad_iApprove_pr($field, $id) {
                $return = '<input type="text" name="'.$field.'"  id="'.$id.'"  class="input_rows1 required" size="30" />';
                $return .= '<script>
                                $("#'.$id.'").keyup(function() {
                                     this.value = this.value.replace(/[^0-9\.]/g,"");
                                });
                             </script>';
                return $return;
            }
            function updateBox_export_terima_bb_pd_ad_iApprove_pr($field, $id, $value, $rowData) {
                if ($this->input->get('action') == 'view') {
                     $return= $value; 
                }else{
                $return = '<input type="text" name="'.$field.'"  id="'.$id.'"  class="input_rows1 required" size="30" value="'.$value.'"/>';
                $return .= '<script>
                                $("#'.$id.'").keyup(function() {
                                     this.value = this.value.replace(/[^0-9\.]/g,"");
                                });
                             </script>';
                } 
                return $return;
            }   
            
            function insertBox_export_terima_bb_pd_ad_cApprove_pr($field, $id) {
                $return = '<input type="text" name="'.$field.'"  id="'.$id.'"  class="input_rows1 required" size="30" maxlength = "50" />';
                $return .= '<script>
                                $("#'.$id.'").keyup(function() {
                                    var len = this.value.length;
                                        if (len >= 250) {
                                            this.value = this.value.substring(0, 50);
                                        }
                                    $("#maxlengthnote_'.$id.'").text(50 - len);
                                });
                             </script>';
                $return .= '<br/>tersisa <span id="maxlengthnote_'.$id.'">50</span> karakter<br/>';
                return $return;
            }
            function updateBox_export_terima_bb_pd_ad_cApprove_pr($field, $id, $value, $rowData) {
                if ($this->input->get('action') == 'view') {
                     $return= $value; 
                }else{
                $return = '<input type="text" name="'.$field.'"  id="'.$id.'"  class="input_rows1 required" size="30" maxlength = "50"  value="'.$value.'"/>';
                $return .= '<script>
                                $("#'.$id.'").keyup(function() {
                                    var len = this.value.length;
                                        if (len >= 50) {
                                            this.value = this.value.substring(0, 50);
                                        }
                                    $("#maxlengthnote_'.$id.'").text(50 - len);
                                });
                             </script>';
                $return .= '<br/>tersisa <span id="maxlengthnote_'.$id.'">50</span> karakter<br/>';

                } 
                return $return;
            }   
            
            function insertBox_export_terima_bb_pd_ad_dApprove_pr($field, $id) {
                $return = '<input type="text" name="'.$field.'"  id="'.$id.'"  class="input_rows1 required" size="30" />';
                $return .= '<script>
                                $("#'.$id.'").datepicker({  changeMonth:true,
                                        changeYear:true,
                                        dateFormat:"yy-mm-dd"}); 
                             </script>';
                return $return;
            }
            function updateBox_export_terima_bb_pd_ad_dApprove_pr($field, $id, $value, $rowData) {
                if ($this->input->get('action') == 'view') {
                     $return= $value; 
                }else{
                $return = '<input type="text" name="'.$field.'"  id="'.$id.'"  class="input_rows1 required" size="30" value="'.$value.'"/>';
                $return .= '<script>
                                $("#'.$id.'").datepicker({
                                    changeMonth:true,
                                    changeYear:true,
                                    dateFormat:"yy-mm-dd"
                                });
                             </script>';
                } 
                return $return;
            }   
            
            function insertBox_export_terima_bb_pd_ad_vRemark($field, $id) {
                $return = '<input type="text" name="'.$field.'"  id="'.$id.'"  class="input_rows1 required" size="30" maxlength = "250" />';
                $return .= '<script>
                                $("#'.$id.'").keyup(function() {
                                    var len = this.value.length;
                                        if (len >= 250) {
                                            this.value = this.value.substring(0, 250);
                                        }
                                    $("#maxlengthnote_'.$id.'").text(250 - len);
                                });
                             </script>';
                $return .= '<br/>tersisa <span id="maxlengthnote_'.$id.'">250</span> karakter<br/>';
                return $return;
            }
            function updateBox_export_terima_bb_pd_ad_vRemark($field, $id, $value, $rowData) {
                if ($this->input->get('action') == 'view') {
                     $return= $value; 
                }else{
                $return = '<input type="text" name="'.$field.'"  id="'.$id.'"  class="input_rows1 required" size="30" maxlength = "250"  value="'.$value.'"/>';
                $return .= '<script>
                                $("#'.$id.'").keyup(function() {
                                    var len = this.value.length;
                                        if (len >= 250) {
                                            this.value = this.value.substring(0, 250);
                                        }
                                    $("#maxlengthnote_'.$id.'").text(250 - len);
                                });
                             </script>';
                $return .= '<br/>tersisa <span id="maxlengthnote_'.$id.'">250</span> karakter<br/>';

                } 
                return $return;
            }   
            
            function insertBox_export_terima_bb_pd_ad_dCreate($field, $id) {
                $return = '<input type="text" name="'.$field.'"  id="'.$id.'"  class="input_rows1 required" size="30" />';
                $return .= '<script>
                                $("#'.$id.'").datepicker({  changeMonth:true,
                                        changeYear:true,
                                        dateFormat:"yy-mm-dd"}); 
                             </script>';
                return $return;
            }
            function updateBox_export_terima_bb_pd_ad_dCreate($field, $id, $value, $rowData) {
                if ($this->input->get('action') == 'view') {
                     $return= $value; 
                }else{
                $return = '<input type="text" name="'.$field.'"  id="'.$id.'"  class="input_rows1 required" size="30" value="'.$value.'"/>';
                $return .= '<script>
                                $("#'.$id.'").datepicker({
                                    changeMonth:true,
                                    changeYear:true,
                                    dateFormat:"yy-mm-dd"
                                });
                             </script>';
                } 
                return $return;
            }   
            
            function insertBox_export_terima_bb_pd_ad_cCreated($field, $id) {
                $return = '<input type="text" name="'.$field.'"  id="'.$id.'"  class="input_rows1 required" size="30" maxlength = "50" />';
                $return .= '<script>
                                $("#'.$id.'").keyup(function() {
                                    var len = this.value.length;
                                        if (len >= 250) {
                                            this.value = this.value.substring(0, 50);
                                        }
                                    $("#maxlengthnote_'.$id.'").text(50 - len);
                                });
                             </script>';
                $return .= '<br/>tersisa <span id="maxlengthnote_'.$id.'">50</span> karakter<br/>';
                return $return;
            }
            function updateBox_export_terima_bb_pd_ad_cCreated($field, $id, $value, $rowData) {
                if ($this->input->get('action') == 'view') {
                     $return= $value; 
                }else{
                $return = '<input type="text" name="'.$field.'"  id="'.$id.'"  class="input_rows1 required" size="30" maxlength = "50"  value="'.$value.'"/>';
                $return .= '<script>
                                $("#'.$id.'").keyup(function() {
                                    var len = this.value.length;
                                        if (len >= 50) {
                                            this.value = this.value.substring(0, 50);
                                        }
                                    $("#maxlengthnote_'.$id.'").text(50 - len);
                                });
                             </script>';
                $return .= '<br/>tersisa <span id="maxlengthnote_'.$id.'">50</span> karakter<br/>';

                } 
                return $return;
            }   
            
            function insertBox_export_terima_bb_pd_ad_dupdate($field, $id) {
                $return = '<input type="text" name="'.$field.'"  id="'.$id.'"  class="input_rows1 required" size="30" />';
                $return .= '<script>
                                $("#'.$id.'").datepicker({  changeMonth:true,
                                        changeYear:true,
                                        dateFormat:"yy-mm-dd"}); 
                             </script>';
                return $return;
            }
            function updateBox_export_terima_bb_pd_ad_dupdate($field, $id, $value, $rowData) {
                if ($this->input->get('action') == 'view') {
                     $return= $value; 
                }else{
                $return = '<input type="text" name="'.$field.'"  id="'.$id.'"  class="input_rows1 required" size="30" value="'.$value.'"/>';
                $return .= '<script>
                                $("#'.$id.'").datepicker({
                                    changeMonth:true,
                                    changeYear:true,
                                    dateFormat:"yy-mm-dd"
                                });
                             </script>';
                } 
                return $return;
            }   
            
            function insertBox_export_terima_bb_pd_ad_cUpdate($field, $id) {
                $return = '<input type="text" name="'.$field.'"  id="'.$id.'"  class="input_rows1 required" size="30" maxlength = "50" />';
                $return .= '<script>
                                $("#'.$id.'").keyup(function() {
                                    var len = this.value.length;
                                        if (len >= 250) {
                                            this.value = this.value.substring(0, 50);
                                        }
                                    $("#maxlengthnote_'.$id.'").text(50 - len);
                                });
                             </script>';
                $return .= '<br/>tersisa <span id="maxlengthnote_'.$id.'">50</span> karakter<br/>';
                return $return;
            }
            function updateBox_export_terima_bb_pd_ad_cUpdate($field, $id, $value, $rowData) {
                if ($this->input->get('action') == 'view') {
                     $return= $value; 
                }else{
                $return = '<input type="text" name="'.$field.'"  id="'.$id.'"  class="input_rows1 required" size="30" maxlength = "50"  value="'.$value.'"/>';
                $return .= '<script>
                                $("#'.$id.'").keyup(function() {
                                    var len = this.value.length;
                                        if (len >= 50) {
                                            this.value = this.value.substring(0, 50);
                                        }
                                    $("#maxlengthnote_'.$id.'").text(50 - len);
                                });
                             </script>';
                $return .= '<br/>tersisa <span id="maxlengthnote_'.$id.'">50</span> karakter<br/>';

                } 
                return $return;
            }   
            
            function insertBox_export_terima_bb_pd_ad_lDeleted($field, $id) {
                $return = '<input type="text" name="'.$field.'"  id="'.$id.'"  class="input_rows1 required" size="30" />';
                $return .= '<script>
                                $("#'.$id.'").keyup(function() {
                                     this.value = this.value.replace(/[^0-9\.]/g,"");
                                });
                             </script>';
                return $return;
            }
            function updateBox_export_terima_bb_pd_ad_lDeleted($field, $id, $value, $rowData) {
                if ($this->input->get('action') == 'view') {
                     $return= $value; 
                }else{
                $return = '<input type="text" name="'.$field.'"  id="'.$id.'"  class="input_rows1 required" size="30" value="'.$value.'"/>';
                $return .= '<script>
                                $("#'.$id.'").keyup(function() {
                                     this.value = this.value.replace(/[^0-9\.]/g,"");
                                });
                             </script>';
                } 
                return $return;
            }   
            
            /*
                //Ini Merupakan Standart Approve yang digunakan di erp
 
                function approve_view() {
                    $echo = '<script type="text/javascript">
                                 function submit_ajax(form_id) {
                                    return $.ajax({
                                        url: $("#"+form_id).attr("action"),
                                        type: $("#"+form_id).attr("method"),
                                        data: $("#"+form_id).serialize(),
                                        success: function(data) {
                                            var o = $.parseJSON(data);
                                            var last_id = o.last_id;
                                            var url = "'.base_url().'processor/home/export_terima_bb_pd_ad";                             
                                            if(o.status == true) { 
                                                $("#alert_dialog_form").dialog("close");
                                                     $.get(url+"?action=update&id="+last_id, function(data) {
                                                     $("div#form_export_terima_bb_pd_ad").html(data);
                                                     
                                                });
                                                
                                            }
                                                reload_grid("grid_export_terima_bb_pd_ad");
                                        }
                                        
                                     })
                                 }
                             </script>';
                    $echo .= '<h1>Approve</h1><br />';
                    $echo .= '<form id="form_export_terima_bb_pd_ad_approve" action="'.base_url().'processor/home/export_terima_bb_pd_ad?action=approve_process" method="post">';
                    $echo .= '<div style="vertical-align: top;">';
                    $echo .= 'Remark : 
                            <input type="hidden" name="iexport_ro" value="'.$this->input->get('iexport_ro').'" />
                            <input type="hidden" name="lvl" value="'.$this->input->get('lvl').'" />
                            <input type="hidden" name="group_id" value="'.$this->input->get('group_id').'" />
                            <input type="hidden" name="modul_id" value="'.$this->input->get('modul_id').'" />
                            <textarea name="vRemark"></textarea>
                    <button type="button" onclick="submit_ajax(\'form_export_terima_bb_pd_ad_approve\')">Approve</button>';
                        
                    $echo .= '</div>';
                    $echo .= '</form>';
                    return $echo;
                } 
 
                function approve_process() {
                    $post = $this->input->post();
                    $cNip= $this->user->gNIP;
                    $vName= $this->user->gName;
                    $iexport_ro = $post['iexport_ro'];
                    $vRemark = $post['vRemark'];
                    $lvl = $post['lvl'];
 
                    //Letakan Query Update approve disini

                    $data['status']  = true;
                    $data['last_id'] = $post['iexport_ro'];
                    return json_encode($data);
                }
            */

        
            /*
                //Ini Merupakan Standart Reject yang digunakan di erp

                function reject_view() {
                    $echo = '<script type="text/javascript">
                                 function submit_ajax(form_id) {
                                    var remark = $("#export_terima_bb_pd_ad_remark").val();
                                    if (remark=="") {
                                        alert("Remark tidak boleh kosong ");
                                        return
                                    }

                                    return $.ajax({
                                        url: $("#"+form_id).attr("action"),
                                        type: $("#"+form_id).attr("method"),
                                        data: $("#"+form_id).serialize(),
                                        success: function(data) {
                                            var o = $.parseJSON(data);
                                            var last_id = o.last_id;
                                            var url = "'.base_url().'processor/home/export_terima_bb_pd_ad";                             
                                            if(o.status == true) { 
                                                $("#alert_dialog_form").dialog("close");
                                                     $.get(url+"?action=update&id="+last_id, function(data) {
                                                     $("div#form_export_terima_bb_pd_ad").html(data);
                                                     
                                                });
                                                
                                            }
                                                reload_grid("grid_export_terima_bb_pd_ad");
                                        }
                                        
                                     })
                                 }
                             </script>';
                    $echo .= '<h1>Reject</h1><br />';
                    $echo .= '<form id="form_export_terima_bb_pd_ad_reject" action="'.base_url().'processor/home/export_terima_bb_pd_ad?action=reject_process" method="post">';
                    $echo .= '<div style="vertical-align: top;">';
                    $echo .= 'Remark : 
                            <input type="hidden" name="iexport_ro" value="'.$this->input->get('iexport_ro').'" />
                            <input type="hidden" name="lvl" value="'.$this->input->get('lvl').'" />
                            <input type="hidden" name="group_id" value="'.$this->input->get('group_id').'" />
                            <input type="hidden" name="modul_id" value="'.$this->input->get('modul_id').'" />
                            <textarea name="vRemark" id="reject_export_terima_bb_pd_ad_remark"></textarea>
                    <button type="button" onclick="submit_ajax(\'form_export_terima_bb_pd_ad_reject\')">Reject</button>';
                        
                    $echo .= '</div>';
                    $echo .= '</form>';
                    return $echo;
                }


                
                function reject_process() {
                    $post = $this->input->post();
                    $cNip= $this->user->gNIP;
                    $vName= $this->user->gName;
                    $iexport_ro = $post['iexport_ro'];
                    $vRemark = $post['vRemark'];
                    $lvl = $post['lvl'];
 
                    //Letakan Query Update approve disini

                    $data['status']  = true;
                    $data['last_id'] = $post['iexport_ro'];
                    return json_encode($data);
                }
            */

        
            //Standart Setiap table harus memiliki dCreate , cCreated, dupdate, cUpdate
            function before_insert_processor($row, $postData) {
                $postData['dCreate'] = date('Y-m-d H:i:s');
                $postData['cCreated']=$this->user->gNIP;
                if($postData['isdraft']==true){
                    $postData['iSubmit']=0;
                } 
                else{$postData['iSubmit']=1;} 
                return $postData;

            }
            function before_update_processor($row, $postData) {
                if($postData['isdraft']==true){
                    $postData['iSubmit']=0;
                } 
                else{$postData['iSubmit']=1;} 

                $postData['dupdate'] = date('Y-m-d H:i:s');
                $postData['cUpdate'] = $this->user->gNIP;
                return $postData; 

            }    
        
            function after_insert_processor($fields, $id, $postData) {
                //Example After Insert
                /*
                $cNip = $this->sess_auth->gNIP; 
                $sql = 'Place Query In Here';
                $this->dbset->query($sql);
                */
                $post = $this->input->post();
                $ipo_id = $post['ipo_id'];

                $sqlDetailRequest = 'select * 
                                    from reformulasi.export_request_sample_detail a 
                                    join reformulasi.export_request_sample b on a.iexport_request_sample=b.iexport_request_sample
                                    join reformulasi.export_po_detail c on c.iexport_request_sample=b.iexport_request_sample and c.raw_id=a.raw_id
                                    where a.lDeleted=0
                                    and b.lDeleted=0
                                    and c.ldeleted=0
                                    and c.ipo_id = "'.$ipo_id.'"
                                    ';
                $dDetailRequest = $this->db->query($sqlDetailRequest)->result_array();
                
                /*baru sampai sini*/
                if(!empty($dDetailRequest)){
                    foreach($dDetailRequest as $data) {
                                $idet['iexport_ro'] = $id;
                                $idet['iexport_request_sample_detail'] = $data['iexport_request_sample_detail'];
                                $idet['dCreate'] = date('Y-m-d H:i:s');
                                $idet['cCreated'] = $this->user->gNIP;

                                $this->db->insert('reformulasi.export_ro_detail', $idet);
                            
                        
                    }  
                }
                


                $nomor = "RO".str_pad($id, 8, "0", STR_PAD_LEFT);
                $sql = "UPDATE reformulasi.export_ro SET vRo_no = '".$nomor."' WHERE iexport_ro=$id LIMIT 1";
                $query = $this->db->query( $sql );

            }
    
            function after_update_processor($fields, $id, $postData) {
                //Example After Update
                /*
                $cNip = $this->sess_auth->gNIP; 
                $sql = 'Place Query In Here';
                $this->dbset->query($sql);
                */
                $post = $this->input->post();
                $iexport_ro_detail = $post['iexport_ro_detail'];
                $iJumlah_batch = $post['iJumlah_batch'];
                $iUji_mikro = $post['iUji_mikro'];
                
                
                /*detail batch params*/
                $iexport_ro_detail_batch = $post['iexport_ro_detail_batch'];
                $vNo_batch = $post['vNo_batch'];
                $iJumlah_terima = $post['iJumlah_terima'];
                $vSatuan_batch = $post['vSatuan_batch'];
                $dTgl_terima_batch = $post['dTgl_terima_batch'];
                $vNo_KSK = $post['vNo_KSK'];
                $iOngoing = $post['iOngoing'];

                /*PD, AD, QA PARAMS*/
                $iTerimaPd=$_POST['iTerimaPd'];
                $iJumlah_wadah=$_POST['iJumlah_wadah'];
                $iJumlah_terima_pd=$_POST['iJumlah_terima_pd'];
                $dTgl_terima_pd=$_POST['dTgl_terima_pd'];
                $cPenerima_pd=$_POST['cPenerima_pd'];
                $iSatuan_pd=$_POST['iSatuan_pd'];

                $iTerimaAd=$_POST['iTerimaAd'];
                $iJumlah_terima_ad=$_POST['iJumlah_terima_ad'];
                $dTgl_terima_ad=$_POST['dTgl_terima_ad'];
                $cPenerima_ad=$_POST['cPenerima_ad'];
                $iSatuan_ad=$_POST['iSatuan_ad'];

                $iTerimaQa=$_POST['iTerimaQa'];
                $iJumlah_terima_qa=$_POST['iJumlah_terima_qa'];
                $dTgl_terima_qa=$_POST['dTgl_terima_qa'];
                $cPenerima_qa=$_POST['cPenerima_qa'];
                $iSatuan_qa=$_POST['iSatuan_qa'];
                
                $updet = 0;

                $eRows = $this->db->get_where('reformulasi.export_ro_detail', array('iexport_ro'=>$id, 'lDeleted'=>0))->result_array();
                foreach($eRows as $k => $v) {
                    if(in_array($v['iexport_ro_detail'], $iexport_ro_detail)) {

                        $this->db->where('iexport_ro_detail', $v['iexport_ro_detail']);
                        $key3 = array_search($v['iexport_ro_detail'], $iexport_ro_detail);

                        $this->db->update('reformulasi.export_ro_detail', array('iUji_mikro'=>$iUji_mikro[$key3]));
                        //$updet = 1;




                        $eBatch = $this->db->get_where('reformulasi.export_ro_detail_batch', array('iexport_ro_detail'=>$v['iexport_ro_detail'], 'lDeleted'=>0))->result_array();

                        foreach($eBatch as $k => $v2) {
                            if(in_array($v2['iexport_ro_detail_batch'], $iexport_ro_detail_batch)) {

                                $this->db->where('iexport_ro_detail_batch', $v2['iexport_ro_detail_batch']);
                                $key2 = array_search($v2['iexport_ro_detail_batch'], $iexport_ro_detail_batch);

                                if ($vNo_batch[$key2] == '') {
                                    $vNo_batch[$key2] = NULL;
                                }

                                if ($iJumlah_terima[$key2] == '') {
                                    $iJumlah_terima[$key2] = NULL;
                                }

                                if ($vSatuan_batch[$key2] == '') {
                                    $vSatuan_batch[$key2] = NULL;
                                }

                                if ($dTgl_terima_batch[$key2] == '') {
                                    $dTgl_terima_batch[$key2] = NULL;
                                }

                                if ($vNo_KSK[$key2] == '') {
                                    $vNo_KSK[$key2] = NULL;
                                }


                                /*if ( $dTgl_terima_batch[$key2] <> '' and $iJumlah_terima[$key2] <> "" and $vSatuan_batch[$key2] <> ""  and $dTgl_terima_batch[$key2] <> "" and $vNo_KSK[$key2] <> ""  ){

                                    $iSubmit =1;
                                }else{
                                    $iSubmit =0;
                                }*/



                                /*BAGIAN TERIMA PD, AD , DAN QA START*/

                                /*PD*/
                                if ($iJumlah_wadah[$key2] == '') {
                                    $iJumlah_wadah[$key2] = NULL;
                                }

                                if ($iJumlah_terima_pd[$key2] == '') {
                                    $iJumlah_terima_pd[$key2] = NULL;
                                }

                                if ($dTgl_terima_pd[$key2] == '') {
                                    $dTgl_terima_pd[$key2] = NULL;
                                }

                                if ($cPenerima_pd[$key2] == '') {
                                    $cPenerima_pd[$key2] = NULL;
                                }

                                if ($iSatuan_pd[$key2] == '') {
                                    $iSatuan_pd[$key2] = NULL;
                                }


                                if ( $iJumlah_wadah[$key2] <> '' and $iJumlah_terima_pd[$key2] <> "" and $dTgl_terima_pd[$key2] <> ""  and $cPenerima_pd[$key2] <> ""  and $iSatuan_pd[$key2] <> "" ){

                                    $iTerimaPd =1;
                                }else{
                                    $iTerimaPd =0;
                                }



                                /*AD*/

                                if ($iJumlah_terima_ad[$key2] == '') {
                                    $iJumlah_terima_ad[$key2] = NULL;
                                }

                                if ($dTgl_terima_ad[$key2] == '') {
                                    $dTgl_terima_ad[$key2] = NULL;
                                }

                                if ($cPenerima_ad[$key2] == '') {
                                    $cPenerima_ad[$key2] = NULL;
                                }

                                if ($iSatuan_ad[$key2] == '') {
                                    $iSatuan_ad[$key2] = NULL;
                                }



                                if ( $iJumlah_terima_ad[$key2] <> "" and $dTgl_terima_ad[$key2] <> ""  and $cPenerima_ad[$key2] <> "" and $iSatuan_ad[$key2] <> ""  ){

                                    $iTerimaAd =1;
                                }else{
                                    $iTerimaAd =0;
                                }


                                /*QA*/

                                if ($iJumlah_terima_qa[$key2] == '') {
                                    $iJumlah_terima_qa[$key2] = NULL;
                                }

                                if ($dTgl_terima_qa[$key2] == '') {
                                    $dTgl_terima_qa[$key2] = NULL;
                                }

                                if ($cPenerima_qa[$key2] == '') {
                                    $cPenerima_qa[$key2] = NULL;
                                }

                                if ($iSatuan_qa[$key2] == '') {
                                    $iSatuan_qa[$key2] = NULL;
                                }



                                if ( $iJumlah_terima_qa[$key2] <> "" and $dTgl_terima_qa[$key2] <> ""  and $cPenerima_qa[$key2] <> "" and $iSatuan_qa[$key2] <> ""  ){

                                    $iTerimaQa =1;
                                }else{
                                    $iTerimaQa =0;
                                }



                                /*BAGIAN TERIMA PD, AD, DAN QA END */

                            $updait =  $this->db->update('reformulasi.export_ro_detail_batch', array('vNo_batch'=>$vNo_batch[$key2],
                                                                                            'iJumlah_terima'=>$iJumlah_terima[$key2], 
                                                                                            'vSatuan_batch'=>$vSatuan_batch[$key2], 
                                                                                            'dTgl_terima_batch'=>$dTgl_terima_batch[$key2], 
                                                                                            'vNo_KSK'=>$vNo_KSK[$key2], 
                                                                                            'iOngoing'=>$iOngoing[$key2], 
                                                                                            
                                                                                            //'iSubmit'=>$iSubmit, 
                                                                                            'dupdate'=>date('Y-m-d H:i:s'), 
                                                                                            'cUpdate'=>$this->user->gNIP, 

                                                                                            /*pd, ad, qa*/

                                                                                            'iTerimaPd'=>$iTerimaPd,
                                                                                            'iJumlah_wadah'=>$iJumlah_wadah[$key2],
                                                                                            'iJumlah_terima_pd'=>$iJumlah_terima_pd[$key2],
                                                                                            'dTgl_terima_pd'=>$dTgl_terima_pd[$key2],
                                                                                            'cPenerima_pd'=>$cPenerima_pd[$key2],
                                                                                            'iSatuan_pd'=>$iSatuan_pd[$key2],

                                                                                            'iTerimaAd'=>$iTerimaAd,
                                                                                            'iJumlah_terima_ad'=>$iJumlah_terima_ad[$key2],
                                                                                            'dTgl_terima_ad'=>$dTgl_terima_ad[$key2],
                                                                                            'cPenerima_ad'=>$cPenerima_ad[$key2],
                                                                                            'iSatuan_ad'=>$iSatuan_ad[$key2],


                                                                                            'iTerimaQa'=>$iTerimaQa,
                                                                                            'iJumlah_terima_qa'=>$iJumlah_terima_qa[$key2],
                                                                                            'dTgl_terima_qa'=>$dTgl_terima_qa[$key2],
                                                                                            'cPenerima_qa'=>$cPenerima_qa[$key2],
                                                                                            'iSatuan_qa'=>$iSatuan_qa[$key2],
                                                                                        )
                                                );
                                $updet = 1;


                               /*update nomor KSK yang lain */ 
                                if ($vNo_KSK[$key2] <> '') {
                                    $nomor = $vNo_KSK[$key2];
                                    $pk = $v['iexport_ro_detail'];
                                    $sql = "UPDATE reformulasi.export_ro_detail_batch SET vNo_KSK = '".$nomor."' WHERE iexport_ro_detail=$pk and vNo_KSK is not null ";
                                    //echo $sql;
                                    $query = $this->db->query( $sql );
                                }

                            }
                            else {
                                //$this->db->where('iexport_ro_detail_batch', $v2['iexport_ro_detail_batch']);
                                //$this->db->update('reformulasi.export_ro_detail_batch', array('lDeleted'=>1));
                            }
                        }


                       

                    }
                    else {
                        //$this->db->where('iexport_ro_detail', $v['iexport_ro_detail']);
                        //$this->db->update('reformulasi.export_ro_detail', array('lDeleted'=>1));
                    }
                }


                /*Notifikasi jika ada yang diupdate*/
                if ($updet==1) {
                    

                    $qsql="select *,f.iTeamPD,f.iTeamAndev 
                        from reformulasi.export_ro a 
                        join reformulasi.export_po c on c.ipo_id=a.ipo_id
                        join hrd.employee b on b.cNip=c.cnip
                        join reformulasi.export_po_detail d on d.ipo_id=c.ipo_id
                        join reformulasi.export_request_sample e on e.iexport_request_sample=d.iexport_request_sample
                        join reformulasi.export_req_refor f on f.iexport_req_refor=e.iexport_req_refor
                        where a.lDeleted=0
                        and a.iexport_ro='".$id."'";
                    $rsql = $this->db->query($qsql)->row_array();

                    //echo $qsql;
                    // kirim notifikasi message ERp
                    $sqlEmpAr = 'select * from reformulasi.mailsparam a where a.cVariable="export_terima_pd_ad "';
                    $dEmpAr =  $this->db->query($sqlEmpAr)->row_array();

                       

                    $to = $dEmpAr['vTo'];
                    $cc = $dEmpAr['vCc'];

                    
        
                    $pd = $rsql['iTeamPD'];
                    $andev = $rsql['iTeamAndev'];
                    $qa = '10';


                    $jointeam = $pd.','.$andev.','.$qa;
                    $toEmail = $this->lib_utilitas->get_nip_team( $jointeam );
                    $to = $to.','.$toEmail;
                    $cc = $cc.','.$this->user->gNIP;                        

                    $subject = 'Reformulasi - Update Terima BB oleh PD / AD '.$rsql['vRo_no'];
                    $content="
                        Diberitahukan bahwa telah ada Update data Terima Sample oleh PD / AD dengan rincian sebagai berikut :<br><br>  
                            <table border='0' style='width: 600px;'>
                                <tr>
                                        <td style='width: 110px;'><b>Pembuat PO </b></td><td style='width: 20px;'> : </td>
                                        <td>".$rsql['cNip'].' || '.$rsql['vName']."</td>
                                </tr>
                                <tr>
                                        <td><b>No PO  </b></td><td> : </td>
                                        <td>".$rsql['vpo_nomor']."</td>
                                </tr> 
                                <tr>
                                        <td><b>No Penerimaan  </b></td><td> : </td>
                                        <td>".$rsql['vRo_no']."</td>
                                </tr> 
                                <tr>
                                        <td><b>Tanggal Penerimaan  </b></td><td> : </td>
                                        <td>".$rsql['dTgl_terima']."</td>
                                </tr> 
                            </table> 

                        <br/> <br/>
                        Demikian, mohon segera follow up  pada aplikasi ERP Reformulasi. Terimakasih.<br><br><br>
                        Post Master"; 

                    $this->sess_auth->send_message_erp($this->uri->segment_array(),$to, $cc, $subject, $content);
                }


            }

            function uploadFile (){
                

            }
            function manipulate_update_button($buttons, $rowData) { 
                //Load Javascript In Here 
                $logged_nip =$this->user->gNIP;


                //$update = '<button onclick="javascript:update_btn_back(\'export_terima_bb_pd_ad\', \''.base_url().'processor/reformulasi/export/terima/bb/pd/ad?company_id='.$this->input->get('company_id').'&group_id='.$this->input->get('group_id').'&modul_id='.$this->input->get('modul_id').'\', this)" class="ui-button-text icon-save" id="button_save_terima_bb_pd_ad">Update & Submit</button>';
                //$updatedraft = '<button onclick="javascript:update_draft_btn(\'export_terima_bb_pd_ad\', \''.base_url().'processor/reformulasi/export/terima/bb/pd/ad?company_id='.$this->input->get('company_id').'&draft=true&group_id='.$this->input->get('group_id').'&modul_id='.$this->input->get('modul_id').'\', this, true)" class="ui-button-text icon-save" id="button_save_terima_bb_pd_ad">Update as Draft</button>';
                
                $update = '<button onclick="javascript:update_btn_back(\'export_terima_bb_pd_ad\', \''.base_url().'processor/reformulasi/export/terima/bb/pd/ad?company_id='.$this->input->get('company_id').'&group_id='.$this->input->get('group_id').'&modul_id='.$this->input->get('modul_id').'\', this)" class="ui-button-text icon-save" id="button_save_terima_bb_pd_ad">Update & Submit</button>';

                $js = $this->load->view('export/js/terima_bb_pd_ad_js');
                $js .= $this->load->view('export/js/upload_js');

                if ($this->input->get('action') == 'view') {
                    unset($buttons['update']);
                }
                else{ 
                    
                    //$buttons['update'] = $updatedraft.$update.$js; 
                    $buttons['update'] = $update.$js; 
                }



                    

                        
                
                return $buttons;
            }

            function manipulate_update_button1($buttons, $rowData) { 
                //Load Javascript In Here 
                if ($this->input->get('action') == 'view') {
                    unset($buttons['update']);
                }
                else{ 
                    
                }
                
                return $buttons;
            }
            //Output
            public function output(){
                $this->index($this->input->get('action'));
            }
        }