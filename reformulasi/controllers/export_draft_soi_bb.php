 
        <?php
        /* Generated by Sovdev 2 ERP CRUD Generator 2018-03-08 15:20:34 */
        /* Location: ./modules/home/controllers/export_draft_soi_bb.php */
        /* Please DO NOT modify this information : */ 
         
        if ( ! defined('BASEPATH')) exit('No direct script access allowed');
        class export_draft_soi_bb extends MX_Controller {
            function __construct() {
                parent::__construct();
                $this->load->library('auth_export');
                $this->user = $this->auth_export->user(); 
                $this->db = $this->load->database('formulasi', false, true);
                $this->url = 'export_draft_soi_bb';
                $this->load->library('lib_utilitas');
            }
            function index($action = '') {
                $action = $this->input->get('action');
                //Bikin Object Baru Nama nya $grid      
                $grid = new Grid;
                $grid->setTitle('DRAFT SOI BB');
                $grid->setTable('reformulasi.export_draft_soi_bb');      
                $grid->setUrl('export_draft_soi_bb');

                //List Table
                $grid->addList('plc2_raw_material.vnama','export_req_refor.vno_export_req_refor','dossier_upd.vUpd_no','dossier_upd.vNama_usulan','vNo_draft','ireformulasi_team','iSubmit','iApprove'); 
                $grid->setSortBy('iexport_draft_soi_bb');
                $grid->setSortOrder('DESC');  

                //List field
                $grid->addFields('iexport_ro_detail','vNo_draft','dMulai_draft','dSelesai_draft','ireformulasi_team','cPic_penyusun','file_filename','iApprove'); 

                //Setting Grid Width Name 
                /*
                    Kamu bisa merubah nama label dari sini, Contoh :
                    $grid->setLabel('nama field','nama field yang akan diubah');

                */
            
                

                $grid->setWidth('plc2_raw_material.vnama', '200');
                $grid->setAlign('plc2_raw_material.vnama', 'left');
                $grid->setLabel('plc2_raw_material.vnama','Bahan Baku');

                $grid->setWidth('export_req_refor.vno_export_req_refor', '100');
                $grid->setAlign('export_req_refor.vno_export_req_refor', 'center');
                $grid->setLabel('export_req_refor.vno_export_req_refor','No Req. Refor');

                $grid->setWidth('dossier_upd.vUpd_no', '100');
                $grid->setAlign('dossier_upd.vUpd_no', 'center');
                $grid->setLabel('dossier_upd.vUpd_no','No UPD');

                $grid->setWidth('dossier_upd.vNama_usulan', '350');
                $grid->setAlign('dossier_upd.vNama_usulan', 'left');
                $grid->setLabel('dossier_upd.vNama_usulan','Nama Usulan');





                $grid->setWidth('iexport_ro_detail', '100');
                $grid->setAlign('iexport_ro_detail', 'left');
                $grid->setLabel('iexport_ro_detail','Bahan Baku');
            
                $grid->setWidth('vNo_draft', '100');
                $grid->setAlign('vNo_draft', 'left');
                $grid->setLabel('vNo_draft','No Draft');
            
                $grid->setWidth('dMulai_draft', '150');
                $grid->setAlign('dMulai_draft', 'left');
                $grid->setLabel('dMulai_draft','Tgl Mulai Pembuatan');
            
                $grid->setWidth('dSelesai_draft', '150');
                $grid->setAlign('dSelesai_draft', 'left');
                $grid->setLabel('dSelesai_draft','Tgl Selesai Pembuatan');
            
                $grid->setWidth('cPic_penyusun', '100');
                $grid->setAlign('cPic_penyusun', 'left');
                $grid->setLabel('cPic_penyusun','PIC Penyusun');
            
                $grid->setWidth('ireformulasi_team', '100');
                $grid->setAlign('ireformulasi_team', 'left');
                $grid->setLabel('ireformulasi_team','Team Andev');
            
                $grid->setWidth('iApprove', '100');
                $grid->setAlign('iApprove', 'left');
                $grid->setLabel('iApprove','Status Approval');

                $grid->setWidth('iSubmit', '100');
                $grid->setAlign('iSubmit', 'left');
                $grid->setLabel('iSubmit','Status Submit');


            
                $grid->setWidth('cApprove', '100');
                $grid->setAlign('cApprove', 'left');
                $grid->setLabel('cApprove','CAPPROVE');
            
                $grid->setWidth('dApprove', '100');
                $grid->setAlign('dApprove', 'left');
                $grid->setLabel('dApprove','DAPPROVE');
            
                $grid->setWidth('vRemark', '100');
                $grid->setAlign('vRemark', 'left');
                $grid->setLabel('vRemark','VREMARK');
            
                $grid->setWidth('dCreate', '100');
                $grid->setAlign('dCreate', 'left');
                $grid->setLabel('dCreate','DCREATE');
            
                $grid->setWidth('cCreated', '100');
                $grid->setAlign('cCreated', 'left');
                $grid->setLabel('cCreated','CCREATED');
            
                $grid->setWidth('dupdate', '100');
                $grid->setAlign('dupdate', 'left');
                $grid->setLabel('dupdate','DUPDATE');
            
                $grid->setWidth('cUpdate', '100');
                $grid->setAlign('cUpdate', 'left');
                $grid->setLabel('cUpdate','CUPDATE');
            
                $grid->setWidth('lDeleted', '100');
                $grid->setAlign('lDeleted', 'left');
                $grid->setLabel('lDeleted','LDELETED');
                

                //Join Table
                    $grid->setJoinTable('reformulasi.export_ro_detail', 'export_ro_detail.iexport_ro_detail = export_draft_soi_bb.iexport_ro_detail', 'inner');
                    $grid->setJoinTable('reformulasi.export_request_sample_detail', 'export_request_sample_detail.iexport_request_sample_detail = export_ro_detail.iexport_request_sample_detail', 'inner');
                    $grid->setJoinTable('plc2.plc2_raw_material', 'plc2_raw_material.raw_id = export_request_sample_detail.raw_id', 'inner');
                    $grid->setJoinTable('reformulasi.export_request_sample', 'export_request_sample.iexport_request_sample = export_request_sample_detail.iexport_request_sample', 'inner');
                    $grid->setJoinTable('reformulasi.export_req_refor', 'export_req_refor.iexport_req_refor = export_request_sample.iexport_req_refor', 'inner');
                    $grid->setJoinTable('dossier.dossier_upd', 'dossier_upd.idossier_upd_id = export_req_refor.idossier_upd_id', 'inner');
                    $grid->setRelation('ireformulasi_team','reformulasi.reformulasi_team','ireformulasi_team','vteam','vteam','inner',array('ldeleted'=>0,'iTipe'=>2,'cDeptId'=>5),array('vteam'=>'asc'));

                // Change Field Name
                $grid->changeFieldType('iSubmit','combobox','',array('0'=>'Draft','1'=>'Submitted'));
                $grid->changeFieldType('iApprove','combobox','',array('0'=>'Waiting Approval','1'=>'Rejected','2'=>'Approved'));

                //Example modifikasi GRID ERP
                /*
                    - Set Query
                        $grid->setQuery('lDeleted = 0 ', null); 
                        $grid->setQuery('plc2_upb.iupb_id IN (select distinct(bk.iupb_id) from plc2.plc2_upb_spesifikasi_fg bk where bk.iappqa=2 and bk.ldeleted=0)', null);  

                    - Join Table
                        $grid->setJoinTable('hrd.employee', 'employee.cNip = pk_master.vnip', 'inner');

                    - Change Field Name
                        $grid->changeFieldType('ideleted','combobox','',array(''=>'Pilih',0=>'Aktif',1=>'Tidak aktif'));
                */

                 //set search
                $grid->setSearch('vNo_draft','ireformulasi_team');
                
                //set required
                $grid->setRequired('iexport_ro_detail','vNo_draft','dMulai_draft','dSelesai_draft','cPic_penyusun','ireformulasi_team','iApprove','cApprove','dApprove','vRemark','dCreate','cCreated','dupdate','cUpdate','lDeleted'); 

                $grid->setGridView('grid');

                switch ($action) {
                    case 'json':
                            $grid->getJsonData();
                            break;
                    case 'view':
                            $grid->render_form($this->input->get('id'), true);
                            break;
                    case 'create':
                            $grid->render_form();
                            break;
                    case 'createproses':
                            $isUpload = $this->input->get('isUpload');
                            $sql = array();
                            $sql1 = array();
                            if($isUpload) {
                                $path = realpath("files/reformulasi/export/export_draft_soi_bb/");
                                //$path1 = realpath("files/reformulasi/export/export_draft_soi_bb/rpt_study_literatur/");
                                
                                if (!mkdir($path."/".$this->input->get('lastId'), 0777, true)) {
                                    die('Failed upload, try again!');
                                }
                                /*if (!mkdir($path1."/".$this->input->get('lastId'), 0777, true)) {
                                    die('Failed upload, try again!');
                                }*/
                                
                                $file_keterangan = array();
                                foreach($_POST as $key=>$value) {                       
                                    if ($key == 'file_vKeterangan') {
                                        foreach($value as $k=>$v) {
                                            $file_keterangan[$k] = $v;
                                        }
                                    }
                                    /*if ($key == 'fileketerangan1') {
                                        foreach($value as $k=>$v) {
                                            $file_keterangan1[$k] = $v;
                                        }
                                    }*/
                                    
                                }
                            
                                $i = 0;
                                //upload form 1
                                foreach ($_FILES['fileupload']["error"] as $key => $error) {
                                    if ($error == UPLOAD_ERR_OK) {              
                                        $tmp_name = $_FILES['fileupload']["tmp_name"][$key];
                                        $name = $_FILES['fileupload']["name"][$key];
                                        $data['filename'] = $name;
                                        $data['id']=$this->input->get('lastId');
                                        $data['nip']=$this->user->gNIP;
                                        //$data['iupb_id'] = $insertId;
                                        //$file_tanggal[$i] = date('l, F jS, Y', strtotime($file_tanggal[$i]));     
                                        $data['dInsertDate'] = date('Y-m-d H:i:s');
                                        if(move_uploaded_file($tmp_name, $path."/".$this->input->get('lastId')."/".$name)) {    
                                            $sql[] = "INSERT INTO reformulasi.export_draft_soi_bb_file(iexport_draft_soi_bb, vFilename, dCreate, vKeterangan,cCreate) 
                                                    VALUES ('".$data['id']."', '".$data['filename']."','".$data['dInsertDate']."','".$file_keterangan[$i]."','".$data['nip']."')";
                                            $i++;                                                                           
                                        }
                                        else{
                                        echo "Upload ke folder gagal";  
                                        }
                                    }
                                    
                                }           
                                foreach($sql as $q) {
                                    try {
                                        $this->db->query($q);
                                    }catch(Exception $e) {
                                        die($e);
                                    }
                                }
                                
                               
                                $r['status'] = TRUE;
                                $r['last_id'] = $this->input->get('lastId');                    
                                echo json_encode($r);
                                exit();
                            }  else {
                                echo $grid->saved_form();
                            }
                            break;
                    case 'update':
                            $grid->render_form($this->input->get('id'));
                            break;
                    case 'updateprosesx':
                            echo $grid->updated_form();
                            break;
                    case 'updateproses':
                            $isUpload = $this->input->get('isUpload');
                            $lastId=$_POST['export_draft_soi_bb_iexport_draft_soi_bb'];
                            $sql = array();
                            $sql1 = array();
                            $file_name= "";
                            $file_name1= "";
                            
                            $fileId = array();
                            $path = realpath("files/reformulasi/export/export_draft_soi_bb");
                    
                            if (!file_exists( $path."/".$this->input->post('export_draft_soi_bb_iexport_draft_soi_bb') )) {
                                mkdir($path."/".$this->input->post('export_draft_soi_bb_iexport_draft_soi_bb'), 0777, true);                      
                            }

                    
                            $file_vKeterangan = array();
                    
                            foreach($_POST as $key=>$value) {
                                                        
                                if ($key == 'file_vKeterangan') {
                                    foreach($value as $y=>$u) {
                                        $file_vKeterangan[$y] = $u;
                                    }
                                }
                                
                                
                                
                                //
                                if ($key == 'namafile') {
                                    foreach($value as $k=>$v) {
                                        $file_name[$k] = $v;
                                    }
                                }
                                
                                
                                
                                //
                                if ($key == 'fileid') {
                                    foreach($value as $k=>$v) {
                                        $fileId[$k] = $v;
                                    }
                                }
                                
                                
                            }
                    
                    
                            $last_index = 0;
                            
                    
                            if($isUpload) {
                                $j = $last_index;               
                                                            
                                if (isset($_FILES['fileupload'])) {
                                    $this->hapusfile($path, $file_name, 'export_draft_soi_bb_file', $lastId);
                                    foreach ($_FILES['fileupload']["error"] as $key => $error) {    
                                        if ($error == UPLOAD_ERR_OK) {
                                            $tmp_name = $_FILES['fileupload']["tmp_name"][$key];
                                            $name = $_FILES['fileupload']["name"][$key];
                                            $data['vFilename'] = $name;
                                            $data['id']=$this->input->post('export_draft_soi_bb_iexport_draft_soi_bb');
                                            $data['nip']=$this->user->gNIP;
                                            $data['dCreate'] = date('Y-m-d H:i:s');
                                            //$file_tanggal[$i] = date('l, F jS, Y', strtotime($file_tanggal[$i]));     
                                            if(move_uploaded_file($tmp_name, $path."/".$this->input->post('export_draft_soi_bb_iexport_draft_soi_bb')."/".$name)) 
                                            {                                   
                                                $sql[] = "INSERT INTO reformulasi.export_draft_soi_bb_file(iexport_draft_soi_bb, vFilename, dCreate, vKeterangan,cCreate) 
                                                    VALUES ('".$data['id']."', '".$data['vFilename']."','".$data['dCreate']."','".$file_vKeterangan[$j]."','".$data['nip']."')";                                                                      
                                                $j++;                                                                           
                                            }
                                            else{
                                            echo "Upload ke folder gagal";  
                                            }
                                        }
                                        
                                    }                       
                                        
                                    //print_r($sql);
                                    foreach($sql as $q) {
                                            try {
                                                    $this->db->query($q);
                                            }catch(Exception $e) {
                                                    die($e);
                                            }
                                    }
                                }   
                                
                                
                                $r['status'] = TRUE;
                                $r['last_id'] = $lastId;                    
                                echo json_encode($r);
                                exit();
                            }  else {
                                if (is_array($file_name)) {                                 
                                    //echo "adaaaaaaaaaaaaaaaaaaa";
                                    $this->hapusfile($path, $file_name, 'export_draft_soi_bb_file', $lastId);
                                }
                                                    
                                echo $grid->updated_form();
                            }
                            break;
                
                    case 'delete':
                            echo $grid->delete_row();
                            break;
                    case 'getPicPenyusun':
                        echo $this->getPicPenyusun();
                        break; 
                    
                        //Ini Merupakan Standart Case Untuk Approve

                        case 'approve':
                            echo $this->approve_view();
                            break;
                        case 'approve_process':
                            echo $this->approve_process();
                            break;
                        case 'reject':
                            echo $this->reject_view();
                            break;
                        case 'reject_process':
                            echo $this->reject_process();
                            break; 
                     
                    default:
                            $grid->render_grid();
                            break;
                }
            }
            //Create Manipulate Field 

            //Jika Ingin Menambahkan Seting grid seperti button edit enable dalam kondisi tertentu
             
            function listBox_Action($row, $actions) {
                /*if ($row->vNo_Or<>'' || $row->vNo_Or<>NULL) { 
                        unset($actions['edit']);
                }*/

                if ($row->iApprove == 0) {
                    //masih draft
                    if (isset($mydept)) {
                        // cek punya dep
                        if((in_array('AD', $mydept))) {
                            //$buttons['update'] = $update.$updatedraft.$js;
                        }
                    }


                }else{
                    // sudah approve maka tidak bisa edit
                    unset($actions['edit']);

                }   

                return $actions;
            } 
            

            function download($vFilename) {
                $this->load->helper('download');        
                $name = $vFilename;
                $id = $_GET['id']; 
                $path = file_get_contents('./files/reformulasi/export/export_draft_soi_bb/'.$id.'/'.$name);    
                force_download($name, $path);
            }

            function readDirektory($path, $empty="") {
                $vFilename = array();
                        
                if (empty($empty)) {
                    if ($handle = opendir($path)) {     
                        while (false !== ($entry = readdir($handle))) {
                           if ($entry != '.' && $entry != '..' && $entry != '.svn') {                   
                                //unlink($path."/".$entry);
                                $vFilename[] = $entry;
                            }
                        }       
                        closedir($handle);
                    }
                        
                    $x =  $vFilename;
                } else {
                    if ($handle = opendir($path)) {     
                        while (false !== ($entry = readdir($handle))) {
                           if ($entry != '.' && $entry != '..' && $entry != '.svn') {                   
                                //echo $path."/".$entry;
                                unlink($path."/".$entry);                   
                            }
                        }       
                        closedir($handle);
                    }
                    
                    $x = "";
                }
                
                return $x;
            }

            function hapusfile($path, $file_name, $table, $lastId){
                $path = $path."/".$lastId;
                $path = str_replace("\\", "/", $path);
                //echo 'cc : '.$file_name;
                //
                if (is_array($file_name)) {
                                
                    $list_dir  = $this->readDirektory($path);
                    $list_sql  = $this->readSQL($table, $lastId);
                    asort($file_name);      
                    asort($list_dir);       
                    asort($list_sql);
                    
                    //print_r($list_dir);
                    //print_r($list_sql);
                    //print_r($file_name);
                    //$del = array();
                    foreach($list_dir as $v) {              
                        if (!in_array($v, $file_name)) {                
                            unlink($path.'/'.$v);   
                        }           
                    }
                    foreach($list_sql as $v) {
                        if (!in_array($v, $file_name)) {                
                            $del = "delete from reformulasi.".$table." where iexport_draft_soi_bb = {$lastId} and vFilename= '{$v}'";
                            //echo $del;
                            mysql_query($del);  
                        }
                        
                    }
                    
                    //print_r($del);
                    //exit;
                } else {
                    $this->readDirektory($path, 1);
                    $this->readSQL($table, $lastId, 1);
                }
            } 

            function readSQL($table, $lastId, $empty="") {
                $list_file = array();
                if (empty($empty)) {
                    $sql = "SELECT vFilename from reformulasi.".$table." where iexport_draft_soi_bb=".$lastId;
                    $query = mysql_query($sql);
                    while($row = mysql_fetch_array($query, MYSQL_ASSOC)) {  
                        $list_file[] = $row['vFilename'];
                    }
                    
                    $x = $list_file;
                } else {            
                    $sql = "SELECT vFilename from reformulasi.".$table." where iexport_draft_soi_bb=".$lastId;
                    $query = mysql_query($sql);
                    $sql2 = array();
                    while($row = mysql_fetch_array($query, MYSQL_ASSOC)) {
                        $sql2[] = "DELETE FROM reformulasi.".$table." where iexport_draft_soi_bb=".$lastId." and vFilename='".$row['vFilename']."'";         
                    }
                    
                    foreach($sql2 as $q) {
                        try {
                            mysql_query($q);
                        }catch(Exception $e) {
                            die($e);
                        }
                    }
                    
                  $x = "";
                }
                
                return $x;
            }


            function getPicPenyusun() {
                    $teamAD = '5'; // 4 untuk departement ad
                    
                    $idAD = trim($this->input->get('idAD'));      

                    $term = trim($this->input->get('term'));      
                    $data = array();
                    $sql = "select * 
                            from hrd.employee a
                            join hrd.company b on a.iCompanyID=b.iCompanyId
                            where 
                            a.lDeleted=0 
                            and  ( a.vName like '%".$term."%'  or  a.cNip like '%".$term."%' )
                            #hanya nip yang terdaftar pada team
                            and a.cNip in (select b.vnip 
                                               from reformulasi.reformulasi_team a 
                                               join reformulasi.reformulasi_team_item b on b.ireformulasi_team=a.ireformulasi_team
                                               where a.ldeleted=0
                                               and b.ldeleted=0
                                               and a.cDeptId= '".$teamAD."'
                                               and a.iTipe=2
                                               and a.ireformulasi_team in ('".$idAD."')
                                               
                                               union 
                                               
                                                select a.vnip 
                                               from reformulasi.reformulasi_team a 
                                               where a.ldeleted=0
                                               and a.cDeptId= '".$teamAD."'
                                               and a.iTipe=2
                                               and a.ireformulasi_team in ('".$idAD."')   
                                            )
                            ";
                    //echo '<pre>'.$sql;
                    $query = $this->db->query($sql);
                    if ($query->num_rows > 0) {
                        foreach($query->result_array() as $line) {
                            $row_array['value'] = trim($line['cNip']).' - '.trim($line['vName']);
                            $row_array['id']    = $line['cNip'];
                            $row_array['nama']    = trim($line['vName']);
                            array_push($data, $row_array);
                        }
                    }
                    echo json_encode($data);
                    exit;
            }


            function listBox_export_draft_soi_bb_cPic_penyusun($value, $pk, $name, $rowData) {
                $sql = "SELECT a.vName from hrd.employee a where a.cNip = '{$value}'";
                $query = $this->db->query($sql);
                $nama_group = '-';
                if ($query->num_rows() > 0) {
                    $row = $query->row();
                    $nama_group = $row->vName;
                }
                
                return $nama_group;
            }

            
            function insertBox_export_draft_soi_bb_iexport_ro_detail($field, $id) {     
                $uri = 'export_draft_soi_bb';
                $o = "";  
                $o   .= "<div style='
                                padding: 3px;
                                width: 500px;
                                border: 1px solid rgba(51, 23, 93, 0.2);
                                background-color: #FFF;'>";
                
                
                $o   .= "<table border='0' style='width: 100%;'>
                            <tbody>";  
                $o  .="         <tr>
                                    <td width='20%'>Nama Bahan Baku</td>
                                    <td>:</td>
                                    <td width='75%'>";
                $o .= '         <input type="hidden" name="'.$field.'"  id="'.$id.'"  class="'.$id.' input_rows1 required" size="30" />';
                $o .= '         <input readonly type="text" name="'.$uri.'_vnama"  id="'.$uri.'_vnama"  class="'.$uri.'_vnama required input_rows1" size="30" />';
                
                $o .= '         &nbsp;<button class="icon_pop"  onclick="browse(\''.base_url().'processor/reformulasi/export/browse/draft/soi/bb?field=export_draft_soi_bb\',\'List Bahan Baku\')" type="button">Browse</button>';  
                
                $o  .="             </td>
                                </tr>
                                
                                <tr>
                                    <td width='20%'>No Req Refor</td>
                                    <td>:</td>
                                    <td width='75%'> 
                                        <span class='".$uri."_vno_export_req_refor' id='".$uri."_vno_export_req_refor'></span> 
                                    </td>
                                </tr>

                                <tr>
                                    <td width='20%'>No UPD</td>
                                    <td>:</td>
                                    <td width='75%'> 
                                        <span class='".$uri."_vUpd_no' id='".$uri."_vUpd_no'></span> 
                                    </td>
                                </tr>

                                <tr>
                                    <td width='20%'>Nama Usulan</td>
                                    <td>:</td>
                                    <td width='75%'> 
                                        <span class='".$uri."_vNama_usulan' id='".$uri."_vNama_usulan'></span> 
                                    </td>
                                </tr>
                                 

                                <tr>
                                    <td width='20%'>Team PD</td>
                                    <td>:</td>
                                    <td width='75%'> 
                                        <span class='".$uri."_iTeamPD' id='".$uri."_iTeamPD'></span>  
                                    </td>
                                </tr>
                                
                            </tbody>    
                        </table>"; 
                $o .= "    </div>";  

                $o .= '<script>
                        $( "button.icon_pop" ).button({
                            icons: {
                                primary: "ui-icon-newwin"
                            }, 
                        })
                    </script>';

                     
                return $o;
            }
            function updateBox_export_draft_soi_bb_iexport_ro_detail($field, $id, $value, $rowData) {
                $sql = 'SELECT plc2_raw_material.vnama AS plc2_raw_material__vnama, export_req_refor.vno_export_req_refor AS export_req_refor__vno_export_req_refor, dossier_upd.vUpd_no AS dossier_upd__vUpd_no, dossier_upd.vNama_usulan AS dossier_upd__vNama_usulan, reformulasi.reformulasi_team.vteam AS vteam, /*export_draft_soi_bb/export_draft_soi_bb.php/output*/reformulasi.export_draft_soi_bb.*
                        FROM (`reformulasi`.`export_draft_soi_bb`)
                        INNER JOIN `reformulasi`.`export_ro_detail` ON `export_ro_detail`.`iexport_ro_detail` = `export_draft_soi_bb`.`iexport_ro_detail`
                        INNER JOIN `reformulasi`.`export_request_sample_detail` ON `export_request_sample_detail`.`iexport_request_sample_detail` = `export_ro_detail`.`iexport_request_sample_detail`
                        INNER JOIN `plc2`.`plc2_raw_material` ON `plc2_raw_material`.`raw_id` = `export_request_sample_detail`.`raw_id`
                        INNER JOIN `reformulasi`.`export_request_sample` ON `export_request_sample`.`iexport_request_sample` = `export_request_sample`.`iexport_request_sample`
                        INNER JOIN `reformulasi`.`export_req_refor` ON `export_req_refor`.`iexport_req_refor` = `export_req_refor`.`iexport_req_refor`
                        INNER JOIN `dossier`.`dossier_upd` ON `dossier_upd`.`idossier_upd_id` = `export_req_refor`.`idossier_upd_id`
                        INNER JOIN `reformulasi`.`reformulasi_team` ON `reformulasi`.`export_draft_soi_bb`.`ireformulasi_team`=`reformulasi`.`reformulasi_team`.`ireformulasi_team`
                        where export_draft_soi_bb.iexport_draft_soi_bb="'.$rowData['iexport_draft_soi_bb'].'"
                        ';

                        //echo $sql;
                /*$sql = "SELECT * FROM reformulasi.`export_req_refor` lr 
                        join dossier.dossier_upd b on b.idossier_upd_id=lr.idossier_upd_id
                        WHERE lr.`lDeleted` = 0 AND lr.`iexport_req_refor` = '".$value."'";*/
                $dt = $this->db->query($sql)->row_array();

                //print_r($dt);
                
                $_vnama='';
                $vUpd_no = ''; 
                $vNama_usulan = '';
                $_iteam_pd = '';
                $_no_refor = '';
                
                
                if(!empty($dt['iexport_draft_soi_bb'])){
                        


                        $_vnama = $dt['plc2_raw_material__vnama'];
                        $vUpd_no = $dt['dossier_upd__vUpd_no'];
                        $vNama_usulan = $dt['dossier_upd__vNama_usulan'];

                        $_no_refor = $dt['export_req_refor__vno_export_req_refor'];


                        /*$sq = 'select * from reformulasi.export_req_refor a where a.iexport_req_refor =  "'.$dt['iexport_req_refor'].'" ';
                        $dsq = $this->db->query($sq)->row_array();
                        if(empty($dsq['iTeamPD'])){
                            $dsq['iTeamPD'] = '0';
                        }*/

                        $pd = "SELECT r.vteam FROM reformulasi.`reformulasi_team` r WHERE r.lDeleted=0 AND r.ireformulasi_team= '".$dt['ireformulasi_team']."'";
                        $c_pd = $this->db->Query($pd)->row_array();
                        if(empty($c_pd['vteam'])){
                            $c_pd['vteam'] = '-';
                        }
                        $_iteam_pd=$c_pd['vteam'];

                        

                        /*$pd = "SELECT r.vteam FROM reformulasi.`reformulasi_team` r WHERE r.lDeleted=0 AND r.ireformulasi_team= '".$dsq['iTeamPD']."'";
                        $c_pd = $this->db->Query($pd)->row_array();
                        if(empty($c_pd['vteam'])){
                            $c_pd['vteam'] = '-';
                        }
                        $_iteam_pd=$c_pd['vteam'];*/

                       

                        
                }

                $uri = 'export_draft_soi_bb';
                $o = "";  
                $o   .= "<div style='
                                padding: 3px;
                                width: 500px;
                                border: 1px solid rgba(51, 23, 93, 0.2);
                                background-color: #FFF;'>";
                
                
                $o   .= "<table border='0' style='width: 100%;'>
                            <tbody>";  
                $o  .="         <tr>
                                    <td width='20%'>Nama Bahan Baku</td>
                                    <td>:</td>
                                    <td width='75%'>";
                $o .= '         <input type="hidden" name="'.$field.'"  id="'.$id.'"  class="'.$id.' input_rows1 required" size="30" value="'.$value.'"/>';
                $o .= '         <input readonly type="text" name="'.$uri.'_vnama"  id="'.$uri.'_vnama"  class="'.$uri.'_vnama required input_rows1" size="30" value="'.$_vnama.'"/>';
                
                if($rowData['iSubmit']==0){
                    $o .= '         &nbsp;<button class="icon_pop"  onclick="browse(\''.base_url().'processor/reformulasi/export/browse/draft/soi/bb?field=export_draft_soi_bb\',\'List Bahan Baku\')" type="button">Browse</button>';  
                }

                    
                $o  .="             </td>
                                </tr>

                                <tr>
                                    <td width='20%'>No Req Refor</td>
                                    <td>:</td>
                                    <td width='75%'> 
                                        <span class='".$uri."_vno_export_req_refor' id='".$uri."_vno_export_req_refor'>".$_no_refor."</span>
                                    </td>
                                </tr>

                                <tr>
                                    <td width='20%'>No UPD</td>
                                    <td>:</td>
                                    <td width='75%'> 
                                        <span class='".$uri."_vUpd_no' id='".$uri."_vUpd_no'>".$vUpd_no."</span>
                                    </td>
                                </tr>

                                <tr>
                                    <td width='20%'>Nama Usulan</td>
                                    <td>:</td>
                                    <td width='75%'> 
                                        <span class='".$uri."_vNama_usulan' id='".$uri."_vNama_usulan'>".$vNama_usulan."</span>
                                    </td>
                                </tr>
                                 

                                <tr>
                                    <td width='20%'>Team PD</td>
                                    <td>:</td>
                                    <td width='75%'> 
                                        <span class='".$uri."_iTeamPD' id='".$uri."_iTeamPD'>".$_iteam_pd."</span>
                                    </td>
                                </tr>
                                
                            </tbody>    
                        </table>"; 
                $o .= "    </div>";  

                $o .= '<script>
                        $( "button.icon_pop" ).button({
                            icons: {
                                primary: "ui-icon-newwin"
                            }, 
                        })
                    </script>';

                     
                return $o;
            }


            function insertBox_export_draft_soi_bb_file_filename() {
                $data['mydept'] = $this->auth_export->my_depts(TRUE);   
                $data['date'] = date('Y-m-d H:i:s');    
                return $this->load->view('export/sample/export_draft_soi_bb_file',$data,TRUE); 
            }

            function updateBox_export_draft_soi_bb_file_filename($field, $id, $value, $rowData) {
                if (!empty($_GET['idnya'])) {
                    $iexport_draft_soi_bb = $_GET['idnya'];
                }else{
                    $iexport_draft_soi_bb = $rowData['iexport_draft_soi_bb'];
                }
                $data['mydept'] = $this->auth_export->my_depts(TRUE);
                $data['rows'] = $this->db->get_where('reformulasi.export_draft_soi_bb_file', array('iexport_draft_soi_bb'=>$iexport_draft_soi_bb))->result_array();
                return $this->load->view('export/sample/export_draft_soi_bb_file',$data,TRUE);              
            }




            function insertBox_export_draft_soi_bb_iexport_ro_detailx($field, $id) {
                $return = '<input type="text" name="'.$field.'"  id="'.$id.'"  class="input_rows1 required" size="30" />';
                $return .= '<script>
                                $("#'.$id.'").keyup(function() {
                                     this.value = this.value.replace(/[^0-9\.]/g,"");
                                });
                             </script>';
                return $return;
            }
            function updateBox_export_draft_soi_bb_iexport_ro_detailx($field, $id, $value, $rowData) {
                if ($this->input->get('action') == 'view') {
                     $return= $value; 
                }else{
                $return = '<input type="text" name="'.$field.'"  id="'.$id.'"  class="input_rows1 required" size="30" value="'.$value.'"/>';
                $return .= '<script>
                                $("#'.$id.'").keyup(function() {
                                     this.value = this.value.replace(/[^0-9\.]/g,"");
                                });
                             </script>';
                } 
                return $return;
            }   
            
            function insertBox_export_draft_soi_bb_vNo_draft($field, $id) {
                $return = '<input type="text" name="'.$field.'"  id="'.$id.'"  class="input_rows1 required" size="30" maxlength = "50" />';
                $return .= '<script>
                                $("#'.$id.'").keyup(function() {
                                    var len = this.value.length;
                                        if (len >= 250) {
                                            this.value = this.value.substring(0, 50);
                                        }
                                    $("#maxlengthnote_'.$id.'").text(50 - len);
                                });
                             </script>';
                $return .= '<br/>tersisa <span id="maxlengthnote_'.$id.'">50</span> karakter<br/>';
                return $return;
            }
            function updateBox_export_draft_soi_bb_vNo_draft($field, $id, $value, $rowData) {
                if ($this->input->get('action') == 'view') {
                     $return= $value; 
                }else{
                $return = '<input type="text" name="'.$field.'"  id="'.$id.'"  class="input_rows1 required" size="30" maxlength = "50"  value="'.$value.'"/>';
                $return .= '<script>
                                $("#'.$id.'").keyup(function() {
                                    var len = this.value.length;
                                        if (len >= 50) {
                                            this.value = this.value.substring(0, 50);
                                        }
                                    $("#maxlengthnote_'.$id.'").text(50 - len);
                                });
                             </script>';
                $return .= '<br/>tersisa <span id="maxlengthnote_'.$id.'">50</span> karakter<br/>';

                } 
                return $return;
            }   
            
            function insertBox_export_draft_soi_bb_dMulai_draft($field, $id) {
                $return = '<input type="text" name="'.$field.'"  id="'.$id.'"  class="input_rows1 required" size="8" />';
                $return .= '<script>
                                $("#'.$id.'").datepicker({  changeMonth:true,
                                        changeYear:true,
                                        dateFormat:"yy-mm-dd"}); 
                             </script>';
                return $return;
            }
            function updateBox_export_draft_soi_bb_dMulai_draft($field, $id, $value, $rowData) {
                if ($this->input->get('action') == 'view') {
                     $return= $value; 
                }else{
                $return = '<input type="text" name="'.$field.'"  id="'.$id.'"  class="input_rows1 required" size="8" value="'.$value.'"/>';
                $return .= '<script>
                                $("#'.$id.'").datepicker({
                                    changeMonth:true,
                                    changeYear:true,
                                    dateFormat:"yy-mm-dd"
                                });
                             </script>';
                } 
                return $return;
            }   
            
            function insertBox_export_draft_soi_bb_dSelesai_draft($field, $id) {
                $return = '<input type="text" name="'.$field.'"  id="'.$id.'"  class="input_rows1 required" size="8" />';
                $return .= '<script>
                                $("#'.$id.'").datepicker({  changeMonth:true,
                                        changeYear:true,
                                        dateFormat:"yy-mm-dd"}); 
                             </script>';
                return $return;
            }
            function updateBox_export_draft_soi_bb_dSelesai_draft($field, $id, $value, $rowData) {
                if ($this->input->get('action') == 'view') {
                     $return= $value; 
                }else{
                $return = '<input type="text" name="'.$field.'"  id="'.$id.'"  class="input_rows1 required" size="8" value="'.$value.'"/>';
                $return .= '<script>
                                $("#'.$id.'").datepicker({
                                    changeMonth:true,
                                    changeYear:true,
                                    dateFormat:"yy-mm-dd"
                                });
                             </script>';
                } 
                return $return;
            }   
            
            function insertBox_export_draft_soi_bb_cPic_penyusunx($field, $id) {
                $return = '<input type="text" name="'.$field.'"  id="'.$id.'"  class="input_rows1 required" size="30" maxlength = "50" />';
                $return .= '<script>
                                $("#'.$id.'").keyup(function() {
                                    var len = this.value.length;
                                        if (len >= 250) {
                                            this.value = this.value.substring(0, 50);
                                        }
                                    $("#maxlengthnote_'.$id.'").text(50 - len);
                                });
                             </script>';
                $return .= '<br/>tersisa <span id="maxlengthnote_'.$id.'">50</span> karakter<br/>';
                return $return;
            }

            function insertBox_export_draft_soi_bb_cPic_penyusun($field, $id) {
                $url=base_url().'processor/reformulasi/export/draft/soi/bb?action=getPicPenyusun';

                $sql="select * from hrd.employee em where em.cNip='".$rowData['cPic_penyusun']."'";
                $dt=$this->db->query($sql)->row_array();

               
                $re="
                    <input name='".$field."'  id='".$id."' type='hidden'  class='required' />
                    <input name='".$field."_dis'  id='".$id."_dis' type='text' size='40'  class='required' />";     
               


               
                $re.='<script>
                    var config3 = {
                        source: function( request, response) {
                            $.ajax({
                                url: "'.$url.'",
                                beforeSend: function(){
                                    var idAD =  $("#export_draft_soi_bb_ireformulasi_team").val();

                                    if (idAD == "" ){
                                        alert("Pilih AD !!");
                                        $( "#'.$id.'_dis" ).val("");
                                        return
                                    }

                                    $( "#'.$id.'" ).val("");
                                },
                                dataType: "json",
                                data: {
                                    term: request.term,
                                    idAD: $("#export_draft_soi_bb_ireformulasi_team").val(),

                                },
                                success: function( data ) {
                                    response( data );
                                }
                            });
                        },
                        select: function(event, ui){
                            $( "#'.$id.'" ).val(ui.item.id);
                            $( "#'.$id.'_dis" ).val(ui.item.value);
                            return false;
                        },
                        minLength: 2,
                        autoFocus: true,
                    };

                    $( "#'.$id.'_dis" ).livequery(function() {
                        $( this ).autocomplete(config3);
                    });


                    
                    $("#'.$this->url.'_ireformulasi_team" ).on("change",function(){
                        $( "#'.$id.'_dis" ).val("");
                        $( "#'.$id.'" ).val("");
                        
                    });


                </script>';
                return $re;
            }



            function updateBox_export_draft_soi_bb_cPic_penyusun($field, $id, $value, $rowData) {
                $url=base_url().'processor/reformulasi/export/draft/soi/bb?action=getPicPenyusun';

                $sql="select * from hrd.employee em where em.cNip='".$rowData['cPic_penyusun']."'";
                $dt=$this->db->query($sql)->row_array();

                $cPic_penyusun=$dt['cNip'];
                $namepic=$dt['cNip']." - ".$dt['vName'];

                if ($this->input->get('action') == 'view') {
                    $re = $namepic;
                }else{
                     $re="
                    <input name='".$field."'  id='".$id."' type='hidden' value='".$cPic_penyusun."' class='required' />
                    <input name='".$field."_dis'  id='".$id."_dis' type='text' size='40' value='".$namepic."' class='required' />";     
                }


               
                $re.='<script>
                    var config3 = {
                        source: function( request, response) {
                            $.ajax({
                                url: "'.$url.'",
                                beforeSend: function(){
                                    var idAD =  $("#export_draft_soi_bb_ireformulasi_team").val();

                                    if (idAD == "" ){
                                        alert("Pilih AD !!");
                                        $( "#'.$id.'_dis" ).val("");
                                        return
                                    }

                                    $( "#'.$id.'" ).val("");
                                },
                                dataType: "json",
                                data: {
                                    term: request.term,
                                    idAD: $("#export_draft_soi_bb_ireformulasi_team").val(),

                                },
                                success: function( data ) {
                                    response( data );
                                }
                            });
                        },
                        select: function(event, ui){
                            $( "#'.$id.'" ).val(ui.item.id);
                            $( "#'.$id.'_dis" ).val(ui.item.value);
                            return false;
                        },
                        minLength: 2,
                        autoFocus: true,
                    };

                    $( "#'.$id.'_dis" ).livequery(function() {
                        $( this ).autocomplete(config3);
                    });

                    $("#'.$this->url.'_ireformulasi_team" ).on("change",function(){
                        $( "#'.$id.'_dis" ).val("");
                        $( "#'.$id.'" ).val("");
                        
                    });


                </script>';
                return $re;
            }


            function updateBox_export_draft_soi_bb_cPic_penyusunx($field, $id, $value, $rowData) {
                if ($this->input->get('action') == 'view') {
                     $return= $value; 
                }else{
                $return = '<input type="text" name="'.$field.'"  id="'.$id.'"  class="input_rows1 required" size="30" maxlength = "50"  value="'.$value.'"/>';
                $return .= '<script>
                                $("#'.$id.'").keyup(function() {
                                    var len = this.value.length;
                                        if (len >= 50) {
                                            this.value = this.value.substring(0, 50);
                                        }
                                    $("#maxlengthnote_'.$id.'").text(50 - len);
                                });
                             </script>';
                $return .= '<br/>tersisa <span id="maxlengthnote_'.$id.'">50</span> karakter<br/>';

                } 
                return $return;
            }   
            
            function insertBox_export_draft_soi_bb_ireformulasi_team($field, $id) {

                $sql = "select * 
                        from reformulasi.reformulasi_team a 
                        where a.ldeleted=0
                        and a.iTipe=2
                        and a.cDeptId=5 ";
                $teams = $this->db->query($sql)->result_array();
                $echo = '<select class="" name="'.$field.'"  id="'.$id.'"  >';
                $echo .= '<option value="">--Pilih--</option>';
                foreach($teams as $t) {
                    $selected = $dataBacth['ireformulasi_team'] == $t['ireformulasi_team'] ? 'selected' : '';
                    $echo .= '<option '.$selected.' value="'.$t['ireformulasi_team'].'">'.$t['vteam'].'</option>';
                }
                $echo .= '</select>';

                return $echo;

               
            }

            function updateBox_export_draft_soi_bb_ireformulasi_team($field, $id, $value, $rowData) {
                if ($this->input->get('action') == 'view') {
                    // $return= $value; 
                     $sql = "select * 
                            from reformulasi.reformulasi_team a 
                            where a.ldeleted=0
                            and a.iTipe=2
                            and a.cDeptId=5 and a.ireformulasi_team= '".$value."' ";
                    $teams = $this->db->query($sql)->row_array();

                    $return = $teams['vteam'];

                }else{
                    $sql = "select * 
                            from reformulasi.reformulasi_team a 
                            where a.ldeleted=0
                            and a.iTipe=2
                            and a.cDeptId=5 ";
                    $teams = $this->db->query($sql)->result_array();
                    $return = '<select class="" name="'.$field.'"  id="'.$id.'"  >';
                    $return .= '<option value="">--Pilih--</option>';
                    foreach($teams as $t) {
                        $selected = $value == $t['ireformulasi_team'] ? 'selected' : '';
                        $return .= '<option '.$selected.' value="'.$t['ireformulasi_team'].'">'.$t['vteam'].'</option>';
                    }
                    $return .= '</select>';

                    return $return;
                } 
                return $return;
            }   
            
            function insertBox_export_draft_soi_bb_iApprove($field, $id) {
                $return = '-';
                $return .= '<input type="hidden" name="isdraft" id="isdraft">';
                return $return;
            }

            function updateBox_export_draft_soi_bb_iApprove($field, $id, $value, $rowData) {
                //print_r($rowData);
                if(($value <> 0) || (!empty($value))){
                    $sql_dtapp = 'select * 
                                from reformulasi.export_draft_soi_bb a 
                                join hrd.employee b on b.cNip=a.cApprove
                                where
                                a.lDeleted = 0
                                and  a.iexport_draft_soi_bb = "'.$rowData['iexport_draft_soi_bb'].'"';
                    $row = $this->db->query($sql_dtapp)->row_array();
                    if($value==2){
                        $st='<p style="color:green;font-size:120%;">Approved';
                        $ret= $st.' oleh '.$row['vName'].' pada '.$row['dApprove'].'</br> Alasan: '.$row['vRemark'].'</p>';
                    }
                    elseif($value==1){
                        $st='<p style="color:red;font-size:120%;">Rejected';
                        $ret= $st.' oleh '.$row['vName'].' pada '.$row['dApprove'].'</br> Alasan: '.$row['vRemark'].'</p>';
                    } 

                    
                    
                    
                }
                else{
                    $ret='Waiting for Approval';
                }
                $ret .= '<input type="hidden" name="isdraft" id="isdraft">';
                
                return $ret;
            }


            
            
            function insertBox_export_draft_soi_bb_cApprove($field, $id) {
                $return = '<input type="text" name="'.$field.'"  id="'.$id.'"  class="input_rows1 required" size="30" maxlength = "50" />';
                $return .= '<script>
                                $("#'.$id.'").keyup(function() {
                                    var len = this.value.length;
                                        if (len >= 250) {
                                            this.value = this.value.substring(0, 50);
                                        }
                                    $("#maxlengthnote_'.$id.'").text(50 - len);
                                });
                             </script>';
                $return .= '<br/>tersisa <span id="maxlengthnote_'.$id.'">50</span> karakter<br/>';
                return $return;
            }
            function updateBox_export_draft_soi_bb_cApprove($field, $id, $value, $rowData) {
                if ($this->input->get('action') == 'view') {
                     $return= $value; 
                }else{
                $return = '<input type="text" name="'.$field.'"  id="'.$id.'"  class="input_rows1 required" size="30" maxlength = "50"  value="'.$value.'"/>';
                $return .= '<script>
                                $("#'.$id.'").keyup(function() {
                                    var len = this.value.length;
                                        if (len >= 50) {
                                            this.value = this.value.substring(0, 50);
                                        }
                                    $("#maxlengthnote_'.$id.'").text(50 - len);
                                });
                             </script>';
                $return .= '<br/>tersisa <span id="maxlengthnote_'.$id.'">50</span> karakter<br/>';

                } 
                return $return;
            }   
            
            function insertBox_export_draft_soi_bb_dApprove($field, $id) {
                $return = '<input type="text" name="'.$field.'"  id="'.$id.'"  class="input_rows1 required" size="30" />';
                $return .= '<script>
                                $("#'.$id.'").datepicker({  changeMonth:true,
                                        changeYear:true,
                                        dateFormat:"yy-mm-dd"}); 
                             </script>';
                return $return;
            }
            function updateBox_export_draft_soi_bb_dApprove($field, $id, $value, $rowData) {
                if ($this->input->get('action') == 'view') {
                     $return= $value; 
                }else{
                $return = '<input type="text" name="'.$field.'"  id="'.$id.'"  class="input_rows1 required" size="30" value="'.$value.'"/>';
                $return .= '<script>
                                $("#'.$id.'").datepicker({
                                    changeMonth:true,
                                    changeYear:true,
                                    dateFormat:"yy-mm-dd"
                                });
                             </script>';
                } 
                return $return;
            }   
            
            function insertBox_export_draft_soi_bb_vRemark($field, $id) {
                $return = '<input type="text" name="'.$field.'"  id="'.$id.'"  class="input_rows1 required" size="30" maxlength = "250" />';
                $return .= '<script>
                                $("#'.$id.'").keyup(function() {
                                    var len = this.value.length;
                                        if (len >= 250) {
                                            this.value = this.value.substring(0, 250);
                                        }
                                    $("#maxlengthnote_'.$id.'").text(250 - len);
                                });
                             </script>';
                $return .= '<br/>tersisa <span id="maxlengthnote_'.$id.'">250</span> karakter<br/>';
                return $return;
            }
            function updateBox_export_draft_soi_bb_vRemark($field, $id, $value, $rowData) {
                if ($this->input->get('action') == 'view') {
                     $return= $value; 
                }else{
                $return = '<input type="text" name="'.$field.'"  id="'.$id.'"  class="input_rows1 required" size="30" maxlength = "250"  value="'.$value.'"/>';
                $return .= '<script>
                                $("#'.$id.'").keyup(function() {
                                    var len = this.value.length;
                                        if (len >= 250) {
                                            this.value = this.value.substring(0, 250);
                                        }
                                    $("#maxlengthnote_'.$id.'").text(250 - len);
                                });
                             </script>';
                $return .= '<br/>tersisa <span id="maxlengthnote_'.$id.'">250</span> karakter<br/>';

                } 
                return $return;
            }   
            
            function insertBox_export_draft_soi_bb_dCreate($field, $id) {
                $return = '<input type="text" name="'.$field.'"  id="'.$id.'"  class="input_rows1 required" size="30" />';
                $return .= '<script>
                                $("#'.$id.'").datepicker({  changeMonth:true,
                                        changeYear:true,
                                        dateFormat:"yy-mm-dd"}); 
                             </script>';
                return $return;
            }
            function updateBox_export_draft_soi_bb_dCreate($field, $id, $value, $rowData) {
                if ($this->input->get('action') == 'view') {
                     $return= $value; 
                }else{
                $return = '<input type="text" name="'.$field.'"  id="'.$id.'"  class="input_rows1 required" size="30" value="'.$value.'"/>';
                $return .= '<script>
                                $("#'.$id.'").datepicker({
                                    changeMonth:true,
                                    changeYear:true,
                                    dateFormat:"yy-mm-dd"
                                });
                             </script>';
                } 
                return $return;
            }   
            
            function insertBox_export_draft_soi_bb_cCreated($field, $id) {
                $return = '<input type="text" name="'.$field.'"  id="'.$id.'"  class="input_rows1 required" size="30" maxlength = "50" />';
                $return .= '<script>
                                $("#'.$id.'").keyup(function() {
                                    var len = this.value.length;
                                        if (len >= 250) {
                                            this.value = this.value.substring(0, 50);
                                        }
                                    $("#maxlengthnote_'.$id.'").text(50 - len);
                                });
                             </script>';
                $return .= '<br/>tersisa <span id="maxlengthnote_'.$id.'">50</span> karakter<br/>';
                return $return;
            }
            function updateBox_export_draft_soi_bb_cCreated($field, $id, $value, $rowData) {
                if ($this->input->get('action') == 'view') {
                     $return= $value; 
                }else{
                $return = '<input type="text" name="'.$field.'"  id="'.$id.'"  class="input_rows1 required" size="30" maxlength = "50"  value="'.$value.'"/>';
                $return .= '<script>
                                $("#'.$id.'").keyup(function() {
                                    var len = this.value.length;
                                        if (len >= 50) {
                                            this.value = this.value.substring(0, 50);
                                        }
                                    $("#maxlengthnote_'.$id.'").text(50 - len);
                                });
                             </script>';
                $return .= '<br/>tersisa <span id="maxlengthnote_'.$id.'">50</span> karakter<br/>';

                } 
                return $return;
            }   
            
            function insertBox_export_draft_soi_bb_dupdate($field, $id) {
                $return = '<input type="text" name="'.$field.'"  id="'.$id.'"  class="input_rows1 required" size="30" />';
                $return .= '<script>
                                $("#'.$id.'").datepicker({  changeMonth:true,
                                        changeYear:true,
                                        dateFormat:"yy-mm-dd"}); 
                             </script>';
                return $return;
            }
            function updateBox_export_draft_soi_bb_dupdate($field, $id, $value, $rowData) {
                if ($this->input->get('action') == 'view') {
                     $return= $value; 
                }else{
                $return = '<input type="text" name="'.$field.'"  id="'.$id.'"  class="input_rows1 required" size="30" value="'.$value.'"/>';
                $return .= '<script>
                                $("#'.$id.'").datepicker({
                                    changeMonth:true,
                                    changeYear:true,
                                    dateFormat:"yy-mm-dd"
                                });
                             </script>';
                } 
                return $return;
            }   
            
            function insertBox_export_draft_soi_bb_cUpdate($field, $id) {
                $return = '<input type="text" name="'.$field.'"  id="'.$id.'"  class="input_rows1 required" size="30" maxlength = "50" />';
                $return .= '<script>
                                $("#'.$id.'").keyup(function() {
                                    var len = this.value.length;
                                        if (len >= 250) {
                                            this.value = this.value.substring(0, 50);
                                        }
                                    $("#maxlengthnote_'.$id.'").text(50 - len);
                                });
                             </script>';
                $return .= '<br/>tersisa <span id="maxlengthnote_'.$id.'">50</span> karakter<br/>';
                return $return;
            }
            function updateBox_export_draft_soi_bb_cUpdate($field, $id, $value, $rowData) {
                if ($this->input->get('action') == 'view') {
                     $return= $value; 
                }else{
                $return = '<input type="text" name="'.$field.'"  id="'.$id.'"  class="input_rows1 required" size="30" maxlength = "50"  value="'.$value.'"/>';
                $return .= '<script>
                                $("#'.$id.'").keyup(function() {
                                    var len = this.value.length;
                                        if (len >= 50) {
                                            this.value = this.value.substring(0, 50);
                                        }
                                    $("#maxlengthnote_'.$id.'").text(50 - len);
                                });
                             </script>';
                $return .= '<br/>tersisa <span id="maxlengthnote_'.$id.'">50</span> karakter<br/>';

                } 
                return $return;
            }   
            
            function insertBox_export_draft_soi_bb_lDeleted($field, $id) {
                $return = '<input type="text" name="'.$field.'"  id="'.$id.'"  class="input_rows1 required" size="30" />';
                $return .= '<script>
                                $("#'.$id.'").keyup(function() {
                                     this.value = this.value.replace(/[^0-9\.]/g,"");
                                });
                             </script>';
                return $return;
            }
            function updateBox_export_draft_soi_bb_lDeleted($field, $id, $value, $rowData) {
                if ($this->input->get('action') == 'view') {
                     $return= $value; 
                }else{
                $return = '<input type="text" name="'.$field.'"  id="'.$id.'"  class="input_rows1 required" size="30" value="'.$value.'"/>';
                $return .= '<script>
                                $("#'.$id.'").keyup(function() {
                                     this.value = this.value.replace(/[^0-9\.]/g,"");
                                });
                             </script>';
                } 
                return $return;
            }   

            
            function approve_view() {
                $echo = '<script type="text/javascript">
                             function submit_ajax(form_id) {
                                return $.ajax({
                                    url: $("#"+form_id).attr("action"),
                                    type: $("#"+form_id).attr("method"),
                                    data: $("#"+form_id).serialize(),
                                    success: function(data) {
                                        var o = $.parseJSON(data);
                                        var last_id = o.last_id;
                                        var url = "'.base_url().'processor/reformulasi/export/draft/soi/bb";                                
                                        if(o.status == true) {
                                            
                                            $("#alert_dialog_form").dialog("close");
                                                 $.get(url+"?action=update&id="+last_id, function(data) {
                                                 $("div#form_export_draft_soi_bb").html(data);
                                                 $("#button_approve_export_draft_soi_bb").hide();
                                                 $("#button_reject_export_draft_soi_bb").hide();
                                            });
                                            
                                        }
                                            reload_grid("grid_export_draft_soi_bb");
                                    }
                                    
                                 })
                             }
                         </script>';
                $echo .= '<h1>Confirm</h1><br />';
                $echo .= '<form id="form_export_draft_soi_bb_approve" action="'.base_url().'processor/reformulasi/export/draft/soi/bb?action=approve_process" method="post">';
                $echo .= '<div style="vertical-align: top;">';
                $echo .= 'Remark : 
                        <input type="hidden" name="iexport_draft_soi_bb" value="'.$this->input->get('iexport_draft_soi_bb').'" />
                        <input type="hidden" name="lvl" value="'.$this->input->get('lvl').'" />
                        <input type="hidden" name="group_id" value="'.$this->input->get('group_id').'" />
                        <input type="hidden" name="modul_id" value="'.$this->input->get('modul_id').'" />
                        <textarea name="vRemark"></textarea>
                <button type="button" onclick="submit_ajax(\'form_export_draft_soi_bb_approve\')">Confirm</button>';
                    
                $echo .= '</div>';
                $echo .= '</form>';
                return $echo;
            }

            
            function approve_process() {
                $post = $this->input->post();
                $cNip= $this->user->gNIP;
                $vName= $this->user->gName;
                $iexport_draft_soi_bb = $post['iexport_draft_soi_bb'];
                $lvl = $post['lvl'];
                $vRemark = $post['vRemark'];

                
                $data=array('iApprove'=>'2','cApprove'=>$cNip , 'dApprove'=>date('Y-m-d H:i:s'), 'vRemark'=>$vRemark);
                $this -> db -> where('iexport_draft_soi_bb', $iexport_draft_soi_bb);
                $updet = $this -> db -> update('reformulasi.export_draft_soi_bb', $data);


                if ($updet) {
                   $qsql="
                            SELECT export_req_refor.iTeamPD,export_req_refor.iTeamAndev
                            ,a.*,b.*,export_request_sample.vRequest_no,plc2_raw_material.vnama
                            FROM (`reformulasi`.`export_request_sample_detail`)
                            INNER JOIN `reformulasi`.`export_request_sample` ON `export_request_sample`.`iexport_request_sample` = `export_request_sample_detail`.`iexport_request_sample`
                            INNER JOIN `reformulasi`.`export_ro_detail` ON `export_ro_detail`.`iexport_request_sample_detail` = `export_request_sample_detail`.`iexport_request_sample_detail`
                            INNER JOIN `reformulasi`.`export_ro` ON `export_ro`.`iexport_ro` = `export_ro_detail`.`iexport_ro`
                            INNER JOIN `plc2`.`plc2_raw_material` ON `plc2_raw_material`.`raw_id` = `export_request_sample_detail`.`raw_id`
                            INNER JOIN `reformulasi`.`export_req_refor` ON `export_req_refor`.`iexport_req_refor` = `export_request_sample`.`iexport_req_refor`
                            INNER JOIN `dossier`.`dossier_upd` ON `dossier_upd`.`idossier_upd_id` = `export_req_refor`.`idossier_upd_id`
                            join reformulasi.export_draft_soi_bb a on a.iexport_ro_detail=export_ro_detail.iexport_ro_detail
                            join hrd.employee b on b.cNip=a.cPic_penyusun
                            WHERE 
                            a.lDeleted=0
                            and  a.iexport_draft_soi_bb = '".$iexport_draft_soi_bb."'
                    ";

                    $rsql = $this->db->query($qsql)->row_array();

                    if ($rsql['iSubmit']) {
                        // kirim notifikasi message ERp
                        $sqlEmpAr = 'select * from reformulasi.mailsparam a where a.cVariable="export_draft_soi_approve "';
                        $dEmpAr =  $this->db->query($sqlEmpAr)->row_array();

                           

                        $to = $dEmpAr['vTo'];
                        $cc = $dEmpAr['vCc'];

                        

                        $pd = $rsql['iTeamPD'];
                        $andev = $rsql['iTeamAndev'];
                        $qa = '10';


                        $jointeam = $pd.','.$andev.','.$qa;
                        $toEmail = $this->lib_utilitas->get_nip_team( $jointeam );
                        $to = $to.','.$toEmail;
                        $cc = $cc.','.$this->user->gNIP;                        

                        $subject = 'Reformulasi - Approval Draft SOI BB '.$rsql['vnama'];
                        $content="
                            Diberitahukan bahwa telah ada Approval Draft SOI BB dengan rincian sebagai berikut :<br><br>  
                                <table border='0' style='width: 600px;'>
                                    <tr>
                                            <td style='width: 110px;'><b>Penguji</b></td><td style='width: 20px;'> : </td>
                                            <td>".$rsql['cNip'].' || '.$rsql['vName']."</td>
                                    </tr>
                                    <tr>
                                            <td><b>No Request Sample  </b></td><td> : </td>
                                            <td>".$rsql['vRequest_no']."</td>
                                    </tr> 
                                    <tr>
                                            <td><b>Nama Bahan baku  </b></td><td> : </td>
                                            <td>".$rsql['vnama']."</td>
                                    </tr> 
                                    <tr>
                                            <td><b>Tanggal Pengujian  </b></td><td> : </td>
                                            <td>".$rsql['dMulai_draft']." s/d".$rsql['dSelesai_draft']."</td>
                                    </tr> 
                                </table> 

                            <br/> <br/>
                            Demikian, mohon segera follow up  pada aplikasi ERP Reformulasi. Terimakasih.<br><br><br>
                            Post Master"; 

                        $this->sess_auth->send_message_erp($this->uri->segment_array(),$to, $cc, $subject, $content);
                    }



                }


                $data['status']  = true;
                $data['last_id'] = $post['iexport_draft_soi_bb'];
                return json_encode($data);
            }


            /*
                //Ini Merupakan Standart Approve yang digunakan di erp
 
                function approve_view() {
                    $echo = '<script type="text/javascript">
                                 function submit_ajax(form_id) {
                                    return $.ajax({
                                        url: $("#"+form_id).attr("action"),
                                        type: $("#"+form_id).attr("method"),
                                        data: $("#"+form_id).serialize(),
                                        success: function(data) {
                                            var o = $.parseJSON(data);
                                            var last_id = o.last_id;
                                            var url = "'.base_url().'processor/home/export_draft_soi_bb";                             
                                            if(o.status == true) { 
                                                $("#alert_dialog_form").dialog("close");
                                                     $.get(url+"?action=update&id="+last_id, function(data) {
                                                     $("div#form_export_draft_soi_bb").html(data);
                                                     
                                                });
                                                
                                            }
                                                reload_grid("grid_export_draft_soi_bb");
                                        }
                                        
                                     })
                                 }
                             </script>';
                    $echo .= '<h1>Approve</h1><br />';
                    $echo .= '<form id="form_export_draft_soi_bb_approve" action="'.base_url().'processor/home/export_draft_soi_bb?action=approve_process" method="post">';
                    $echo .= '<div style="vertical-align: top;">';
                    $echo .= 'Remark : 
                            <input type="hidden" name="iexport_draft_soi_bb" value="'.$this->input->get('iexport_draft_soi_bb').'" />
                            <input type="hidden" name="lvl" value="'.$this->input->get('lvl').'" />
                            <input type="hidden" name="group_id" value="'.$this->input->get('group_id').'" />
                            <input type="hidden" name="modul_id" value="'.$this->input->get('modul_id').'" />
                            <textarea name="vRemark"></textarea>
                    <button type="button" onclick="submit_ajax(\'form_export_draft_soi_bb_approve\')">Approve</button>';
                        
                    $echo .= '</div>';
                    $echo .= '</form>';
                    return $echo;
                } 
 
                function approve_process() {
                    $post = $this->input->post();
                    $cNip= $this->user->gNIP;
                    $vName= $this->user->gName;
                    $iexport_draft_soi_bb = $post['iexport_draft_soi_bb'];
                    $vRemark = $post['vRemark'];
                    $lvl = $post['lvl'];
 
                    //Letakan Query Update approve disini

                    $data['status']  = true;
                    $data['last_id'] = $post['iexport_draft_soi_bb'];
                    return json_encode($data);
                }
            */

        
            /*
                //Ini Merupakan Standart Reject yang digunakan di erp

                function reject_view() {
                    $echo = '<script type="text/javascript">
                                 function submit_ajax(form_id) {
                                    var remark = $("#export_draft_soi_bb_remark").val();
                                    if (remark=="") {
                                        alert("Remark tidak boleh kosong ");
                                        return
                                    }

                                    return $.ajax({
                                        url: $("#"+form_id).attr("action"),
                                        type: $("#"+form_id).attr("method"),
                                        data: $("#"+form_id).serialize(),
                                        success: function(data) {
                                            var o = $.parseJSON(data);
                                            var last_id = o.last_id;
                                            var url = "'.base_url().'processor/home/export_draft_soi_bb";                             
                                            if(o.status == true) { 
                                                $("#alert_dialog_form").dialog("close");
                                                     $.get(url+"?action=update&id="+last_id, function(data) {
                                                     $("div#form_export_draft_soi_bb").html(data);
                                                     
                                                });
                                                
                                            }
                                                reload_grid("grid_export_draft_soi_bb");
                                        }
                                        
                                     })
                                 }
                             </script>';
                    $echo .= '<h1>Reject</h1><br />';
                    $echo .= '<form id="form_export_draft_soi_bb_reject" action="'.base_url().'processor/home/export_draft_soi_bb?action=reject_process" method="post">';
                    $echo .= '<div style="vertical-align: top;">';
                    $echo .= 'Remark : 
                            <input type="hidden" name="iexport_draft_soi_bb" value="'.$this->input->get('iexport_draft_soi_bb').'" />
                            <input type="hidden" name="lvl" value="'.$this->input->get('lvl').'" />
                            <input type="hidden" name="group_id" value="'.$this->input->get('group_id').'" />
                            <input type="hidden" name="modul_id" value="'.$this->input->get('modul_id').'" />
                            <textarea name="vRemark" id="reject_export_draft_soi_bb_remark"></textarea>
                    <button type="button" onclick="submit_ajax(\'form_export_draft_soi_bb_reject\')">Reject</button>';
                        
                    $echo .= '</div>';
                    $echo .= '</form>';
                    return $echo;
                }


                
                function reject_process() {
                    $post = $this->input->post();
                    $cNip= $this->user->gNIP;
                    $vName= $this->user->gName;
                    $iexport_draft_soi_bb = $post['iexport_draft_soi_bb'];
                    $vRemark = $post['vRemark'];
                    $lvl = $post['lvl'];
 
                    //Letakan Query Update approve disini

                    $data['status']  = true;
                    $data['last_id'] = $post['iexport_draft_soi_bb'];
                    return json_encode($data);
                }
            */

        
            //Standart Setiap table harus memiliki dCreate , cCreated, dupdate, cUpdate
            function before_insert_processor($row, $postData) {
                if($postData['isdraft']==true){
                    $postData['iSubmit']=0;
                } 
                else{$postData['iSubmit']=1;} 

                $postData['dCreate'] = date('Y-m-d H:i:s');
                $postData['cCreated']=$this->user->gNIP;
                return $postData;

            }
            function before_update_processor($row, $postData) {
                if($postData['isdraft']==true){
                    $postData['iSubmit']=0;
                } 
                else{$postData['iSubmit']=1;} 

                $postData['dupdate'] = date('Y-m-d H:i:s');
                $postData['cUpdate'] = $this->user->gNIP;
                return $postData; 
            }    
        
            function after_insert_processor($fields, $id, $postData) {
                
                /*$qsql = 'select * from reformulasi.export_draft_soi_bb where a.iexport_draft_soi_bb="'.$id.'"';*/
                $qsql="
                        SELECT export_req_refor.iTeamPD,export_req_refor.iTeamAndev
                        ,a.*,b.*,export_request_sample.vRequest_no,plc2_raw_material.vnama
                        FROM (`reformulasi`.`export_request_sample_detail`)
                        INNER JOIN `reformulasi`.`export_request_sample` ON `export_request_sample`.`iexport_request_sample` = `export_request_sample_detail`.`iexport_request_sample`
                        INNER JOIN `reformulasi`.`export_ro_detail` ON `export_ro_detail`.`iexport_request_sample_detail` = `export_request_sample_detail`.`iexport_request_sample_detail`
                        INNER JOIN `reformulasi`.`export_ro` ON `export_ro`.`iexport_ro` = `export_ro_detail`.`iexport_ro`
                        INNER JOIN `plc2`.`plc2_raw_material` ON `plc2_raw_material`.`raw_id` = `export_request_sample_detail`.`raw_id`
                        INNER JOIN `reformulasi`.`export_req_refor` ON `export_req_refor`.`iexport_req_refor` = `export_request_sample`.`iexport_req_refor`
                        INNER JOIN `dossier`.`dossier_upd` ON `dossier_upd`.`idossier_upd_id` = `export_req_refor`.`idossier_upd_id`
                        join reformulasi.export_draft_soi_bb a on a.iexport_ro_detail=export_ro_detail.iexport_ro_detail
                        join hrd.employee b on b.cNip=a.cPic_penyusun
                        WHERE 
                        a.lDeleted=0
                        and  a.iexport_draft_soi_bb = '".$id."'
                ";

                $rsql = $this->db->query($qsql)->row_array();

                if ($rsql['iSubmit']) {
                    // kirim notifikasi message ERp
                    $sqlEmpAr = 'select * from reformulasi.mailsparam a where a.cVariable="export_draft_soi_submit "';
                    $dEmpAr =  $this->db->query($sqlEmpAr)->row_array();

                       

                    $to = $dEmpAr['vTo'];
                    $cc = $dEmpAr['vCc'];

                    

                    $pd = $rsql['iTeamPD'];
                    $andev = $rsql['iTeamAndev'];
                    $qa = '10';


                    $jointeam = $pd.','.$andev.','.$qa;
                    $toEmail = $this->lib_utilitas->get_nip_team( $jointeam );
                    $to = $to.','.$toEmail;
                    $cc = $cc.','.$this->user->gNIP;                        

                    $subject = 'Reformulasi - New Draft SOI BB '.$rsql['vnama'];
                    $content="
                        Diberitahukan bahwa telah ada Submitted Draft SOI BB dengan rincian sebagai berikut :<br><br>  
                            <table border='0' style='width: 600px;'>
                                <tr>
                                        <td style='width: 110px;'><b>Penguji</b></td><td style='width: 20px;'> : </td>
                                        <td>".$rsql['cNip'].' || '.$rsql['vName']."</td>
                                </tr>
                                <tr>
                                        <td><b>No Request Sample  </b></td><td> : </td>
                                        <td>".$rsql['vRequest_no']."</td>
                                </tr> 
                                <tr>
                                        <td><b>Nama Bahan baku  </b></td><td> : </td>
                                        <td>".$rsql['vnama']."</td>
                                </tr> 
                                <tr>
                                        <td><b>Tanggal Pengujian  </b></td><td> : </td>
                                        <td>".$rsql['dMulai_draft']." s/d".$rsql['dSelesai_draft']."</td>
                                </tr> 
                            </table> 

                        <br/> <br/>
                        Demikian, mohon segera follow up  pada aplikasi ERP Reformulasi. Terimakasih.<br><br><br>
                        Post Master"; 

                    $this->sess_auth->send_message_erp($this->uri->segment_array(),$to, $cc, $subject, $content);
                }


            }
    
            function after_update_processor($fields, $id, $postData) {
                /*$qsql = 'select * from reformulasi.export_draft_soi_bb where a.iexport_draft_soi_bb="'.$id.'"';*/
                $qsql="
                        SELECT export_req_refor.iTeamPD,export_req_refor.iTeamAndev
                        ,a.*,b.*,export_request_sample.vRequest_no,plc2_raw_material.vnama
                        FROM (`reformulasi`.`export_request_sample_detail`)
                        INNER JOIN `reformulasi`.`export_request_sample` ON `export_request_sample`.`iexport_request_sample` = `export_request_sample_detail`.`iexport_request_sample`
                        INNER JOIN `reformulasi`.`export_ro_detail` ON `export_ro_detail`.`iexport_request_sample_detail` = `export_request_sample_detail`.`iexport_request_sample_detail`
                        INNER JOIN `reformulasi`.`export_ro` ON `export_ro`.`iexport_ro` = `export_ro_detail`.`iexport_ro`
                        INNER JOIN `plc2`.`plc2_raw_material` ON `plc2_raw_material`.`raw_id` = `export_request_sample_detail`.`raw_id`
                        INNER JOIN `reformulasi`.`export_req_refor` ON `export_req_refor`.`iexport_req_refor` = `export_request_sample`.`iexport_req_refor`
                        INNER JOIN `dossier`.`dossier_upd` ON `dossier_upd`.`idossier_upd_id` = `export_req_refor`.`idossier_upd_id`
                        join reformulasi.export_draft_soi_bb a on a.iexport_ro_detail=export_ro_detail.iexport_ro_detail
                        join hrd.employee b on b.cNip=a.cPic_penyusun
                        WHERE 
                        a.lDeleted=0
                        and  a.iexport_draft_soi_bb = '".$id."'
                ";

                $rsql = $this->db->query($qsql)->row_array();

                if ($rsql['iSubmit']) {
                    // kirim notifikasi message ERp
                    $sqlEmpAr = 'select * from reformulasi.mailsparam a where a.cVariable="export_draft_soi_submit "';
                    $dEmpAr =  $this->db->query($sqlEmpAr)->row_array();

                       

                    $to = $dEmpAr['vTo'];
                    $cc = $dEmpAr['vCc'];

                    

                    $pd = $rsql['iTeamPD'];
                    $andev = $rsql['iTeamAndev'];
                    $qa = '10';


                    $jointeam = $pd.','.$andev.','.$qa;
                    $toEmail = $this->lib_utilitas->get_nip_team( $jointeam );
                    $to = $to.','.$toEmail;
                    $cc = $cc.','.$this->user->gNIP;                        

                    $subject = 'Reformulasi - New Draft SOI BB '.$rsql['vnama'];
                    $content="
                        Diberitahukan bahwa telah ada Submitted Draft SOI BB dengan rincian sebagai berikut :<br><br>  
                            <table border='0' style='width: 600px;'>
                                <tr>
                                        <td style='width: 110px;'><b>Penguji</b></td><td style='width: 20px;'> : </td>
                                        <td>".$rsql['cNip'].' || '.$rsql['vName']."</td>
                                </tr>
                                <tr>
                                        <td><b>No Request Sample  </b></td><td> : </td>
                                        <td>".$rsql['vRequest_no']."</td>
                                </tr> 
                                <tr>
                                        <td><b>Nama Bahan baku  </b></td><td> : </td>
                                        <td>".$rsql['vnama']."</td>
                                </tr> 
                                <tr>
                                        <td><b>Tanggal Pengujian  </b></td><td> : </td>
                                        <td>".$rsql['dMulai_draft']." s/d".$rsql['dSelesai_draft']."</td>
                                </tr> 
                            </table> 

                        <br/> <br/>
                        Demikian, mohon segera follow up  pada aplikasi ERP Reformulasi. Terimakasih.<br><br><br>
                        Post Master"; 

                    $this->sess_auth->send_message_erp($this->uri->segment_array(),$to, $cc, $subject, $content);
                }

            }
            function manipulate_insert_button($buttons) {
                unset($buttons['save']);

                $save_draft = '<button onclick="javascript:save_draft_btn_multiupload(\'export_draft_soi_bb\', \''.base_url().'processor/reformulasi/export/draft/soi/bb?draft=true\', this, true)" class="ui-button-text icon-save" id="button_save_draft_export_draft_soi_bb">Save as Draft</button>';
                $save = '<button onclick="javascript:save_btn_multiupload(\'export_draft_soi_bb\', \''.base_url().'processor/reformulasi/export/draft/soi/bb?company_id='.$this->input->get('company_id').'&group_id='.$this->input->get('group_id').'&modul_id='.$this->input->get('modul_id').'\', this)" class="ui-button-text icon-save" id="button_save_export_draft_soi_bb">Save &amp; Submit</button>';
                $js = $this->load->view('export/sample/js/export_draft_soi_bb_js');
                $js .= $this->load->view('export/sample/js/upload_js');
                $buttons['save'] = $save_draft.$save.$js;

                return $buttons;
            }

            function manipulate_update_buttonx($buttons, $rowData) { 
                //Load Javascript In Here 
                if ($this->input->get('action') == 'view') {
                    unset($buttons['update']);
                }
                else{ 
                    
                }
                
                return $buttons;
            }

            function manipulate_update_button($buttons, $rowData) {
                $mydept = $this->auth_export->my_depts(TRUE);
                $cNip= $this->user->gNIP;
                $js = $this->load->view('export/sample/js/export_draft_soi_bb_js');
                $js .= $this->load->view('export/sample/js/upload_js');
                
                $approve = '<button onclick="javascript:load_popup(\''.base_url().'processor/reformulasi/export/draft/soi/bb?action=approve&iexport_draft_soi_bb='.$rowData['iexport_draft_soi_bb'].'&cNip='.$cNip.'&lvl=2&status=1&group_id='.$this->input->get('group_id').'&modul_id='.$this->input->get('modul_id').'\')" class="ui-button-text icon-save" id="button_approve_export_draft_soi_bb">Confirm</button>';
                $update = '<button onclick="javascript:update_btn_back(\'export_draft_soi_bb\', \''.base_url().'processor/reformulasi/export/draft/soi/bb?company_id='.$this->input->get('company_id').'&group_id='.$this->input->get('group_id').'&modul_id='.$this->input->get('modul_id').'\', this)" class="ui-button-text icon-save" id="button_save_export_draft_soi_bb">Update & Submit</button>';
                $updatedraft = '<button onclick="javascript:update_draft_btn(\'export_draft_soi_bb\', \''.base_url().'processor/reformulasi/export/draft/soi/bb?company_id='.$this->input->get('company_id').'&draft=true&group_id='.$this->input->get('group_id').'&modul_id='.$this->input->get('modul_id').'\', this, true)" class="ui-button-text icon-save" id="button_save_export_draft_soi_bb">Update as Draft</button>';



                if ($this->input->get('action') == 'view') {unset($buttons['update']);}

                else{
                    
                    unset($buttons['update_back']);
                    unset($buttons['update']);
                    
                    if ($rowData['iSubmit']== 0) {
                        // jika masih draft , show button update draft & update submit 
                        if (isset($mydept)) {
                            // cek punya dep
                            if((in_array('AD', $mydept))) {
                                $buttons['update'] = $update.$updatedraft.$js;
                            }
                        }

                    }else{
                        // sudah disubmit , show button approval 
                        if ($rowData['iApprove'] == 0) {
                             // jika approval bdirm 0 
                            if (isset($mydept)) {
                                if((in_array('AD', $mydept))) {
                                    if($this->auth_export->is_manager()){
                                        $buttons['update'] = $approve.$js;  
                                    }else{
                                        $sqlcekapp='select * 
                                                    from reformulasi.reformulasi_team_item i 
                                                    join reformulasi.reformulasi_team t on t.ireformulasi_team=i.ireformulasi_team
                                                    where i.vnip="'.$cNip.'" 
                                                    and i.ldeleted=0 
                                                    and cDeptId=5
                                                    and iapprove=1';
                                        //echo '<pre>'.$sqlcekapp;
                                        $qce=$this->db->query($sqlcekapp);
                                        if($qce->num_rows()>=1){
                                            $dce=$qce->row_array();
                                            if($dce['iapprove']==1){
                                                $buttons['update'] = $approve.$js;
                                            }
                                        }
                                    }
                                }
                            }


                        }   
                        
                    }
                }

                return $buttons;

            }

            //Output
            public function output(){
                $this->index($this->input->get('action'));
            }
        }