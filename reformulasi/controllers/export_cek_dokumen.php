
 
        <?php
        /* Generated by Sovdev 2 ERP CRUD Generator 2018-02-15 08:49:12 */
        /* Location: ./modules/reformulasi/controllers/export_cek_dokumen.php */
        /* Please DO NOT modify this information : */ 
         
        if ( ! defined('BASEPATH')) exit('No direct script access allowed');
        class export_cek_dokumen extends MX_Controller {
            function __construct() {
                parent::__construct();
                $this->load->library('auth');
                $this->load->library('auth_export');
                $this->db = $this->load->database('formulasi', false, true);
                $this->user = $this->auth->user();
            }
            function index($action = '') {
                $action = $this->input->get('action');
                //Bikin Object Baru Nama nya $grid      
                $grid = new Grid;
                $grid->setTitle('Cek Dokumen Reformulasi Export');
                $grid->setTable('reformulasi.export_req_refor');      
                $grid->setUrl('export_cek_dokumen');

                //List Table
                $grid->addList('vno_export_req_refor','dossier_upd.vUpd_no','itemas.c_iteno','dossier_upd.vNama_usulan','employee.vName'); 
                $grid->setSortBy('iexport_req_refor');
                $grid->setSortOrder('desc');  

                //List field
                $grid->addFields('iexport_req_refor','dok_list'); 
                 
                //Setting Grid Width Name 
                /*
                    Kamu bisa merubah nama label dari sini, Contoh :
                    $grid->setLabel('nama field','nama field yang akan diubah');

                */
                $grid->setWidth('itemas.c_iteno', '80');
                $grid->setAlign('itemas.c_iteno', 'left');
                $grid->setLabel('itemas.c_iteno','Kode Product');

                $grid->setWidth('iUjibe', '80');
                $grid->setAlign('iUjibe', 'left');
                $grid->setLabel('iUjibe','Perlu Uji BE ?');

                $grid->setWidth('insBB', '80');
                $grid->setAlign('insBB', 'left');
                $grid->setLabel('insBB','Permintaan Bahan Baku'); 

                $grid->setWidth('dossier_upd.vNama_usulan', '250');
                $grid->setAlign('dossier_upd.vNama_usulan', 'left');
                $grid->setLabel('dossier_upd.vNama_usulan','Nama Usulan Product'); 

                $grid->setWidth('iexport_req_refor', '100');
                $grid->setAlign('iexport_req_refor', 'left');
                $grid->setLabel('iexport_req_refor','Detail Request');

                $grid->setWidth('vno_export_req_refor', '100');
                $grid->setAlign('vno_export_req_refor', 'left');
                $grid->setLabel('vno_export_req_refor','No Request');

                
            
                $grid->setWidth('idossier_upd_id', '100');
                $grid->setAlign('idossier_upd_id', 'left');
                $grid->setLabel('idossier_upd_id','Nomor UPD');

                $grid->setWidth('dossier_upd.vUpd_no', '80');
                $grid->setAlign('dossier_upd.vUpd_no', 'left');
                $grid->setLabel('dossier_upd.vUpd_no','Nomor UPD');
 
                $grid->setWidth('cInisiator_export', '100');
                $grid->setAlign('cInisiator_export', 'left');
                $grid->setLabel('cInisiator_export','Nama Inisiator');

                $grid->setWidth('employee.vName', '250');
                $grid->setAlign('employee.vName', 'left');
                $grid->setLabel('employee.vName','Nama Inisiator');

                
            
                $grid->setWidth('iDapartemen_export', '100');
                $grid->setAlign('iDapartemen_export', 'left');
                $grid->setLabel('iDapartemen_export','Dapartemen');
            
                $grid->setWidth('tAlasan_export', '100');
                $grid->setAlign('tAlasan_export', 'left');
                $grid->setLabel('tAlasan_export','Alasan Reformulasi');
            
                $grid->setWidth('dPermintaan_req_export', '100');
                $grid->setAlign('dPermintaan_req_export', 'left');
                $grid->setLabel('dPermintaan_req_export','Tanggal Permintaan Req Reformulasi');
            
                $grid->setWidth('dPermintaan_bb_export', '100');
                $grid->setAlign('dPermintaan_bb_export', 'left');
                $grid->setLabel('dPermintaan_bb_export','Tanggal Permintaaan Bahan Baku');

                $grid->setWidth('vUploadfile', '100');
                $grid->setAlign('vUploadfile', 'left');
                $grid->setLabel('vUploadfile','Upload File');
                 
                $grid->setWidth('iTeamPD', '100');
                $grid->setAlign('iTeamPD', 'left');
                $grid->setLabel('iTeamPD','Team PD');
            
                $grid->setWidth('iTeamAndev', '100');
                $grid->setAlign('iTeamAndev', 'left');
                $grid->setLabel('iTeamAndev','Team Andev');
            
                $grid->setWidth('iSubmit', '100');
                $grid->setAlign('iSubmit', 'left');
                $grid->setLabel('iSubmit','Status Submit');
            
                $grid->setWidth('cApproval_ats_inisiator', '100');
                $grid->setAlign('cApproval_ats_inisiator', 'left');
                $grid->setLabel('cApproval_ats_inisiator','CAPPROVAL_ATS_INISIATOR');
            
                $grid->setWidth('vRemark_ats_inisiator', '100');
                $grid->setAlign('vRemark_ats_inisiator', 'left');
                $grid->setLabel('vRemark_ats_inisiator','VREMARK_ATS_INISIATOR');
            
                $grid->setWidth('dApproval_ats_inisiator', '100');
                $grid->setAlign('dApproval_ats_inisiator', 'left');
                $grid->setLabel('dApproval_ats_inisiator','DAPPROVAL_ATS_INISIATOR');
            
                $grid->setWidth('iApproval_ats_inisiator', '150');
                $grid->setAlign('iApproval_ats_inisiator', 'left');
                $grid->setLabel('iApproval_ats_inisiator','Approval Atasan Inisiator');
            
                $grid->setWidth('dCreate', '100');
                $grid->setAlign('dCreate', 'left');
                $grid->setLabel('dCreate','DCREATE');
            
                $grid->setWidth('cCreated', '100');
                $grid->setAlign('cCreated', 'left');
                $grid->setLabel('cCreated','CCREATED');
            
                $grid->setWidth('dupdate', '100');
                $grid->setAlign('dupdate', 'left');
                $grid->setLabel('dupdate','DUPDATE');
            
                $grid->setWidth('cUpdate', '100');
                $grid->setAlign('cUpdate', 'left');
                $grid->setLabel('cUpdate','CUPDATE');
            
                $grid->setWidth('lDeleted', '100');
                $grid->setAlign('lDeleted', 'left');
                $grid->setLabel('lDeleted','LDELETED');
            
                //Example modifikasi GRID ERP
                /*
                    - Set Query
                        $grid->setQuery('lDeleted = 0 ', null); 
                        $grid->setQuery('plc2_upb.iupb_id IN (select distinct(bk.iupb_id) from plc2.plc2_upb_spesifikasi_fg bk where bk.iappqa=2 and bk.ldeleted=0)', null);  

                    - Join Table
                        $grid->setJoinTable('hrd.employee', 'employee.cNip = pk_master.vnip', 'inner');

                    - Change Field Name
                        $grid->changeFieldType('ideleted','combobox','',array(''=>'Pilih',0=>'Aktif',1=>'Tidak aktif'));
                */
                $grid->changeFieldType('iSubmit','combobox','',array(0=>'Draft',1=>'Submitted'));
                $grid->setQuery('export_req_refor.lDeleted = 0 ', null); 

                $grid->setJoinTable('dossier.dossier_upd', 'dossier_upd.idossier_upd_id = export_req_refor.idossier_upd_id', 'inner');
                $grid->setJoinTable('sales.itemas', 'itemas.c_iteno = dossier_upd.iupb_id', 'inner');
                $grid->setJoinTable('hrd.employee', 'employee.cNip = export_req_refor.cInisiator_export', 'inner');
                 //set search
                $grid->setSearch('vno_export_req_refor','dossier_upd.vUpd_no','employee.vName');

                $grid->changeFieldType('iSubmit','combobox','',array(0=>'Draft',1=>'Submitted'));
                //set required
                //$grid->setRequired('vno_export_cek_dokumen','idossier_upd_id','cInisiator_export','iDapartemen_export','tAlasan_export','dPermintaan_req_export','dPermintaan_bb_export','iTeamPD','iTeamAndev'); 

                $grid->setGridView('grid');

                switch ($action) {
                    case 'json':
                            $grid->getJsonData();
                            break;
                    case 'view':
                            $grid->render_form($this->input->get('id'), true);
                            break;
                    case 'create':
                            $grid->render_form();
                            break;
                    case 'download':
                            $this->download($this->input->get('file'));
                            break;
                    case 'getInisiator':
                            echo $this->getInisiator();
                            break;
                  
                    case 'update':
                            $grid->render_form($this->input->get('id'));
                            break;
                   
                    case 'delete':
                            echo $grid->delete_row();
                            break; 
                    
                        //Ini Merupakan Standart Case Untuk Approve

                        case 'approve':
                            echo $this->approve_view();
                            break;
                        case 'approve_process':
                            echo $this->approve_process();
                            break;
                        case 'reject':
                            echo $this->reject_view();
                            break;
                        case 'reject_process':
                            echo $this->reject_process();
                            break; 
                     
                    default:
                            $grid->render_grid();
                            break;
                }
            }
            //Create Manipulate Field 

            //Jika Ingin Menambahkan Seting grid seperti button edit enable dalam kondisi tertentu
            
            function listBox_Action($row, $actions) {
                $cNip= $this->user->gNIP;
                if ($row->iSubmit==1) {
                    if($row->iApproval_ats_inisiator==0 or empty($row->iApproval_ats_inisiator)){
                        if($this->upperInisiator($row->cInisiator_export,$cNip)==0){
                             unset($actions['edit']);
                        }
                    } else{
                        unset($actions['edit']);
                    }
                        
                }
                return $actions;
            } 
            
            function getInisiator() {
                $term = $this->input->get('term');
                $sql = 'SELECT DISTINCT(pt.`vnip`), e.`vName`, m.`iDeptID`, m.`vDescription` FROM reformulasi.`reformulasi_team` p
                            JOIN reformulasi.`reformulasi_team_item` pt ON pt.`ireformulasi_team` = p.`ireformulasi_team`
                            JOIN hrd.`employee` e ON e.`cNip` = pt.`vnip`
                            JOIN hrd.`msdepartement` m ON m.`iDeptID` = e.iDepartementID
                            WHERE p.`ldeleted` = 0 AND pt.`ldeleted` = 0 AND p.`iTipe` = 2 AND pt.`vnip` IS NOT NULL
                            AND (e.`dresign` = "0000-00-00" OR  e.`dresign` > SYSDATE())
                            AND (e.`cNip` like "%'.$term.'%" OR e.`vName`like "%'.$term.'%")';  
                $dt=$this->db->query($sql);
                $data = array();
                if($dt->num_rows>0){
                    foreach($dt->result_array() as $line) { 
                        $row_array['value'] = trim($line['vnip']).' - '.trim($line['vName']);
                        $row_array['dep_id'] = trim($line['iDeptID']);
                        $row_array['dep_v'] = trim($line['vDescription']);
                        $row_array['id']    = trim($line['vnip']); 
                        array_push($data, $row_array);
                    }
                }
                echo json_encode($data);
                exit;
            }
            
            function listBox_export_cek_dokumen_iApproval_ats_inisiator($value) {
                if($value==0){$vstatus='Waiting for approval';}
                elseif($value==1){$vstatus='Rejected';}
                elseif($value==2){$vstatus='Approved';}
                return $vstatus;
            }

             
            function updateBox_export_cek_dokumen_iexport_req_refor($field, $id, $value, $rowData) {
                $sql = "SELECT * FROM reformulasi.`export_req_refor` lr 
                        join dossier.dossier_upd b on b.idossier_upd_id=lr.idossier_upd_id
                        WHERE lr.`lDeleted` = 0 AND lr.`iexport_req_refor` = '".$value."'";
                $dt = $this->db->query($sql)->row_array();

                //print_r($dt);
                
                $_vno_export_req_refor='';
                $vUpd_no = ''; 
                $vNama_usulan = '';
                $_iteam_pd = '';
                $_iteam_ad = '';
                
                
                if(!empty($dt['iexport_req_refor'])){
                        


                        $_vno_export_req_refor = $dt['vno_export_req_refor'];
                        $vUpd_no = $dt['vUpd_no'];
                        $vNama_usulan = $dt['vNama_usulan'];



                        $pd = "SELECT r.vteam FROM reformulasi.`reformulasi_team` r WHERE r.lDeleted=0 
                            AND r.ireformulasi_team= '".$dt['iTeamPD']."'";
                        $c_pd = $this->db->Query($pd)->row_array();
                        if(empty($c_pd['vteam'])){
                            $c_pd['vteam'] = '-';
                        }


                        

                        $pd = "SELECT r.vteam FROM reformulasi.`reformulasi_team` r WHERE r.lDeleted=0 AND r.ireformulasi_team= '".$dt['iTeamPD']."'";
                        $c_pd = $this->db->Query($pd)->row_array();
                        if(empty($c_pd['vteam'])){
                            $c_pd['vteam'] = '-';
                        }
                        $_iteam_pd=$c_pd['vteam'];

                        $ad = "SELECT r.vteam FROM reformulasi.`reformulasi_team` r WHERE r.lDeleted=0 AND r.ireformulasi_team= '".$dt['iTeamAndev']."'";
                        $c_ad = $this->db->Query($ad)->row_array();
                        if(empty($c_ad['vteam'])){
                            $c_ad['vteam'] = '-';
                        }

                        $_iteam_ad=$c_ad['vteam'];


                        
                }

                $uri = 'export_cek_dokumen';
                $o = "";  
                $o   .= "<div style='
                                padding: 3px;
                                width: 500px;
                                border: 1px solid rgba(51, 23, 93, 0.2);
                                background-color: #FFF;'>";
                
                
                $o   .= "<table border='0' style='width: 100%;'>
                            <tbody>";  
                $o  .="         <tr>
                                    <td width='20%'>No Request Refor</td>
                                    <td>:</td>
                                    <td width='75%'>";
                $o .= '         <input type="hidden" name="'.$field.'"  id="'.$id.'"  class="'.$id.' input_rows1 required" size="30" value="'.$value.'"/>';
                $o .= $_vno_export_req_refor;
                
                $o  .="             </td>
                                </tr>

                                <tr>
                                    <td width='20%'>No UPD</td>
                                    <td>:</td>
                                    <td width='75%'> 
                                        <span class='".$uri."_vUpd_no' id='".$uri."_vUpd_no'>".$vUpd_no."</span>
                                    </td>
                                </tr>

                                <tr>
                                    <td width='20%'>Nama Usulan</td>
                                    <td>:</td>
                                    <td width='75%'> 
                                        <span class='".$uri."_vNama_usulan' id='".$uri."_vNama_usulan'>".$vNama_usulan."</span>
                                    </td>
                                </tr>
                                 

                                <tr>
                                    <td width='20%'>Team PD</td>
                                    <td>:</td>
                                    <td width='75%'> 
                                        <span class='".$uri."_iTeamPD' id='".$uri."_iTeamPD'>".$_iteam_pd."</span>
                                    </td>
                                </tr>

                                <tr>
                                    <td width='20%'>Team Andev</td>
                                    <td>:</td>
                                    <td width='75%'> 
                                        <span class='".$uri."_iTeamAndev' id='".$uri."_iTeamAndev'>".$_iteam_ad."</span>
                                    </td>
                                </tr>
                            </tbody>    
                        </table>"; 
                $o .= "    </div>";  

                $o .= '<script>
                        //$(".bt_brow").hide();
                        $( "button.icon_pop" ).button({
                            icons: {
                                primary: "ui-icon-newwin"
                            }, 
                        })
                    </script>';

                     
                return $o;
            }  

            function updateBox_export_cek_dokumen_dok_list($field, $id, $value, $rowData) {
                $data['rowData'] = $rowData;
                $data['browse_url'] = base_url().'processor/reformulasi/cek/dokumen';
                return $this->load->view('export/cek_dokumen/list', $data, TRUE);

            }
            
            function upperInisiator($cNip,$cUpper){
                $sql = "SELECT e.`cUpper` FROM hrd.`employee` e WHERE e.`cNip` = '".$cNip."' LIMIT 1";
                $dt = $this->db->query($sql)->row_array();
                if(!empty($dt['cUpper'])){
                    if($dt['cUpper']==$cUpper){
                        return 1;
                    }else{
                        return 0;
                    }
                }else{
                    return 0;
                }
            }
            function download($vFilename) {
                $this->load->helper('download');        
                $name = $vFilename;
                $id = $_GET['id']; 
                $tempat = $_GET['path']; 
                $path = file_get_contents('./files/reformulasi/export/'.$tempat.'/'.$id.'/'.$name);    
                force_download($name, $path);
            }

            function manipulate_update_button($buttons, $rowData){
                unset($buttons['update']);
                return $buttons;
            }
            //Output
            public function output(){
                $this->index($this->input->get('action'));
            }
        }