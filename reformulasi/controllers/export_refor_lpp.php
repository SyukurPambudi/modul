 
        <?php
        /* Generated by Sovdev 2 ERP CRUD Generator 2018-04-18 10:14:03 */
        /* Location: ./modules/reformulasi/controllers/export_refor_lpp.php */
        /* Please DO NOT modify this information : */ 
         
        if ( ! defined('BASEPATH')) exit('No direct script access allowed');
        class export_refor_lpp extends MX_Controller {
            function __construct() {
                parent::__construct();
                $this->load->library('auth');
                $this->db = $this->load->database('formulasi', false, true);
                $this->user = $this->auth->user();
            }
            function index($action = '') {
                $grid = new Grid;
                $grid->setTitle('Laporan Pengembangan Product');
                $grid->setTable('reformulasi.export_refor_lpp');      
                $grid->setUrl('export_refor_lpp');

                //List Table
                $grid->addList('export_req_refor.vno_export_req_refor','itemas.c_itnam','dmulai_lpp','dselesai_lpp','employee.vName','isubmit','iaprove'); 
                $grid->setSortBy('iexport_refor_lpp');
                $grid->setSortOrder('asc');  

                //List field
                $grid->addFields('iexport_req_refor','dmulai_lpp','dselesai_lpp','cpicpd_lpp','iuploadFile','iaprove'); 

                //Setting Grid Width Name 
                /*
                    Kamu bisa merubah nama label dari sini, Contoh :
                    $grid->setLabel('nama field','nama field yang akan diubah');

                */
                
                $grid->setWidth('itemas.c_itnam', '150');
                $grid->setAlign('itemas.c_itnam', 'left');
                $grid->setLabel('itemas.c_itnam','Nama Product');

                $grid->setWidth('employee.vName', '150');
                $grid->setAlign('employee.vName', 'left');
                $grid->setLabel('employee.vName','PIC PD'); 

                $grid->setWidth('export_req_refor.vno_export_req_refor', '80');
                $grid->setAlign('export_req_refor.vno_export_req_refor', 'left');
                $grid->setLabel('export_req_refor.vno_export_req_refor','No Req Refor');

                $grid->setWidth('iexport_req_refor', '100');
                $grid->setAlign('iexport_req_refor', 'left');
                $grid->setLabel('iexport_req_refor','Nomor Request');

                $grid->setWidth('iuploadFile', '100');
                $grid->setAlign('iuploadFile', 'left');
                $grid->setLabel('iuploadFile','Upload File'); 
            
                $grid->setWidth('dmulai_lpp', '150');
                $grid->setAlign('dmulai_lpp', 'left');
                $grid->setLabel('dmulai_lpp','Tanggal Mulai Pembuatan LPP');
            
                $grid->setWidth('dselesai_lpp', '150');
                $grid->setAlign('dselesai_lpp', 'left');
                $grid->setLabel('dselesai_lpp','Tanggal Selesai Pembuatan LPP');
            
                $grid->setWidth('cpicpd_lpp', '100');
                $grid->setAlign('cpicpd_lpp', 'left');
                $grid->setLabel('cpicpd_lpp','PIC PD');
            
                $grid->setWidth('dCreate', '100');
                $grid->setAlign('dCreate', 'left');
                $grid->setLabel('dCreate','DCREATE');
            
                $grid->setWidth('cCreated', '100');
                $grid->setAlign('cCreated', 'left');
                $grid->setLabel('cCreated','CCREATED');
            
                $grid->setWidth('dupdate', '100');
                $grid->setAlign('dupdate', 'left');
                $grid->setLabel('dupdate','DUPDATE');
            
                $grid->setWidth('cUpdate', '100');
                $grid->setAlign('cUpdate', 'left');
                $grid->setLabel('cUpdate','CUPDATE');
            
                $grid->setWidth('lDeleted', '100');
                $grid->setAlign('lDeleted', 'left');
                $grid->setLabel('lDeleted','LDELETED');
            
                $grid->setWidth('isubmit', '100');
                $grid->setAlign('isubmit', 'left');
                $grid->setLabel('isubmit','Status Submit');
            
                $grid->setWidth('iaprove', '100');
                $grid->setAlign('iaprove', 'left');
                $grid->setLabel('iaprove','Approve by PD');
            
                $grid->setWidth('caprove', '100');
                $grid->setAlign('caprove', 'left');
                $grid->setLabel('caprove','CAPROVE');
            
                $grid->setWidth('taprove', '100');
                $grid->setAlign('taprove', 'left');
                $grid->setLabel('taprove','TAPROVE');
            
                $grid->setWidth('daprove', '100');
                $grid->setAlign('daprove', 'left');
                $grid->setLabel('daprove','DAPROVE');
            
                //Example modifikasi GRID ERP
                /*
                    - Set Query
                        $grid->setQuery('lDeleted = 0 ', null); 
                        $grid->setQuery('plc2_upb.iupb_id IN (select distinct(bk.iupb_id) from plc2.plc2_upb_spesifikasi_fg bk where bk.iappqa=2 and bk.ldeleted=0)', null);  

                    - Join Table
                        $grid->setJoinTable('hrd.employee', 'employee.cNip = pk_master.vnip', 'inner');

                    - Change Field Name
                        $grid->changeFieldType('ideleted','combobox','',array(''=>'Pilih',0=>'Aktif',1=>'Tidak aktif'));
                */

                $grid->setJoinTable('reformulasi.export_req_refor', 'export_req_refor.iexport_req_refor = export_refor_lpp.iexport_req_refor', 'inner');
                $grid->setJoinTable('dossier.dossier_upd', 'dossier_upd.idossier_upd_id = export_req_refor.idossier_upd_id', 'inner');
                $grid->setJoinTable('sales.itemas', 'itemas.c_iteno = dossier_upd.iupb_id', 'inner');
                $grid->setJoinTable('hrd.employee', 'employee.cNip = export_refor_lpp.cpicpd_lpp', 'inner');
 

                 //set search
                $grid->setSearch('export_req_refor.vno_export_req_refor','itemas.c_itnam');

                $grid->changeFieldType('isubmit','combobox','',array(0=>'Draft',1=>'Submitted'));
                
                //set required
                $grid->setRequired('iexport_req_refor','dmulai_lpp','dselesai_lpp','cpicpd_lpp','isubmit','iaprove'); 

                $grid->setGridView('grid');

                switch ($action) {
                    case 'json':
                            $grid->getJsonData();
                            break;
                    case 'download':
                            $this->download($this->input->get('file'));
                            break;
                    case 'view':
                            $grid->render_form($this->input->get('id'), true);
                            break;
                    case 'create':
                            $grid->render_form();
                            break;
                    case 'createproses':
                            $isUpload = $this->input->get('isUpload'); 
                            if($isUpload) { 
                                $lastId=$this->input->get('lastId');
                                $path = realpath("files/reformulasi/"); 

                                /* Upload Trial */ 
                                if(!file_exists($path."/"."export/export_refor_lpp"."/".$lastId)){
                                    if (!mkdir($path."/"."export/export_refor_lpp"."/".$lastId, 0777, true)) { 
                                        die('Failed upload, try again!');
                                    }
                                } 
                                $fileketerangan = array();
                                foreach($_POST as $key=>$value) {                       
                                    if ($key == 'fileketerangan_export_refor_lpp_file') {
                                        foreach($value as $k=>$v) {
                                            $fileketerangan[$k] = $v;
                                        }
                                    }
                                } 
                                $i=0; 
                                $sql = array();
                                foreach ($_FILES['fileid_export_refor_lpp_file_upload_export_refor_lpp_file']["error"] as $key => $error) {
                                    if ($error == UPLOAD_ERR_OK) {
                                        $tmp_name = $_FILES['fileid_export_refor_lpp_file_upload_export_refor_lpp_file']["tmp_name"][$key];
                                        $name =$_FILES['fileid_export_refor_lpp_file_upload_export_refor_lpp_file']["name"][$key];
                                        $data['filename'] = $name;
                                        $data['dInsertDate'] = date('Y-m-d H:i:s');

                                            if(move_uploaded_file($tmp_name, $path."/"."export/export_refor_lpp"."/".$lastId."/".$name)) {
                                                
                                                $sql[]="INSERT INTO reformulasi.export_refor_lpp_file(iexport_refor_lpp, 
                                                        vFilename, dCreate, cCreated,
                                                        tKeterangan) 
                                                        VALUES (".$lastId.",'".$data['filename']."',
                                                            '".$data['dInsertDate']."','".$this->user->gNIP."',
                                                            '".$fileketerangan[$i]."')";

                                                $i++;   
                                            }
                                            else{
                                                echo "Upload ke folder gagal";  
                                            }
                                    }
                                }
                                foreach($sql as $q) {
                                    try {
                                        $this->db->query($q);
                                    }catch(Exception $e) {
                                    die($e);
                                    }
                                } 
                              
                            }else{ 
                                echo $grid->saved_form();
                            } 
                            break;
                    case 'update':
                            $grid->render_form($this->input->get('id'));
                            break;
                    case 'updateproses':
                            $isUpload = $this->input->get('isUpload'); 
                            $lastId=$_POST['iexport_refor_lpp']; 
                            if($isUpload) {  
                                 $path = realpath("files/reformulasi/"); 

                                    /* Upload Trial */ 
                                    if(!file_exists($path."/"."export/export_refor_lpp"."/".$lastId)){
                                        if (!mkdir($path."/"."export/export_refor_lpp"."/".$lastId, 0777, true)) { 
                                            die('Failed upload, try again!');
                                        }
                                    } 
                                    $fileketerangan = array();
                                    foreach($_POST as $key=>$value) {                       
                                        if ($key == 'fileketerangan_export_refor_lpp_file') {
                                            foreach($value as $k=>$v) {
                                                $fileketerangan[$k] = $v;
                                            }
                                        }
                                    } 
                                    $i=0; 
                                    $sql = array();
                                    foreach ($_FILES['fileid_export_refor_lpp_file_upload_export_refor_lpp_file']["error"] as $key => $error) {
                                        if ($error == UPLOAD_ERR_OK) {
                                            $tmp_name = $_FILES['fileid_export_refor_lpp_file_upload_export_refor_lpp_file']["tmp_name"][$key];
                                            $name =$_FILES['fileid_export_refor_lpp_file_upload_export_refor_lpp_file']["name"][$key];
                                            $data['filename'] = $name;
                                            $data['dInsertDate'] = date('Y-m-d H:i:s');

                                                if(move_uploaded_file($tmp_name, $path."/"."export/export_refor_lpp"."/".$lastId."/".$name)) {
                                                    
                                                    $sql[]="INSERT INTO reformulasi.export_refor_lpp_file(iexport_refor_lpp, 
                                                            vFilename, dCreate, cCreated, 
                                                            tKeterangan) 
                                                            VALUES (".$lastId.",'".$data['filename']."',
                                                                '".$data['dInsertDate']."','".$this->user->gNIP."',
                                                                '".$fileketerangan[$i]."')";

                                                    $i++;   
                                                }
                                                else{
                                                    echo "Upload ke folder gagal";  
                                                }
                                        }
                                    }
                                    foreach($sql as $q) {
                                        try {
                                            $this->db->query($q);
                                        }catch(Exception $e) {
                                        die($e);
                                        }
                                    } 

                            }else{ 
                                $fileid1='';
                                foreach($_POST as $key=>$value) {
                                    if ($key == 'fileid_export_refor_lpp_file') {
                                        $i=0;
                                        foreach($value as $k=>$v) {
                                            if($i==0){
                                                $fileid1 .= "'".$v."'";
                                            }else{
                                                $fileid1 .= ",'".$v."'";
                                            }
                                            $i++;
                                        }
                                    }
                                } 
                                $tgl= date('Y-m-d H:i:s');
                                $sql1="update reformulasi.export_refor_lpp_file set lDeleted=1, 
                                    dupdate='".$tgl."', cUpdate='".$this->user->gNIP."' where 
                                    iexport_refor_lpp='".$lastId."' and 
                                    iexport_refor_lpp_file not in (".$fileid1.")";
                                $this->db->query($sql1); 

                                echo $grid->updated_form();
                            } 
                            break;
                    case 'delete':
                            echo $grid->delete_row();
                            break; 
                    case 'searchcNip':
                            echo $this->searchcNip();
                            break;
                    
                        //Ini Merupakan Standart Case Untuk Approve

                        case 'approve':
                            echo $this->approve_view();
                            break;
                        case 'approve_process':
                            echo $this->approve_process();
                            break;
                    /*
                        case 'reject':
                            echo $this->reject_view();
                            break;
                        case 'reject_process':
                            echo $this->reject_process();
                            break; 
                    */ 
                    default:
                            $grid->render_grid();
                            break;
                }
            }
            //Create Manipulate Field 

            //Jika Ingin Menambahkan Seting grid seperti button edit enable dalam kondisi tertentu
             
            function listBox_Action($row, $actions) {
                if ($row->iaprove==2) { 
                        unset($actions['edit']);
                }
                return $actions;
            } 
            
            
            public function searchcNip() {
                    $term = $this->input->get('term');
                $sql = 'SELECT DISTINCT(pt.`vnip`), e.`vName`, m.`iDeptID`, m.`vDescription` FROM reformulasi.`reformulasi_team` p
                            JOIN reformulasi.`reformulasi_team_item` pt ON pt.`ireformulasi_team` = p.`ireformulasi_team`
                            JOIN hrd.`employee` e ON e.`cNip` = pt.`vnip`
                            JOIN hrd.`msdepartement` m ON m.`iDeptID` = e.iDepartementID
                            WHERE p.`ldeleted` = 0 AND pt.`ldeleted` = 0 AND p.`iTipe` = 2 AND p.vtipe="PD" AND pt.`vnip` IS NOT NULL
                            AND (e.`dresign` = "0000-00-00" OR  e.`dresign` > SYSDATE())
                            AND (e.`cNip` like "%'.$term.'%" OR e.`vName`like "%'.$term.'%")';  
                $dt=$this->db->query($sql);
                $data = array();
                if($dt->num_rows>0){
                    foreach($dt->result_array() as $line) { 
                        $row_array['value'] = trim($line['vnip']).' - '.trim($line['vName']);
                        $row_array['dep_id'] = trim($line['iDeptID']);
                        $row_array['dep_v'] = trim($line['vDescription']);
                        $row_array['id']    = trim($line['vnip']); 
                        array_push($data, $row_array);
                    }
                }
                echo json_encode($data);
                exit;
            }
            function listBox_export_refor_lpp_iaprove($value) {
                if($value==0){$vstatus='Waiting for approval';}
                elseif($value==1){$vstatus='Rejected';}
                elseif($value==2){$vstatus='Approved';}
                return $vstatus;
            }
            function insertBox_export_refor_lpp_iexport_req_refor($field, $id) {     
                    $uri = 'export_refor_lpp';
                    $o = "";  
                    $o   .= "<div style='
                                    padding: 3px;
                                    width: 500px;
                                    border: 1px solid rgba(51, 23, 93, 0.2);
                                    background-color: #FFF;'>";


                    $o   .= "<table border='0' style='width: 100%;'>
                                <tbody>";  
                    $o  .="         <tr>
                                        <td width='20%'>No Request</td>
                                        <td>:</td>
                                        <td width='75%'>";
                    $o .= '         <input type="hidden" name="'.$field.'"  id="'.$id.'"  class="'.$id.' input_rows1 required" size="30" />';
                    $o .= '         <input readonly type="text" name="'.$uri.'_vno_export_req_refor"  id="'.$uri.'_vno_export_req_refor"  class="'.$uri.'_vno_export_req_refor required input_rows1" size="30" />';
                    $o .= '         &nbsp;<button class="icon_pop"  onclick="browse(\''.base_url().'processor/reformulasi/browse/lpp/export?field=export_refor_lpp\',\'Request Reformulasi\')" type="button">Browse</button>';  
                    $o  .="             </td>
                                    </tr>
                                    
                                    <tr>
                                        <td width='20%'>Nama Produk</td>
                                        <td>:</td>
                                        <td width='75%'> 
                                            <span class='".$uri."_cIteno' id='".$uri."_cIteno'></span> 
                                        </td>
                                    </tr>
                                     

                                    <tr>
                                        <td width='20%'>Nama Inisiator</td>
                                        <td>:</td>
                                        <td width='75%'> 

                                            <span class='".$uri."_cInisiator' id='".$uri."_cInisiator'></span>
                                        </td>
                                    </tr>

                                    <tr>
                                        <td width='20%'>Dapartement</td>
                                        <td>:</td>
                                        <td width='75%'> 
                                            <span class='".$uri."_cdapart' id='".$uri."_cdapart'></span>
                                        </td>
                                    </tr>

                                    <tr>
                                        <td width='20%'>Alasan Refor</td>
                                        <td>:</td>
                                        <td width='75%'> 
                                            <span class='".$uri."_vAlasan_refor' id='".$uri."_vAlasan_refor'></span>
                                        </td>
                                    </tr> 

                                    <tr>
                                        <td width='20%'>Team PD</td>
                                        <td>:</td>
                                        <td width='75%'> 
                                            <span class='".$uri."_iTeamPD' id='".$uri."_iTeamPD'></span>  
                                        </td>
                                    </tr>

                                    <tr>
                                        <td width='20%'>Tgl Permintaan Refor</td>
                                        <td>:</td>
                                        <td width='75%'> 
                                            <span class='".$uri."_dRequest' id='".$uri."_dRequest'></span> 
                                        </td>
                                    </tr>

                                    <tr>
                                        <td width='20%'>Approval Atasan Inisiator</td>
                                        <td>:</td>
                                        <td width='75%'> 
                                            <span class='".$uri."_iStatus' id='".$id."_iStatus'></span> 
                                        </td>
                                    </tr>

                                    <tr>
                                        <td width='20%'>PIC Formulator Refor</td>
                                        <td>:</td>
                                        <td width='75%'> 
                                            <span class='".$uri."_cFormulator' id='".$uri."_cFormulator'></span>  
                                        </td>
                                    </tr>

                                    <tr>
                                        <td width='20%'>File Upload</td>
                                        <td>:</td>
                                        <td width='75%'> 
                                            <span class='".$uri."_iupload_f' id='".$uri."_iupload_f'></span>
                                        </td>
                                    </tr>
 
                                </tbody>    
                            </table>"; 
                    $o .= "    </div>";  

                    $o .= '<script>
                            $( "button.icon_pop" ).button({
                                icons: {
                                    primary: "ui-icon-newwin"
                                }, 
                            })
                        </script>';

                         
                    return $o;
                    }
            function updateBox_export_refor_lpp_iexport_req_refor($field, $id, $value, $rowData) {
                    $sql = "SELECT * FROM reformulasi.`export_req_refor` lr WHERE lr.`lDeleted` = 0 AND lr.`iexport_req_refor` = '".$value."'";
                    $dt = $this->db->query($sql)->row_array();
                    $_cIteno = ''; 
                    $_vno_export_req_refor='';
                    $_vBatch_no='';
                    $_vAlasan_refor='';
                    $_dRequest=''; 
                    $_cIteno=''; 
                    $_cInisiator='';
                    $_cdapart='';
                    $_iTeamPD='';
                    $_iStatus='';
                    $_cFormulator='';
                    $_iupload_f = '';
                    if(!empty($dt['iexport_req_refor'])){
                            $sq_all='SELECT * FROM reformulasi.`export_req_refor_file` lf WHERE lf.lDeleted = 0 AND 
                                    lf.iexport_req_refor = "'.$value.'"'; 
                            $data['sq_all'] = $this->db->query($sq_all)->result_array();  
                            $_iupload_f =  $this->load->view('export/export_refor_lpp_ref_file',$data,TRUE); 
                            $_vno_export_req_refor = $dt['vno_export_req_refor']; 
                            $_vAlasan_refor = str_replace("'", "",str_replace('""', '', $dt['tAlasan_export']));
                            $_dRequest = $dt['dPermintaan_req_export'];
                            
                            $itname = "SELECT i.`c_itnam` FROM sales.`itemas` i 
                                JOIN `dossier`.`dossier_upd` d ON d.`iupb_id` = i.`c_iteno`
                                WHERE  d.`idossier_upd_id` =  '".$dt['idossier_upd_id']."'"; 
                            $c_itnam = $this->db->Query($itname)->row_array();
                            if(empty($c_itnam['c_itnam'])){
                                $c_itnam['c_itnam'] = '-';
                            } 
                            $_cIteno = $c_itnam['c_itnam'];


                            $vn = "SELECT e.`vName` FROM hrd.`employee` e WHERE e.`cNip` = '".$dt['cInisiator_export']."'";
                                    $vName = $this->db->query($vn)->row_array();
                            if(empty($vName['vName'])){
                                $vName['vName'] = '-';
                            }
                            $_cInisiator = $vName['vName'];


                            $dp = "SELECT m.`vDescription` FROM  hrd.`msdepartement` m  
                                    WHERE m.`iDeptID` = '".$dt['iDapartemen_export']."'";
                            $cdapart = $this->db->query($dp)->row_array(); 
                            if(empty($cdapart['vDescription'])){
                                $cdapart['vDescription'] = '-';
                            }
                            $_cdapart = $cdapart['vDescription'];

                            $pd = "SELECT r.vteam FROM reformulasi.`reformulasi_team` r WHERE r.ldeleted=0 AND r.ireformulasi_team= '".$dt['iTeamPD']."'";
                            $c_pd = $this->db->Query($pd)->row_array();
                            if(empty($c_pd['vteam'])){
                                $c_pd['vteam'] = '-';
                            } 
                            $_iTeamPD=$c_pd['vteam'];

                            $ap = "SELECT e.`vName` FROM hrd.`employee` e WHERE e.`cNip` = '".$dt['cApproval_ats_inisiator']."'";
                            $app = $this->db->query($ap)->row_array();
                            if($dt['iApproval_ats_inisiator']==2){
                                if(empty($app['vName'])){
                                    $app['vName'] = 'Approved'.' Tgl '.$dt['dApproval_ats_inisiator'];
                                }else{ 
                                    $app['vName'] = 'Approved by '.$app['vName'].' Tgl '.$dt['dApproval_ats_inisiator'];
                                }
                            }else if($dt['iApproval_ats_inisiator']==1){
                                if(empty($app['vName'])){
                                    $app['vName'] = 'Rejected'.' Tgl '.$dt['dApproval_ats_inisiator'];
                                }else{ 
                                    $app['vName'] = 'Rejected by '.$app['vName'].' Tgl '.$dt['dApproval_ats_inisiator'];
                                }
                            }else{
                                $app['vName'] = 'Waiting Approval';
                            }

                            $_iStatus = $app['vName'];


                            $for = "SELECT e.`vName` FROM hrd.`employee` e WHERE e.`cNip` = '".$dt['cPicFormulator']."'";
                            $formu = $this->db->query($for)->row_array();
                            if(empty($formu['vName'])){
                                $formu['vName'] = '-';
                            }
                            $_cFormulator = $formu['vName'];
                    }

                    $uri = 'export_refor_lpp';
                    $o = "";  
                    $o   .= "<div style='
                                    padding: 3px;
                                    width: 500px;
                                    border: 1px solid rgba(51, 23, 93, 0.2);
                                    background-color: #FFF;'>";


                    $o   .= "<table border='0' style='width: 100%;'>
                                <tbody>";  
                    $o  .="         <tr>
                                        <td width='20%'>No Request</td>
                                        <td>:</td>
                                        <td width='75%'>";
                    $o .= '         <input type="hidden" name="'.$field.'"  id="'.$id.'"  class="'.$id.' input_rows1 required" size="30" value="'.$value.'"/>';
                    $o .= '         <input readonly type="text" name="'.$uri.'_vno_export_req_refor"  id="'.$uri.'_vno_export_req_refor"  class="'.$uri.'_vno_export_req_refor required input_rows1" size="30" value="'.$_vno_export_req_refor.'"/>';
                    if($rowData['isubmit']==0){
                        $o .= '         &nbsp;<button class="icon_pop"  onclick="browse(\''.base_url().'processor/reformulasi/browse/lpp/export?field=export_refor_lpp\',\'Request Reformulasi\')" type="button">Browse</button>';  
                    }
                    $o  .="             </td>
                                    </tr>
                                    
                                    <tr>
                                        <td width='20%'>Nama Produk</td>
                                        <td>:</td>
                                        <td width='75%'> 
                                            <span class='".$uri."_cIteno' id='".$uri."_cIteno'>".$_cIteno."</span> 
                                        </td>
                                    </tr>
                                    
                                    

                                    <tr>
                                        <td width='20%'>Nama Inisiator</td>
                                        <td>:</td>
                                        <td width='75%'> 

                                            <span class='".$uri."_cInisiator' id='".$uri."_cInisiator'>".$_cInisiator."</span>
                                        </td>
                                    </tr>

                                    <tr>
                                        <td width='20%'>Dapartement</td>
                                        <td>:</td>
                                        <td width='75%'> 
                                            <span class='".$uri."_cdapart' id='".$uri."_cdapart'>".$_cdapart."</span>
                                        </td>
                                    </tr>

                                    <tr>
                                        <td width='20%'>Alasan Refor</td>
                                        <td>:</td>
                                        <td width='75%'> 
                                            <span class='".$uri."_vAlasan_refor' id='".$uri."_vAlasan_refor'>".$_vAlasan_refor."</span>
                                        </td>
                                    </tr> 

                                    <tr>
                                        <td width='20%'>Team PD</td>
                                        <td>:</td>
                                        <td width='75%'> 
                                            <span class='".$uri."_iTeamPD' id='".$uri."_iTeamPD'>".$_iTeamPD."</span>  
                                        </td>
                                    </tr>

                                    <tr>
                                        <td width='20%'>Tgl Permintaan Refor</td>
                                        <td>:</td>
                                        <td width='75%'> 
                                            <span class='".$uri."_dRequest' id='".$uri."_dRequest'>".$_dRequest."</span> 
                                        </td>
                                    </tr>

                                    <tr>
                                        <td width='20%'>Approval Atasan Inisiator</td>
                                        <td>:</td>
                                        <td width='75%'> 
                                            <span class='".$uri."_iStatus' id='".$id."_iStatus'>".$_iStatus."</span> 
                                        </td>
                                    </tr>

                                    <tr>
                                        <td width='20%'>PIC Formulator Refor</td>
                                        <td>:</td>
                                        <td width='75%'> 
                                            <span class='".$uri."_cFormulator' id='".$uri."_cFormulator'>".$_cFormulator."</span>  
                                        </td>
                                    </tr>

                                    <tr>
                                        <td width='20%'>File Upload</td>
                                        <td>:</td>
                                        <td width='75%'> 
                                            <span class='".$uri."_iupload_f' id='".$uri."_iupload_f'>".$_iupload_f."</span>
                                        </td>
                                    </tr>

                                    
                                    
                                </tbody>    
                            </table>"; 
                    $o .= "    </div>";  

                    $o .= '<script>
                            $( "button.icon_pop" ).button({
                                icons: {
                                    primary: "ui-icon-newwin"
                                }, 
                            })
                        </script>';

                         
                    return $o;
                    }   
            
            
            function insertBox_export_refor_lpp_dmulai_lpp($field, $id) {
                $return = '<input type="text" name="'.$field.'"  id="'.$id.'"  class="input_rows1 required" size="30" />';
                $return .= '<script>
                                $("#'.$id.'").datepicker({  changeMonth:true,
                                        changeYear:true,
                                        dateFormat:"yy-mm-dd"}); 
                             </script>';
                $return .= '<input type="hidden" name="isdraft" id="isdraft" class="isdraft">';
                $return .= '<input type="hidden" name="iexport_refor_lpp" id="iexport_refor_lpp" class="iexport_refor_lpp">';

                
                return $return;
            }
            function updateBox_export_refor_lpp_dmulai_lpp($field, $id, $value, $rowData) {
                if ($this->input->get('action') == 'view') {
                     $return= $value; 
                }else{
                $return = '<input type="text" name="'.$field.'"  id="'.$id.'"  class="input_rows1 required" size="30" value="'.$value.'"/>';
                $return .= '<script>
                                $("#'.$id.'").datepicker({
                                    changeMonth:true,
                                    changeYear:true,
                                    dateFormat:"yy-mm-dd"
                                });
                             </script>';
                } 
                $return .= '<input type="hidden" name="isdraft" id="isdraft" class="isdraft">';
                $return .= '<input type="hidden" name="iexport_refor_lpp" id="iexport_refor_lpp" class="iexport_refor_lpp" value="'.$rowData['iexport_refor_lpp'].'">';
                return $return;
            }   
            
            function insertBox_export_refor_lpp_dselesai_lpp($field, $id) {
                $return = '<input type="text" name="'.$field.'"  id="'.$id.'"  class="input_rows1 required" size="30" />';
                $return .= '<script>
                                $("#'.$id.'").datepicker({  changeMonth:true,
                                        changeYear:true,
                                        dateFormat:"yy-mm-dd"}); 
                             </script>';
                return $return;
            }
            function updateBox_export_refor_lpp_dselesai_lpp($field, $id, $value, $rowData) {
                if ($this->input->get('action') == 'view') {
                     $return= $value; 
                }else{
                $return = '<input type="text" name="'.$field.'"  id="'.$id.'"  class="input_rows1 required" size="30" value="'.$value.'"/>';
                $return .= '<script>
                                $("#'.$id.'").datepicker({
                                    changeMonth:true,
                                    changeYear:true,
                                    dateFormat:"yy-mm-dd"
                                });
                             </script>';
                } 
                return $return;
            }   
            
            function insertBox_export_refor_lpp_cpicpd_lpp($field, $id) {
                $url6 = base_url().'processor/reformulasi/export/refor/lpp/?action=searchcNip'; 
                $o = "<script type='text/javascript'>
                                $(document).ready(function() { 
                                    $('#".$id."_').live('keyup', function(e) {
                                        var config = {
                                            source: '".$url6."',                    
                                            select: function(event, ui){
                                                $('#".$id."').val(ui.item.id);
                                                $('#".$id."_').val(ui.item.value);  
                                                return false;                           
                                            },
                                            minLength: 2,
                                            autoFocus: true,
                                            }; 
                                        $('#".$id."_').autocomplete(config);  
                                        $(this).keypress(function(e){
                                            if(e.which != 13) {
                                                $('#".$id."').val('');
                                            }           
                                        });
                                        $(this).blur(function(){
                                            if($('#".$id."').val() == '') {
                                                $(this).val('');
                                            }           
                                        });

                                    }); 
                                        
                                }); 
                          </script>";
                $o   .= '<input type="hidden" name="'.$field.'"  id="'.$id.'"  class="input_rows1 required" size="30" maxlength = "50"  value=""/>';
                $o   .= '<input type="text" name="'.$field.'_"  id="'.$id.'_"  class="input_rows1 " size="30" maxlength = "50"  value=""/>';             
                return $o;
            }
            function updateBox_export_refor_lpp_cpicpd_lpp($field, $id, $value, $rowData) {
                $vn = "SELECT e.`vName` FROM hrd.`employee` e WHERE e.`cNip` = '".$value."'";
                $vName = $this->db->query($vn)->row_array();
                if(empty($vName['vName'])){
                    $vName['vName'] = '-';
                }
                if ($this->input->get('action') == 'view') {
                     $o= $value.' - '.$vName['vName']; 
                }else{
                    $url6 = base_url().'processor/reformulasi/export/refor/lpp/?action=searchcNip'; 
                    $o = "<script type='text/javascript'>
                                    $(document).ready(function() { 
                                        $('#".$id."_').live('keyup', function(e) {
                                            var config = {
                                                source: '".$url6."',                    
                                                select: function(event, ui){
                                                    $('#".$id."').val(ui.item.id);
                                                    $('#".$id."_').val(ui.item.value);  
                                                    return false;                           
                                                },
                                                minLength: 2,
                                                autoFocus: true,
                                                }; 
                                            $('#".$id."_').autocomplete(config);  
                                            $(this).keypress(function(e){
                                                if(e.which != 13) {
                                                    $('#".$id."').val('');
                                                }           
                                            });
                                            $(this).blur(function(){
                                                if($('#".$id."').val() == '') {
                                                    $(this).val('');
                                                }           
                                            });

                                        }); 
                                            
                                    }); 
                              </script>";
                    $o   .= '<input type="hidden" name="'.$field.'"  id="'.$id.'"  class="input_rows1 required" size="30" maxlength = "50"  value="'.$value.'"/>';
                    $o   .= '<input type="text" name="'.$field.'_"  id="'.$id.'_"  class="input_rows1 " size="30" maxlength = "50"  value="'.$value.' - '.$vName['vName'].'"/>';
                } 
                return $o;
            }   
            
            function insertBox_export_refor_lpp_dCreate($field, $id) {
                $return = '<input type="text" name="'.$field.'"  id="'.$id.'"  class="input_rows1 required" size="30" />';
                $return .= '<script>
                                $("#'.$id.'").datepicker({  changeMonth:true,
                                        changeYear:true,
                                        dateFormat:"yy-mm-dd"}); 
                             </script>';
                return $return;
            }
            function updateBox_export_refor_lpp_dCreate($field, $id, $value, $rowData) {
                if ($this->input->get('action') == 'view') {
                     $return= $value; 
                }else{
                $return = '<input type="text" name="'.$field.'"  id="'.$id.'"  class="input_rows1 required" size="30" value="'.$value.'"/>';
                $return .= '<script>
                                $("#'.$id.'").datepicker({
                                    changeMonth:true,
                                    changeYear:true,
                                    dateFormat:"yy-mm-dd"
                                });
                             </script>';
                } 
                return $return;
            }   
            
            function insertBox_export_refor_lpp_cCreated($field, $id) {
                $return = '<input type="text" name="'.$field.'"  id="'.$id.'"  class="input_rows1 required" size="30" maxlength = "50" />';
                $return .= '<script>
                                $("#'.$id.'").keyup(function() {
                                    var len = this.value.length;
                                        if (len >= 250) {
                                            this.value = this.value.substring(0, 50);
                                        }
                                    $("#maxlengthnote_'.$id.'").text(50 - len);
                                });
                             </script>';
                $return .= '<br/>tersisa <span id="maxlengthnote_'.$id.'">50</span> karakter<br/>';
                return $return;
            }
            function updateBox_export_refor_lpp_cCreated($field, $id, $value, $rowData) {
                if ($this->input->get('action') == 'view') {
                     $return= $value; 
                }else{
                $return = '<input type="text" name="'.$field.'"  id="'.$id.'"  class="input_rows1 required" size="30" maxlength = "50"  value="'.$value.'"/>';
                $return .= '<script>
                                $("#'.$id.'").keyup(function() {
                                    var len = this.value.length;
                                        if (len >= 50) {
                                            this.value = this.value.substring(0, 50);
                                        }
                                    $("#maxlengthnote_'.$id.'").text(50 - len);
                                });
                             </script>';
                $return .= '<br/>tersisa <span id="maxlengthnote_'.$id.'">50</span> karakter<br/>';

                } 
                return $return;
            }   
            
            function insertBox_export_refor_lpp_dupdate($field, $id) {
                $return = '<input type="text" name="'.$field.'"  id="'.$id.'"  class="input_rows1 required" size="30" />';
                $return .= '<script>
                                $("#'.$id.'").datepicker({  changeMonth:true,
                                        changeYear:true,
                                        dateFormat:"yy-mm-dd"}); 
                             </script>';
                return $return;
            }
            function updateBox_export_refor_lpp_dupdate($field, $id, $value, $rowData) {
                if ($this->input->get('action') == 'view') {
                     $return= $value; 
                }else{
                $return = '<input type="text" name="'.$field.'"  id="'.$id.'"  class="input_rows1 required" size="30" value="'.$value.'"/>';
                $return .= '<script>
                                $("#'.$id.'").datepicker({
                                    changeMonth:true,
                                    changeYear:true,
                                    dateFormat:"yy-mm-dd"
                                });
                             </script>';
                } 
                return $return;
            }   
            
            function insertBox_export_refor_lpp_cUpdate($field, $id) {
                $return = '<input type="text" name="'.$field.'"  id="'.$id.'"  class="input_rows1 required" size="30" maxlength = "50" />';
                $return .= '<script>
                                $("#'.$id.'").keyup(function() {
                                    var len = this.value.length;
                                        if (len >= 250) {
                                            this.value = this.value.substring(0, 50);
                                        }
                                    $("#maxlengthnote_'.$id.'").text(50 - len);
                                });
                             </script>';
                $return .= '<br/>tersisa <span id="maxlengthnote_'.$id.'">50</span> karakter<br/>';
                return $return;
            }
            function updateBox_export_refor_lpp_cUpdate($field, $id, $value, $rowData) {
                if ($this->input->get('action') == 'view') {
                     $return= $value; 
                }else{
                $return = '<input type="text" name="'.$field.'"  id="'.$id.'"  class="input_rows1 required" size="30" maxlength = "50"  value="'.$value.'"/>';
                $return .= '<script>
                                $("#'.$id.'").keyup(function() {
                                    var len = this.value.length;
                                        if (len >= 50) {
                                            this.value = this.value.substring(0, 50);
                                        }
                                    $("#maxlengthnote_'.$id.'").text(50 - len);
                                });
                             </script>';
                $return .= '<br/>tersisa <span id="maxlengthnote_'.$id.'">50</span> karakter<br/>';

                } 
                return $return;
            }   
            
            function insertBox_export_refor_lpp_lDeleted($field, $id) {
                $return = '<input type="text" name="'.$field.'"  id="'.$id.'"  class="input_rows1 required" size="30" />';
                $return .= '<script>
                                $("#'.$id.'").keyup(function() {
                                     this.value = this.value.replace(/[^0-9\.]/g,"");
                                });
                             </script>';
                return $return;
            }
            function updateBox_export_refor_lpp_lDeleted($field, $id, $value, $rowData) {
                if ($this->input->get('action') == 'view') {
                     $return= $value; 
                }else{
                $return = '<input type="text" name="'.$field.'"  id="'.$id.'"  class="input_rows1 required" size="30" value="'.$value.'"/>';
                $return .= '<script>
                                $("#'.$id.'").keyup(function() {
                                     this.value = this.value.replace(/[^0-9\.]/g,"");
                                });
                             </script>';
                } 
                return $return;
            }   
            
            function insertBox_export_refor_lpp_isubmit($field, $id) {
                $return = '<input type="text" name="'.$field.'"  id="'.$id.'"  class="input_rows1 required" size="30" />';
                $return .= '<script>
                                $("#'.$id.'").keyup(function() {
                                     this.value = this.value.replace(/[^0-9\.]/g,"");
                                });
                             </script>';
                return $return;
            }
            function updateBox_export_refor_lpp_isubmit($field, $id, $value, $rowData) {
                if ($this->input->get('action') == 'view') {
                     $return= $value; 
                }else{
                $return = '<input type="text" name="'.$field.'"  id="'.$id.'"  class="input_rows1 required" size="30" value="'.$value.'"/>';
                $return .= '<script>
                                $("#'.$id.'").keyup(function() {
                                     this.value = this.value.replace(/[^0-9\.]/g,"");
                                });
                             </script>';
                } 
                return $return;
            }   
            
            function insertBox_export_refor_lpp_iaprove($field, $id) {
                $return ='';
                $return .= '
                            <script type="text/javascript">
                                $("label[for=\''.$id.'\']").hide();
                                $("label[for=\''.$id.'\']").next().css("margin-left",0);
                            </script>
                        ';
                $return .= '<div></div>';
                return $return;
            }
            function updateBox_export_refor_lpp_iaprove($field, $id, $value, $rowData) {
                if(($value <> 0) || (!empty($value))){
                    $sql_dtapp = "SELECT * FROM reformulasi.`export_refor_lpp` a JOIN hrd.employee b 
                            on b.cNip=a.caprove
                            WHERE a.`lDeleted` = 0 AND a.iexport_refor_lpp = '".$rowData['iexport_refor_lpp']."'";
                    $row = $this->db->query($sql_dtapp)->row_array();
                    
                    if($value==2){
                        $st='<p style="">Approved';
                        $ret= $st.' oleh '.$row['vName'].' pada '.$row['daprove'].'</br> Alasan: '.$row['taprove'].'</p>';
                    }
                    elseif($value==1){
                        $st='<p style="color:red;">Rejected';
                        $ret= $st.' oleh '.$row['vName'].' pada '.$row['daprove'].'</br> Alasan: '.$row['taprove'].'</p>';
                    } 
                }
                else{
                    $ret='Waiting for Approval';
                }
                $ret .= "<input type='hidden' name='".$field."' id='".$id."'  value='".$value."'/>";
                return '<i>'.$ret.'</i>';
            }   
            
            function insertBox_export_refor_lpp_caprove($field, $id) {
                $return = '<input type="text" name="'.$field.'"  id="'.$id.'"  class="input_rows1 required" size="30" maxlength = "50" />';
                $return .= '<script>
                                $("#'.$id.'").keyup(function() {
                                    var len = this.value.length;
                                        if (len >= 250) {
                                            this.value = this.value.substring(0, 50);
                                        }
                                    $("#maxlengthnote_'.$id.'").text(50 - len);
                                });
                             </script>';
                $return .= '<br/>tersisa <span id="maxlengthnote_'.$id.'">50</span> karakter<br/>';
                return $return;
            }
            function updateBox_export_refor_lpp_caprove($field, $id, $value, $rowData) {
                if ($this->input->get('action') == 'view') {
                     $return= $value; 
                }else{
                $return = '<input type="text" name="'.$field.'"  id="'.$id.'"  class="input_rows1 required" size="30" maxlength = "50"  value="'.$value.'"/>';
                $return .= '<script>
                                $("#'.$id.'").keyup(function() {
                                    var len = this.value.length;
                                        if (len >= 50) {
                                            this.value = this.value.substring(0, 50);
                                        }
                                    $("#maxlengthnote_'.$id.'").text(50 - len);
                                });
                             </script>';
                $return .= '<br/>tersisa <span id="maxlengthnote_'.$id.'">50</span> karakter<br/>';

                } 
                return $return;
            }   
            
            function insertBox_export_refor_lpp_taprove($field, $id) {
                $return = '<textarea name="'.$field.'" id="'.$id.'" class="required" style="width: 240px; height: 50px;" size="250" maxlength ="250"></textarea>';
                $return .= '<script>
                                $("#'.$id.'").keyup(function() {
                                    var len = this.value.length;
                                        if (len >= 250) {
                                            this.value = this.value.substring(0, 255);
                                        }
                                    $("#maxlengthnote_'.$id.'").text(255 - len);
                                });
                             </script>';
                $return .= '<br/>tersisa <span id="maxlengthnote_'.$id.'">250</span> karakter<br/>';
                return $return;
            }
            function updateBox_export_refor_lpp_taprove($field, $id, $value, $rowData) {
                if ($this->input->get('action') == 'view') {
                     $return= '<label title="Note">'.nl2br($value).'</label>'; 
                }else{
                    $return = '<textarea name="'.$field.'" id="'.$id.'" class="required" style="width: 240px; height: 50px;" size="250" maxlength ="250">'.nl2br($value).'</textarea>';
                } 
                return $return;
            }   

             function insertBox_export_refor_lpp_iuploadFile($field, $id) {
                $data['rows']=array();
                $return = $this->load->view('export/export_refor_lpp_file',$data,TRUE);
                $return .= '<input type="hidden" name="isdraft" id="isdraft" class="isdraft">';
                $return .= '<input type="hidden" name="iexport_refor_lpp" id="iexport_refor_lpp" class="iexport_refor_lpp">';

                
                return $return;
            }
            function updateBox_export_refor_lpp_iuploadFile($field, $id, $value, $rowData) {
                $sq = "SELECT * FROM reformulasi.`export_refor_lpp_file` ed WHERE  
                     ed.`lDeleted` = 0 AND ed.`iexport_refor_lpp` ='".$rowData['iexport_refor_lpp']."'";
                $data['rows']=$this->db->query($sq)->result_array();
                $data['isubmitAd']=$rowData['isubmitAd']; 
                $return = $this->load->view('export/export_refor_lpp_file',$data,TRUE);
                $return .= '<input type="hidden" name="isdraft" id="isdraft" class="isdraft">';
                 $return .= '<input type="hidden" name="iexport_refor_lpp" id="iexport_refor_lpp" class="iexport_refor_lpp" value="'.$rowData['iexport_refor_lpp'].'">';
                
                return $return;
            }   
            
            function insertBox_export_refor_lpp_daprove($field, $id) {
                $return = '<input type="text" name="'.$field.'"  id="'.$id.'"  class="input_rows1 required" size="30" />';
                $return .= '<script>
                                $("#'.$id.'").datepicker({  changeMonth:true,
                                        changeYear:true,
                                        dateFormat:"yy-mm-dd"}); 
                             </script>';
                return $return;
            }
            function updateBox_export_refor_lpp_daprove($field, $id, $value, $rowData) {
                if ($this->input->get('action') == 'view') {
                     $return= $value; 
                }else{
                $return = '<input type="text" name="'.$field.'"  id="'.$id.'"  class="input_rows1 required" size="30" value="'.$value.'"/>';
                $return .= '<script>
                                $("#'.$id.'").datepicker({
                                    changeMonth:true,
                                    changeYear:true,
                                    dateFormat:"yy-mm-dd"
                                });
                             </script>';
                } 
                return $return;
            }   
            
            
                //Ini Merupakan Standart Approve yang digunakan di erp
 
                function approve_view() {
                    $echo = '<script type="text/javascript">
                                 function submit_ajax(form_id) {
                                    return $.ajax({
                                        url: $("#"+form_id).attr("action"),
                                        type: $("#"+form_id).attr("method"),
                                        data: $("#"+form_id).serialize(),
                                        success: function(data) {
                                            var o = $.parseJSON(data);
                                            var last_id = o.last_id;
                                            var url = "'.base_url().'processor/reformulasi/export_refor_lpp";                             
                                            if(o.status == true) { 
                                                $("#alert_dialog_form").dialog("close");
                                                     $.get(url+"?action=update&id="+last_id, function(data) {
                                                     $("div#form_export_refor_lpp").html(data);
                                                     
                                                });
                                                
                                            }
                                                reload_grid("grid_export_refor_lpp");
                                        }
                                        
                                     })
                                 }
                             </script>';
                    $echo .= '<h1>Approve</h1><br />';
                    $echo .= '<form id="form_export_refor_lpp_approve" action="'.base_url().'processor/reformulasi/export_refor_lpp?action=approve_process" method="post">';
                    $echo .= '<div style="vertical-align: top;">';
                    $echo .= 'Remark : 
                            <input type="hidden" name="iexport_refor_lpp" value="'.$this->input->get('iexport_refor_lpp').'" />
                            <input type="hidden" name="lvl" value="'.$this->input->get('lvl').'" />
                            <input type="hidden" name="group_id" value="'.$this->input->get('group_id').'" />
                            <input type="hidden" name="modul_id" value="'.$this->input->get('modul_id').'" />
                            <textarea name="vRemark"></textarea>
                    <button type="button" onclick="submit_ajax(\'form_export_refor_lpp_approve\')">Approve</button>';
                        
                    $echo .= '</div>';
                    $echo .= '</form>';
                    return $echo;
                } 
 
                function approve_process() {
                    $post = $this->input->post();
                    $cNip= $this->user->gNIP;
                    $vName= $this->user->gName;
                    $iexport_refor_lpp = $post['iexport_refor_lpp'];
                    $vRemark = $post['vRemark'];
                    $lvl = $post['lvl'];

                    $sql = "UPDATE reformulasi.`export_refor_lpp` SET iaprove=2 , daprove=SYSDATE(), 
                        caprove='".$cNip."', taprove='".$vRemark."' WHERE iexport_refor_lpp = '".$iexport_refor_lpp."'";
                    $this->db->query($sql);    
 
                    //Letakan Query Update approve disini

                    $data['status']  = true;
                    $data['last_id'] = $post['iexport_refor_lpp'];
                    return json_encode($data);
                }
            

        
            /*
                //Ini Merupakan Standart Reject yang digunakan di erp

                function reject_view() {
                    $echo = '<script type="text/javascript">
                                 function submit_ajax(form_id) {
                                    var remark = $("#export_refor_lpp_remark").val();
                                    if (remark=="") {
                                        alert("Remark tidak boleh kosong ");
                                        return
                                    }

                                    return $.ajax({
                                        url: $("#"+form_id).attr("action"),
                                        type: $("#"+form_id).attr("method"),
                                        data: $("#"+form_id).serialize(),
                                        success: function(data) {
                                            var o = $.parseJSON(data);
                                            var last_id = o.last_id;
                                            var url = "'.base_url().'processor/reformulasi/export_refor_lpp";                             
                                            if(o.status == true) { 
                                                $("#alert_dialog_form").dialog("close");
                                                     $.get(url+"?action=update&id="+last_id, function(data) {
                                                     $("div#form_export_refor_lpp").html(data);
                                                     
                                                });
                                                
                                            }
                                                reload_grid("grid_export_refor_lpp");
                                        }
                                        
                                     })
                                 }
                             </script>';
                    $echo .= '<h1>Reject</h1><br />';
                    $echo .= '<form id="form_export_refor_lpp_reject" action="'.base_url().'processor/reformulasi/export_refor_lpp?action=reject_process" method="post">';
                    $echo .= '<div style="vertical-align: top;">';
                    $echo .= 'Remark : 
                            <input type="hidden" name="iexport_refor_lpp" value="'.$this->input->get('iexport_refor_lpp').'" />
                            <input type="hidden" name="lvl" value="'.$this->input->get('lvl').'" />
                            <input type="hidden" name="group_id" value="'.$this->input->get('group_id').'" />
                            <input type="hidden" name="modul_id" value="'.$this->input->get('modul_id').'" />
                            <textarea name="vRemark" id="reject_export_refor_lpp_remark"></textarea>
                    <button type="button" onclick="submit_ajax(\'form_export_refor_lpp_reject\')">Reject</button>';
                        
                    $echo .= '</div>';
                    $echo .= '</form>';
                    return $echo;
                }


                
                function reject_process() {
                    $post = $this->input->post();
                    $cNip= $this->user->gNIP;
                    $vName= $this->user->gName;
                    $iexport_refor_lpp = $post['iexport_refor_lpp'];
                    $vRemark = $post['vRemark'];
                    $lvl = $post['lvl'];
 
                    //Letakan Query Update approve disini

                    $data['status']  = true;
                    $data['last_id'] = $post['iexport_refor_lpp'];
                    return json_encode($data);
                }
            */

        
            //Standart Setiap table harus memiliki dCreate , cCreated, dupdate, cUpdate
            function before_insert_processor($row, $postData) {
                $postData['dCreate'] = date('Y-m-d H:i:s');
                $postData['cCreated']=$this->user->gNIP; 

                if($postData['isdraft']==true){
                    $postData['isubmit']=0; 
                } 
                else{
                    $postData['isubmit']=1; 
                } 

                return $postData;

            }
            function before_update_processor($row, $postData) {
                $postData['dCreate'] = date('Y-m-d H:i:s');
                $postData['cCreated']=$this->user->gNIP; 

                if($postData['isdraft']==true){
                    $postData['isubmit']=0; 
                } 
                else{
                    $postData['isubmit']=1; 
                } 

                return $postData;
            }    
        
            function after_insert_processor($fields, $id, $postData) {
                //Example After Insert
                /*
                $cNip = $this->sess_auth->gNIP; 
                $sql = 'Place Query In Here';
                $this->dbset->query($sql);
                */

                if($postData['isubmit']==1){ 
                        $sql = "SELECT em.`vName`, e.`dmulai_lpp`, e.`dselesai_lpp`, r.`vno_export_req_refor` FROM reformulasi.`export_refor_lpp` e 
                            JOIN reformulasi.`export_req_refor` r ON e.`iexport_req_refor` = r.`iexport_req_refor`
                            JOIN hrd.`employee` em ON em.`cNip` = e.`cpicpd_lpp`
                            WHERE r.`lDeleted` = 0 AND e.`lDeleted` = 0 AND e.`iexport_refor_lpp` =  ".$id; 
                        $mailDet = $this->db->query($sql)->row_array();  


                        $sqlM = "SELECT r.`vnip` FROM `reformulasi`.`reformulasi_team` r
                                JOIN `reformulasi`.`export_req_refor` e ON e.`iTeamPD` = r.`ireformulasi_team` 
                                WHERE e.`iexport_req_refor` =  '".$postData['iexport_req_refor']."' LIMIT 1";
                        $tomail = $this->db->query($sqlM)->row_array();
                        $to = $tomail['vnip'];

                        $cc = $this->user->gNIP;
                        $subject="Submited Laporan Pengembangan Produk "; 
                        $content="
                        Diberitahukan bahwa telah ada Submited Modul LPP, 
                            dengan rincian sebagai berikut :<br><br>  
                            <table border='0' style='width: 600px;'>
                                <tr>
                                        <td style='width: 110px;'><b>No Request Reformulasi </b></td><td style='width: 20px;'> : </td>
                                        <td>".$mailDet['vno_export_req_refor']."</td>
                                </tr>
                                <tr>
                                        <td><b>PIC LPP  </b></td><td> : </td>
                                        <td>".$mailDet['vName']."</td> 
                                </tr>  
                                <tr>
                                        <td><b>Tanggal Mulai LPP  </b></td><td> : </td> 
                                        <td>".$mailDet['dmulai_lpp']."</td>
                                </tr>  
                                <tr>
                                        <td><b>Tanggal Selesao LPP </b></td><td> : </td> 
                                        <td>".$mailDet['dselesai_lpp']."</td>
                                </tr>  
                            </table>  
                        <br/> <br/>
                        Demikian, mohon segera follow up  pada aplikasi ERP Reformulasi. Terimakasih.<br><br><br>
                        Post Master"; 
                        $this->sess_auth->send_message_erp($this->uri->segment_array(),$to, $cc, $subject, $content); 
                }
            }
    
            function after_update_processor($fields, $id, $postData) {
                //Example After Update
                /*
                $cNip = $this->sess_auth->gNIP; 
                $sql = 'Place Query In Here';
                $this->dbset->query($sql);
                */

                if($postData['isubmit']==1){ 
                        $sql = "SELECT em.`vName`, e.`dmulai_lpp`, e.`dselesai_lpp`, r.`vno_export_req_refor` FROM reformulasi.`export_refor_lpp` e 
                            JOIN reformulasi.`export_req_refor` r ON e.`iexport_req_refor` = r.`iexport_req_refor`
                            JOIN hrd.`employee` em ON em.`cNip` = e.`cpicpd_lpp`
                            WHERE r.`lDeleted` = 0 AND e.`lDeleted` = 0 AND e.`iexport_refor_lpp` =  ".$id; 
                        $mailDet = $this->db->query($sql)->row_array();  


                        $sqlM = "SELECT r.`vnip` FROM `reformulasi`.`reformulasi_team` r
                                JOIN `reformulasi`.`export_req_refor` e ON e.`iTeamPD` = r.`ireformulasi_team` 
                                WHERE e.`iexport_req_refor` =  '".$postData['iexport_req_refor']."' LIMIT 1";
                        $tomail = $this->db->query($sqlM)->row_array();
                        $to = $tomail['vnip'];

                        $cc = $this->user->gNIP;
                        $subject="Submited Laporan Pengembangan Produk "; 
                        $content="
                        Diberitahukan bahwa telah ada Submited Modul LPP, 
                            dengan rincian sebagai berikut :<br><br>  
                            <table border='0' style='width: 600px;'>
                                <tr>
                                        <td style='width: 110px;'><b>No Request Reformulasi </b></td><td style='width: 20px;'> : </td>
                                        <td>".$mailDet['vno_export_req_refor']."</td>
                                </tr>
                                <tr>
                                        <td><b>PIC LPP  </b></td><td> : </td>
                                        <td>".$mailDet['vName']."</td> 
                                </tr>  
                                <tr>
                                        <td><b>Tanggal Mulai LPP  </b></td><td> : </td> 
                                        <td>".$mailDet['dmulai_lpp']."</td>
                                </tr>  
                                <tr>
                                        <td><b>Tanggal Selesao LPP </b></td><td> : </td> 
                                        <td>".$mailDet['dselesai_lpp']."</td>
                                </tr>  
                            </table>  
                        <br/> <br/>
                        Demikian, mohon segera follow up  pada aplikasi ERP Reformulasi. Terimakasih.<br><br><br>
                        Post Master"; 
                        $this->sess_auth->send_message_erp($this->uri->segment_array(),$to, $cc, $subject, $content); 
                }
            }
            function manipulate_insert_button($buttons) {
                unset($buttons['save']);
                $js = $this->load->view('export/js/export_refor_lpp_js'); 

                $save_draft = '<button onclick="javascript:save_draft_btn_multiupload(\'export_refor_lpp\', \''.base_url().'processor/reformulasi/export/refor/lpp?draft=true\', this, true)" class="ui-button-text icon-save" id="button_save_draft_export_refor_lpp_js">Save as Draft</button>';
                $save = '<button onclick="javascript:save_btn_multiupload(\'export_refor_lpp\', \''.base_url().'processor/reformulasi/export/refor/lpp?company_id='.$this->input->get('company_id').'&group_id='.$this->input->get('group_id').'&modul_id='.$this->input->get('modul_id').'\', this)" class="ui-button-text icon-save" id="button_save_export_refor_lpp_js">Save &amp Submit</button>';
                                 
                $buttons['save'] = $save_draft.$save.$js; 

                return $buttons;
            }

            function download($vFilename) {
                $this->load->helper('download');        
                $name = $vFilename;
                $id = $_GET['id']; 
                $path = file_get_contents('./files/reformulasi/export/export_refor_lpp/'.$id.'/'.$name);    
                force_download($name, $path);
            }

            
            function manipulate_update_button($buttons, $rowData) { 
                if ($this->input->get('action') == 'view') {
                    unset($buttons['update_back']);
                    unset($buttons['update']);
                }
                else{ 
                    $cNip= $this->user->gNIP;

                    $js = $this->load->view('export/js/export_refor_lpp_js');  
                    $update = '<button onclick="javascript:update_btn_back(\'export_refor_lpp\', \''.base_url().'processor/reformulasi/export/refor/lpp?company_id='.$this->input->get('company_id').'&group_id='.$this->input->get('group_id').'&modul_id='.$this->input->get('modul_id').'\', this)" class="ui-button-text icon-save" id="button_update_export_refor_lpp">Update & Submit</button>';
                    $updatedraft = '<button onclick="javascript:update_draft_btn(\'export_refor_lpp\', \''.base_url().'processor/reformulasi/export/refor/lpp?company_id='.$this->input->get('company_id').'&draft=true&group_id='.$this->input->get('group_id').'&modul_id='.$this->input->get('modul_id').'\', this, true)" class="ui-button-text icon-save" id="button_save_export_refor_lpp">Update as Draft</button>';

                    $approve = '<button onclick="javascript:load_popup(\''.base_url().'processor/reformulasi/export/refor/lpp?action=approve&iexport_refor_lpp='.$rowData['iexport_refor_lpp'].'&cNip='.$cNip.'&lvl=1&status=1&group_id='.$this->input->get('group_id').'&modul_id='.$this->input->get('modul_id').'\')" class="ui-button-text icon-save" id="button_approve_export_refor_lpp">Approve</button>';
                     

                    if($rowData['isubmit']==0){ 
                        $buttons['update'] = $updatedraft.$update.$js;    
                    }else{
                        if($rowData['iaprove']==0 or empty($rowData['iaprove'])){ 
                             $sqlM = "SELECT r.`vnip` FROM `reformulasi`.`reformulasi_team` r
                                JOIN `reformulasi`.`export_req_refor` e ON e.`iTeamPD` = r.`ireformulasi_team` 
                                WHERE e.`iexport_req_refor` =  '".$rowData['iexport_req_refor']."' LIMIT 1";
                                $tomail = $this->db->query($sqlM)->row_array();
                                if($tomail['vnip']==$cNip){
                                    $buttons['update'] = $approve.$js;
                                }else{
                                    unset($buttons['update_back']);
                                    unset($buttons['update']);
                                }  
                        }else{
                            unset($buttons['update_back']);
                            unset($buttons['update']);
                        }
                        
                        
                    }

                }

                return $buttons;
            }
            //Output
            public function output(){
                $this->index($this->input->get('action'));
            }
        }