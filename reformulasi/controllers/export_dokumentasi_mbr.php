 
        <?php
        /* Generated by Sovdev 2 ERP CRUD Generator 2018-02-27 09:50:43 */
        /* Location: ./modules/reformulasi/controllers/export_dokumentasi_mbr.php */
        /* Please DO NOT modify this information : */ 
         
        if ( ! defined('BASEPATH')) exit('No direct script access allowed');
        class export_dokumentasi_mbr extends MX_Controller {
            function __construct() {
                parent::__construct();
                $this->load->library('auth_export');
                $this->load->library('lib_utilitas');
                $this->load->library('auth');
                $this->db = $this->load->database('formulasi', false, true);
                $this->user = $this->auth->user();
            }
            function index($action = '') {
                $action = $this->input->get('action');
                //Bikin Object Baru Nama nya $grid      
                $grid = new Grid;
                $grid->setTitle('Dokumentasi MBR');
                $grid->setTable('reformulasi.export_dok_mbr');      
                $grid->setUrl('export_dokumentasi_mbr');

                //List Table
                $grid->addList('export_req_refor.vno_export_req_refor','dossier_upd.vUpd_no','itemas.c_itnam','isubmit_mbr','iappr_pd'); 
                $grid->setSortBy('idok_mbr');
                $grid->setSortOrder('DESC');  

                //List field
                $grid->addFields('vno_request','drevisi_mbr','drequest_cc','vno_cc','dappr_cc','dok_mbr_file','tappr_pd'); 

                //Setting Grid Width Name 
                /*
                    Kamu bisa merubah nama label dari sini, Contoh :
                    $grid->setLabel('nama field','nama field yang akan diubah');

                */
        
                $grid->setWidth('vno_request', '100');
                $grid->setAlign('vno_request', 'left');
                $grid->setLabel('vno_request','No Req Refor');

                $grid->setWidth('export_req_refor.vno_export_req_refor', '100');
                $grid->setAlign('export_req_refor.vno_export_req_refor', 'left');
                $grid->setLabel('export_req_refor.vno_export_req_refor','No Req Refor'); 

                $grid->setWidth('dossier_upd.vUpd_no', '100');
                $grid->setAlign('dossier_upd.vUpd_no', 'left');
                $grid->setLabel('dossier_upd.vUpd_no','No UPD');

                $grid->setWidth('itemas.c_itnam', '300');
                $grid->setAlign('itemas.c_itnam', 'left');
                $grid->setLabel('itemas.c_itnam','Nama Produk');

                $grid->setWidth('isubmit_mbr', '200');
                $grid->setAlign('isubmit_mbr', 'left');
                $grid->setLabel('isubmit_mbr','Status Dok. MBR');

                $grid->setWidth('vnama_inisiator', '100');
                $grid->setAlign('vnama_inisiator', 'left');
                $grid->setLabel('vnama_inisiator','Nama Inisiator');

                $grid->setWidth('idept_id', '100');
                $grid->setAlign('idept_id', 'left');
                $grid->setLabel('idept_id','Departement');

                $grid->setWidth('talasan_refor', '100');
                $grid->setAlign('talasan_refor', 'left');
                $grid->setLabel('talasan_refor','Alasan Refor');    

                $grid->setWidth('refor_file', '100');
                $grid->setAlign('refor_file', 'left');
                $grid->setLabel('refor_file','File'); 

                $grid->setWidth('dok_mbr_file', '100');
                $grid->setAlign('dok_mbr_file', 'left');
                $grid->setLabel('dok_mbr_file','File Dok MBR');    

                $grid->setWidth('iteam_pd', '100');
                $grid->setAlign('iteam_pd', 'left');
                $grid->setLabel('iteam_pd','Team PD');    

                $grid->setWidth('dreq_refor_lokal', '100');
                $grid->setAlign('dreq_refor_lokal', 'left');
                $grid->setLabel('dreq_refor_lokal','Tgl Permintaan Refor Lokal');    

                $grid->setWidth('tappr_inisiator', '100');
                $grid->setAlign('tappr_inisiator', 'left');
                $grid->setLabel('tappr_inisiator','Approval Atasan Inisiator');    

                $grid->setWidth('cformulator', '100');
                $grid->setAlign('cformulator', 'left');
                $grid->setLabel('cformulator','PIC Formulator Refor');                
            
                $grid->setWidth('drevisi_mbr', '100');
                $grid->setAlign('drevisi_mbr', 'left');
                $grid->setLabel('drevisi_mbr','Tgl Revisi MBR');
            
                $grid->setWidth('drequest_cc', '100');
                $grid->setAlign('drequest_cc', 'left');
                $grid->setLabel('drequest_cc','Tgl Request Change Control');
            
                $grid->setWidth('vno_cc', '100');
                $grid->setAlign('vno_cc', 'left');
                $grid->setLabel('vno_cc','No Change Control ');
            
                $grid->setWidth('dappr_cc', '100');
                $grid->setAlign('dappr_cc', 'left');
                $grid->setLabel('dappr_cc','Tgl Approve Change Control');
            
                $grid->setWidth('istat_cc', '100');
                $grid->setAlign('istat_cc', 'left');
                $grid->setLabel('istat_cc','Status Change Control');
            
                $grid->setWidth('iappr_pd', '100');
                $grid->setAlign('iappr_pd', 'left');
                $grid->setLabel('iappr_pd','Approved By PD');
            
                $grid->setWidth('tappr_pd', '100');
                $grid->setAlign('tappr_pd', 'left');
                $grid->setLabel('tappr_pd','PD Approval');
            
                $grid->setWidth('dappr_pd', '100');
                $grid->setAlign('dappr_pd', 'left');
                $grid->setLabel('dappr_pd','Tgl Approval PD');
            
                $grid->setWidth('cCreate', '100');
                $grid->setAlign('cCreate', 'left');
                $grid->setLabel('cCreate','CCREATE');
            
                $grid->setWidth('dCreate', '100');
                $grid->setAlign('dCreate', 'left');
                $grid->setLabel('dCreate','DCREATE');
                
                $grid->setWidth('cUpdate', '100');
                $grid->setAlign('cUpdate', 'left');
                $grid->setLabel('cUpdate','CUPDATE');
            
                $grid->setWidth('dUpdate', '100');
                $grid->setAlign('dUpdate', 'left');
                $grid->setLabel('dUpdate','DUPDATE');
            
                $grid->setWidth('lDeleted', '100');
                $grid->setAlign('lDeleted', 'left');
                $grid->setLabel('lDeleted','LDELETED');

                $grid->changeFieldType('isubmit_mbr','combobox','',array(''=>'--Selected--',0=>'Draft - Need to be Publish',1=>'Submitted'));
                //$grid->changeFieldType('iappr_pd','combobox','',array(''=>'--Selected--',0=>'Need Approval',1=>'Approved',2=>'Rejected'));
                $grid->setJoinTable('reformulasi.export_req_refor', 'export_req_refor.iexport_req_refor = export_dok_mbr.vno_request', 'inner');
                $grid->setJoinTable('dossier.dossier_upd', 'dossier_upd.idossier_upd_id = export_req_refor.idossier_upd_id', 'inner');
                $grid->setJoinTable('sales.itemas', 'itemas.c_iteno = dossier_upd.iupb_id', 'inner');
            
                //Example modifikasi GRID ERP
                /*
                    - Set Query
                        $grid->setQuery('lDeleted = 0 ', null); 
                        $grid->setQuery('plc2_upb.iupb_id IN (select distinct(bk.iupb_id) from plc2.plc2_upb_spesifikasi_fg bk where bk.iappqa=2 and bk.ldeleted=0)', null);  

                    - Join Table
                        $grid->setJoinTable('hrd.employee', 'employee.cNip = pk_master.vnip', 'inner');

                    - Change Field Name
                        $grid->changeFieldType('ideleted','combobox','',array(''=>'Pilih',0=>'Aktif',1=>'Tidak aktif'));
                */

                 //set search
                $grid->setSearch('export_req_refor.vno_export_req_refor','dossier_upd.vUpd_no','itemas.c_itnam');
                
                //set required
                $grid->setRequired('vno_request','drevisi_mbr','drequest_cc','vno_cc','dappr_cc','istat_cc'); 

                $grid->setGridView('grid');

                switch ($action) {
                    case 'json':
                        $grid->getJsonData();
                        break;
                    case 'view':
                        $grid->render_form($this->input->get('id'), true);
                        break;
                    case 'create':
                        $grid->render_form();
                        break;
                    case 'createproses':
                        $isUpload = $this->input->get('isUpload'); 
                        if ($isUpload){
                            $lastId=$this->input->get('lastId');
                            $path = realpath("files/reformulasi/"); 

                            /* Upload Trial */ 
                            if(!file_exists($path."/"."export/dok_mbr"."/".$lastId)){
                                if (!mkdir($path."/"."export/dok_mbr"."/".$lastId, 0777, true)) { 
                                    die('Failed upload, try again!');
                                }
                            } 
                            $fileketerangan = array();
                            foreach($_POST as $key=>$value) {                       
                                if ($key == 'fileketerangan_export_dokumentasi_mbr_file') {
                                    foreach($value as $k=>$v) {
                                        $fileketerangan[$k] = $v;
                                    }
                                }
                            } 
                            $i=0; 
                            $sql = array();
                            foreach ($_FILES['fileid_export_dokumentasi_mbr_file_upload_export_dokumentasi_mbr_file']["error"] as $key => $error) {
                                if ($error == UPLOAD_ERR_OK) {
                                    $tmp_name = $_FILES['fileid_export_dokumentasi_mbr_file_upload_export_dokumentasi_mbr_file']["tmp_name"][$key];
                                    $name =$_FILES['fileid_export_dokumentasi_mbr_file_upload_export_dokumentasi_mbr_file']["name"][$key];
                                    $data['filename'] = $name;
                                    $data['dInsertDate'] = date('Y-m-d H:i:s');

                                        if(move_uploaded_file($tmp_name, $path."/"."export/dok_mbr"."/".$lastId."/".$name)) {
                                            $sql[]="INSERT INTO reformulasi.export_dok_mbr_file (iexport_dok_mbr, 
                                                    vFilename, dCreate, cCreate, 
                                                    tKeterangan) 
                                                    VALUES (".$lastId.",'".$data['filename']."',
                                                        '".$data['dInsertDate']."','".$this->user->gNIP."',
                                                        '".$fileketerangan[$i]."')";
                                            $i++;   
                                        }
                                        else{
                                            echo "Upload ke folder gagal";  
                                        }
                                }
                            }
                            foreach($sql as $q) {
                                try {
                                    $this->db->query($q);
                                }catch(Exception $e) {
                                die($e);
                                }
                            } 
                        }else{
                            echo $grid->saved_form();
                        }
                        break;
                    case 'update':
                        $grid->render_form($this->input->get('id'));
                        break;
                    case 'updateproses':
                        $isUpload = $this->input->get('isUpload'); 
                        if ($isUpload){
                            $post=$this->input->post();
                            $lastId=$post['export_dokumentasi_mbr_idok_mbr'];
                            $path = realpath("files/reformulasi/"); 

                            $sql = "UPDATE reformulasi.export_dok_mbr_file SET cUpdate = '".$this->user->gNIP."', dUpdate = '".date('Y-m-d H:i:s')."', lDeleted = '1' WHERE iexport_dok_mbr = '".$lastId."'";

                            /* Upload Trial */ 
                            if(!file_exists($path."/"."export/dok_mbr"."/".$lastId)){
                                if (!mkdir($path."/"."export/dok_mbr"."/".$lastId, 0777, true)) { 
                                    die('Failed upload, try again!');
                                }
                            } 
                            $fileketerangan = array();
                            foreach($_POST as $key=>$value) {                       
                                if ($key == 'fileketerangan_export_dokumentasi_mbr_file') {
                                    foreach($value as $k=>$v) {
                                        $fileketerangan[$k] = $v;
                                    }
                                }
                            } 
                            $i=0; 
                            $sql = array();
                            foreach ($_FILES['fileid_export_dokumentasi_mbr_file_upload_export_dokumentasi_mbr_file']["error"] as $key => $error) {
                                if ($error == UPLOAD_ERR_OK) {
                                    $tmp_name = $_FILES['fileid_export_dokumentasi_mbr_file_upload_export_dokumentasi_mbr_file']["tmp_name"][$key];
                                    $name =$_FILES['fileid_export_dokumentasi_mbr_file_upload_export_dokumentasi_mbr_file']["name"][$key];
                                    $data['filename'] = $name;
                                    $data['dInsertDate'] = date('Y-m-d H:i:s');

                                        if(move_uploaded_file($tmp_name, $path."/"."export/dok_mbr"."/".$lastId."/".$name)) {
                                            $sql[]="INSERT INTO reformulasi.export_dok_mbr_file (iexport_dok_mbr, 
                                                    vFilename, dCreate, cCreate, 
                                                    tKeterangan) 
                                                    VALUES (".$lastId.",'".$data['filename']."',
                                                        '".$data['dInsertDate']."','".$this->user->gNIP."',
                                                        '".$fileketerangan[$i]."')";
                                            $i++;   
                                        }
                                        else{
                                            echo "Upload ke folder gagal";  
                                        }
                                }
                            }
                            foreach($sql as $q) {
                                try {
                                    $this->db->query($q);
                                }catch(Exception $e) {
                                die($e);
                                }
                            } 
                        }else{
                            echo $grid->updated_form();
                        }
                        break;
                    case 'delete':
                        echo $grid->delete_row();
                        break; 
                    case 'download':
                        $this->download($this->input->get('file'));
                        break;
                    
                        //Ini Merupakan Standart Case Untuk Approve

                        case 'approve':
                            echo $this->approve_view();
                            break;
                        case 'approve_process':
                            echo $this->approve_process();
                            break;
                        case 'reject':
                            echo $this->reject_view();
                            break;
                        case 'reject_process':
                            echo $this->reject_process();
                            break; 
                     
                    default:
                            $grid->render_grid();
                            break;
                }
            }
            //Create Manipulate Field 

            //Jika Ingin Menambahkan Seting grid seperti button edit enable dalam kondisi tertentu
            function listBox_Action($row, $actions) {
                if ($row->iappr_pd<>0 ) { 
                    // if ($row->iappr_pd<>0 ) { 
                        unset($actions['edit']);
                    // }else{
                    //     $type = '';
                    //     if($this->auth_export->is_manager()){
                    //         $x=$this->auth_export->tipe();
                    //         $manager=$x['manager'];
                    //         if(in_array('PD', $manager)){
                    //             $type='PD';
                    //         }
                    //         else{
                    //             $type='';
                    //         }
                    //     }  
                    //     if(!$this->auth_export->is_manager() && $type!='PD'){
                    //         unset($actions['edit']);
                    //     }
                    // }
                }
                return $actions;
            } 
            function listBox_export_dokumentasi_mbr_iappr_pd($value) {
                if($value==0){$vstatus='Waiting for approval';}
                elseif($value==1){$vstatus='Rejected';}
                elseif($value==2){$vstatus='Approved';}
                return $vstatus;
            }
            function insertBox_export_dokumentasi_mbr_vno_request($field, $id) {
                $uri = 'export_dokumentasi_mbr';
                $o = '<input type="hidden" name="isdraft" id="isdraft">';  
                $o   .= "<div style='
                                padding: 3px;
                                width: 500px;
                                border: 1px solid rgba(51, 23, 93, 0.2);
                                background-color: #FFF;'>";
                
                $o   .= "<table border='0' style='width: 100%;'>
                            <tbody>";  
                $o  .="         <tr>
                                    <td width='20%'>No Request</td>
                                    <td>:</td>
                                    <td width='75%'>";
                $o .= '         <input type="hidden" name="'.$field.'"  id="'.$id.'"  class="'.$id.' input_rows1 required" size="30" />';
                $o .= '         <input readonly type="text" name="'.$uri.'_vno_export_req_refor"  id="'.$uri.'_vno_export_req_refor"  class="'.$uri.'_vno_export_req_refor required input_rows1" size="30" />';
                $o .= '         &nbsp;<button class="icon_pop"  onclick="browse(\''.base_url().'processor/reformulasi/browse/dok/mbr/export/?field=export_dokumentasi_mbr\',\'Request Reformulasi\')" type="button">Browse</button>';  
                $o  .="             </td>
                                </tr>
                                
                                <tr>
                                    <td width='20%'>Nama Produk</td>
                                    <td>:</td>
                                    <td width='75%'> 
                                        <span class='".$uri."_cIteno' id='".$uri."_cIteno'></span> 
                                    </td>
                                </tr>

                                <tr>
                                    <td width='20%'>No. UPD</td>
                                    <td>:</td>
                                    <td width='75%'> 
                                        <span class='".$uri."_updID' id='".$uri."_updID'></span> 
                                    </td>
                                </tr>
                                 

                                <tr>
                                    <td width='20%'>Nama Inisiator</td>
                                    <td>:</td>
                                    <td width='75%'> 

                                        <span class='".$uri."_cInisiator' id='".$uri."_cInisiator'></span>
                                    </td>
                                </tr>

                                <tr>
                                    <td width='20%'>Dapartement</td>
                                    <td>:</td>
                                    <td width='75%'> 
                                        <span class='".$uri."_cdapart' id='".$uri."_cdapart'></span>
                                    </td>
                                </tr>

                                <tr>
                                    <td width='20%'>Alasan Refor</td>
                                    <td>:</td>
                                    <td width='75%'> 
                                        <span class='".$uri."_vAlasan_refor' id='".$uri."_vAlasan_refor'></span>
                                    </td>
                                </tr> 

                                <tr>
                                    <td width='20%'>Team PD</td>
                                    <td>:</td>
                                    <td width='75%'> 
                                        <span class='".$uri."_iTeamPD' id='".$uri."_iTeamPD'></span>  
                                    </td>
                                </tr>

                                <tr>
                                    <td width='20%'>Tgl Permintaan Refor</td>
                                    <td>:</td>
                                    <td width='75%'> 
                                        <span class='".$uri."_dRequest' id='".$uri."_dRequest'></span> 
                                    </td>
                                </tr>

                                <tr>
                                    <td width='20%'>Approval Atasan Inisiator</td>
                                    <td>:</td>
                                    <td width='75%'> 
                                        <span class='".$uri."_iStatus' id='".$id."_iStatus'></span> 
                                    </td>
                                </tr>

                                <tr>
                                    <td width='20%'>PIC Formulator Refor</td>
                                    <td>:</td>
                                    <td width='75%'> 
                                        <span class='".$uri."_cFormulator' id='".$uri."_cFormulator'></span>  
                                    </td>
                                </tr>

                                <tr>
                                    <td width='20%'>File Upload</td>
                                    <td>:</td>
                                    <td width='75%'> 
                                        <span class='".$uri."_iupload_f' id='".$uri."_iupload_f'></span>
                                    </td>
                                </tr>

                                
                                
                            </tbody>    
                        </table>"; 
                $o .= "    </div>";  

                $o .= '<script>
                        $( "button.icon_pop" ).button({
                            icons: {
                                primary: "ui-icon-newwin"
                            }, 
                        })
                    </script>';

                     
                return $o;
            }
            function updateBox_export_dokumentasi_mbr_vno_request($field, $id, $value, $rowData) {
                $sql = "SELECT * FROM reformulasi.`export_req_refor` lr WHERE lr.`lDeleted` = 0 AND lr.`iexport_req_refor` = '".$value."'";
                $dt = $this->db->query($sql)->row_array();
                $_cIteno = ''; 
                $_vno_export_req_refor='';
                $_vBatch_no='';
                $_vAlasan_refor='';
                $_dRequest=''; 
                $_cIteno=''; 
                $_cInisiator='';
                $_cdapart='';
                $_iTeamPD='';
                $_iStatus='';
                $_cFormulator='';
                $_iupload_f = '';
                if(!empty($dt['iexport_req_refor'])){
                        $sq_all='SELECT * FROM reformulasi.`export_req_refor_file` lf WHERE lf.lDeleted = 0 AND 
                                lf.iexport_req_refor = "'.$value.'"'; 
                        $data['sq_all'] = $this->db->query($sq_all)->result_array();  
                        $_iupload_f =  $this->load->view('export/export_dokumentasi_mbr_ref_file',$data,TRUE);


                        $_vno_export_req_refor = $dt['vno_export_req_refor']; 
                        $_vAlasan_refor = str_replace("'", "",str_replace('""', '', $dt['tAlasan_export']));
                        $_dRequest = $dt['dPermintaan_req_export'];
                        
                        $itname = "SELECT i.`c_itnam` FROM sales.`itemas` i 
                            JOIN `dossier`.`dossier_upd` d ON d.`iupb_id` = i.`c_iteno`
                            WHERE  d.`idossier_upd_id` =  '".$dt['idossier_upd_id']."'"; 
                        $c_itnam = $this->db->Query($itname)->row_array();
                        if(empty($c_itnam['c_itnam'])){
                            $c_itnam['c_itnam'] = '-';
                        } 
                        $_cIteno = $c_itnam['c_itnam'];

 
                        $vn = "SELECT e.`vName` FROM hrd.`employee` e WHERE e.`cNip` = '".$dt['cInisiator_export']."'";
                                $vName = $this->db->query($vn)->row_array();
                        if(empty($vName['vName'])){
                            $vName['vName'] = '-';
                        }
                        $_cInisiator = $vName['vName'];


                        $dp = "SELECT m.`vDescription` FROM  hrd.`msdepartement` m  
                                WHERE m.`iDeptID` = '".$dt['iDapartemen_export']."'";
                        $cdapart = $this->db->query($dp)->row_array(); 
                        if(empty($cdapart['vDescription'])){
                            $cdapart['vDescription'] = '-';
                        }
                        $_cdapart = $cdapart['vDescription'];

                        $pd = "SELECT r.vteam FROM reformulasi.`reformulasi_team` r WHERE r.ldeleted=0 AND r.ireformulasi_team= '".$dt['iTeamPD']."'";
                        $c_pd = $this->db->Query($pd)->row_array();
                        if(empty($c_pd['vteam'])){
                            $c_pd['vteam'] = '-';
                        } 
                        $_iTeamPD=$c_pd['vteam'];

                        $ap = "SELECT e.`vName` FROM hrd.`employee` e WHERE e.`cNip` = '".$dt['cApproval_ats_inisiator']."'";
                        $app = $this->db->query($ap)->row_array();
                        if($dt['iApproval_ats_inisiator']==2){
                            if(empty($app['vName'])){
                                $app['vName'] = 'Approved'.' Tgl '.$dt['dApproval_ats_inisiator'];
                            }else{ 
                                $app['vName'] = 'Approved by '.$app['vName'].' Tgl '.$dt['dApproval_ats_inisiator'];
                            }
                        }else if($dt['iApproval_ats_inisiator']==1){
                            if(empty($app['vName'])){
                                $app['vName'] = 'Rejected'.' Tgl '.$dt['dApproval_ats_inisiator'];
                            }else{ 
                                $app['vName'] = 'Rejected by '.$app['vName'].' Tgl '.$dt['dApproval_ats_inisiator'];
                            }
                        }else{
                            $app['vName'] = 'Waiting Approval';
                        }
 
                        $_iStatus = $app['vName'];


                        $for = "SELECT e.`vName` FROM hrd.`employee` e WHERE e.`cNip` = '".$dt['cPicFormulator']."'";
                        $formu = $this->db->query($for)->row_array();
                        if(empty($formu['vName'])){
                            $formu['vName'] = '-';
                        }
                        $_cFormulator = $formu['vName'];
                }

                $uri = 'export_refor_skala_trial';
                $o = "";  
                $o   .= "<div style='
                                padding: 3px;
                                width: 500px;
                                border: 1px solid rgba(51, 23, 93, 0.2);
                                background-color: #FFF;'>";
                
                
                $o   .= "<table border='0' style='width: 100%;'>
                            <tbody>";  
                $o  .="         <tr>
                                    <td width='20%'>No Request</td>
                                    <td>:</td>
                                    <td width='75%'>";
                $o .= '         <input type="hidden" name="'.$field.'"  id="'.$id.'"  class="'.$id.' input_rows1 required" size="30" value="'.$value.'"/>';
                $o .= '         <input readonly type="text" name="'.$uri.'_vno_export_req_refor"  id="'.$uri.'_vno_export_req_refor"  class="'.$uri.'_vno_export_req_refor required input_rows1" size="30" value="'.$_vno_export_req_refor.'"/>';
                if($rowData['isubmit_mbr']==0){
                    $o .= '         &nbsp;<button class="icon_pop"  onclick="browse(\''.base_url().'processor/reformulasi/browse/skala/trial/export/?field=export_refor_skala_trial\',\'Request Reformulasi\')" type="button">Browse</button>';  
                }
                $o  .="             </td>
                                </tr>
                                
                                <tr>
                                    <td width='20%'>Nama Produk</td>
                                    <td>:</td>
                                    <td width='75%'> 
                                        <span class='".$uri."_cIteno' id='".$uri."_cIteno'>".$_cIteno."</span> 
                                    </td>
                                </tr>
                                
                                

                                <tr>
                                    <td width='20%'>Nama Inisiator</td>
                                    <td>:</td>
                                    <td width='75%'> 

                                        <span class='".$uri."_cInisiator' id='".$uri."_cInisiator'>".$_cInisiator."</span>
                                    </td>
                                </tr>

                                <tr>
                                    <td width='20%'>Dapartement</td>
                                    <td>:</td>
                                    <td width='75%'> 
                                        <span class='".$uri."_cdapart' id='".$uri."_cdapart'>".$_cdapart."</span>
                                    </td>
                                </tr>

                                <tr>
                                    <td width='20%'>Alasan Refor</td>
                                    <td>:</td>
                                    <td width='75%'> 
                                        <span class='".$uri."_vAlasan_refor' id='".$uri."_vAlasan_refor'>".$_vAlasan_refor."</span>
                                    </td>
                                </tr> 

                                <tr>
                                    <td width='20%'>Team PD</td>
                                    <td>:</td>
                                    <td width='75%'> 
                                        <span class='".$uri."_iTeamPD' id='".$uri."_iTeamPD'>".$_iTeamPD."</span>  
                                    </td>
                                </tr>

                                <tr>
                                    <td width='20%'>Tgl Permintaan Refor</td>
                                    <td>:</td>
                                    <td width='75%'> 
                                        <span class='".$uri."_dRequest' id='".$uri."_dRequest'>".$_dRequest."</span> 
                                    </td>
                                </tr>

                                <tr>
                                    <td width='20%'>Approval Atasan Inisiator</td>
                                    <td>:</td>
                                    <td width='75%'> 
                                        <span class='".$uri."_iStatus' id='".$id."_iStatus'>".$_iStatus."</span> 
                                    </td>
                                </tr>

                                <tr>
                                    <td width='20%'>PIC Formulator Refor</td>
                                    <td>:</td>
                                    <td width='75%'> 
                                        <span class='".$uri."_cFormulator' id='".$uri."_cFormulator'>".$_cFormulator."</span>  
                                    </td>
                                </tr>

                                <tr>
                                    <td width='20%'>File Upload</td>
                                    <td>:</td>
                                    <td width='75%'> 
                                        <span class='".$uri."_iupload_f' id='".$uri."_iupload_f'>".$_iupload_f."</span>
                                    </td>
                                </tr>

                                
                                
                            </tbody>    
                        </table>"; 
                $o .= "    </div>";  

                $o .= '<script>
                        $( "button.icon_pop" ).button({
                            icons: {
                                primary: "ui-icon-newwin"
                            }, 
                        })
                    </script>';

                     
                return $o;
            }   
            
            function insertBox_export_dokumentasi_mbr_drevisi_mbr($field, $id) {
                $return = '<input type="text" name="'.$field.'"  id="'.$id.'"  class="input_rows1 required" size="30" />';
                $return .= '<script>
                                $("#'.$id.'").datepicker({  changeMonth:true,
                                        changeYear:true,
                                        dateFormat:"yy-mm-dd"}); 
                             </script>';
                return $return;
            }
            function updateBox_export_dokumentasi_mbr_drevisi_mbr($field, $id, $value, $rowData) {
                if ($this->input->get('action') == 'view') {
                     $return= $value; 
                }else{
                $return = '<input type="text" name="'.$field.'"  id="'.$id.'"  class="input_rows1 required" size="30" value="'.$value.'"/>';
                $return .= '<script>
                                $("#'.$id.'").datepicker({
                                    changeMonth:true,
                                    changeYear:true,
                                    dateFormat:"yy-mm-dd"
                                });
                             </script>';
                } 
                return $return;
            }   
            
            function insertBox_export_dokumentasi_mbr_drequest_cc($field, $id) {
                $return = '<input type="text" name="'.$field.'"  id="'.$id.'"  class="input_rows1 required" size="30" />';
                $return .= '<script>
                                $("#'.$id.'").datepicker({  changeMonth:true,
                                        changeYear:true,
                                        dateFormat:"yy-mm-dd"}); 
                             </script>';
                return $return;
            }
            function updateBox_export_dokumentasi_mbr_drequest_cc($field, $id, $value, $rowData) {
                if ($this->input->get('action') == 'view') {
                     $return= $value; 
                }else{
                $return = '<input type="text" name="'.$field.'"  id="'.$id.'"  class="input_rows1 required" size="30" value="'.$value.'"/>';
                $return .= '<script>
                                $("#'.$id.'").datepicker({
                                    changeMonth:true,
                                    changeYear:true,
                                    dateFormat:"yy-mm-dd"
                                });
                             </script>';
                } 
                return $return;
            }   
            
            function insertBox_export_dokumentasi_mbr_vno_cc($field, $id) {
                $return = '<input type="text" name="'.$field.'"  id="'.$id.'"  class="input_rows1 required" size="30" maxlength = "45" />';
                return $return;
            }
            function updateBox_export_dokumentasi_mbr_vno_cc($field, $id, $value, $rowData) {
                if ($this->input->get('action') == 'view') {
                     $return= $value; 
                }else{
                $return = '<input type="text" name="'.$field.'"  id="'.$id.'"  class="input_rows1 required" size="30" maxlength = "45"  value="'.$value.'"/>';

                } 
                return $return;
            }   
            
            function insertBox_export_dokumentasi_mbr_dappr_cc($field, $id) {
                $return = '<input type="text" name="'.$field.'"  id="'.$id.'"  class="input_rows1 required" size="30" />';
                $return .= '<script>
                                $("#'.$id.'").datepicker({  changeMonth:true,
                                        changeYear:true,
                                        dateFormat:"yy-mm-dd"}); 
                             </script>';
                return $return;
            }
            function updateBox_export_dokumentasi_mbr_dappr_cc($field, $id, $value, $rowData) {
                if ($this->input->get('action') == 'view') {
                     $return= $value; 
                }else{
                $return = '<input type="text" name="'.$field.'"  id="'.$id.'"  class="input_rows1 required" size="30" value="'.$value.'"/>';
                $return .= '<script>
                                $("#'.$id.'").datepicker({
                                    changeMonth:true,
                                    changeYear:true,
                                    dateFormat:"yy-mm-dd"
                                });
                             </script>';
                } 
                return $return;
            }   
            
            function insertBox_export_dokumentasi_mbr_istat_cc($field, $id) {
                $echo = '<select name="'.$id.'" id="'.$id.'" class="required">';
                $echo .= '<option value="">--Pilih--</option>';
                $echo .= '<option value="1">Approval</option>';
                $echo .= '<option value="0">Not Approval</option>';
                $echo .= '</select>';
                $echo .= '<style>
                                #'.$id.'{
                                width:160px;   
                                }
                            </style>';
                return $echo;
            }
            function updateBox_export_dokumentasi_mbr_istat_cc($field, $id, $value, $rowData) {
                $ast = array(''=>'--Select--','1'=>'Approval','0'=>'Not Approval'); 

                if ($this->input->get('action') == 'view') {
                    $return= $ast[$value];
                }
                else{
                    $return  = "<select id='".$id."' class='combobox' name='".$field."'>";            
                        foreach($ast as $k=>$v) {
                            if ($k == $value) $selected = " selected";
                            else $selected = "";
                            $return .= "<option {$selected} value='".$k."'>".$v."</option>";
                        }            
                    $return .= "</select><input type='hidden' name='isdraft' id='isdraft'>";
                    $return .= '<style>
                                    #'.$id.'{
                                    width:160px;   
                                    }
                                </style>';
                }
                
                return $return;
            }   
            
            function insertBox_export_dokumentasi_mbr_iappr_pd($field, $id) {
                $return = '<input type="text" name="'.$field.'"  id="'.$id.'"  class="input_rows1 required" size="30" />';
                $return .= '<script>
                                $("#'.$id.'").keyup(function() {
                                     this.value = this.value.replace(/[^0-9\.]/g,"");
                                });
                             </script>';
                return $return;
            }
            function updateBox_export_dokumentasi_mbr_iappr_pd($field, $id, $value, $rowData) {
                if ($this->input->get('action') == 'view') {
                     $return= $value; 
                }else{
                $return = '<input type="text" name="'.$field.'"  id="'.$id.'"  class="input_rows1 required" size="30" value="'.$value.'"/>';
                $return .= '<script>
                                $("#'.$id.'").keyup(function() {
                                     this.value = this.value.replace(/[^0-9\.]/g,"");
                                });
                             </script>';
                } 
                return $return;
            }   
            
            function insertBox_export_dokumentasi_mbr_tappr_pd($field, $id) {
                $return ='';
                $return .= '
                            <script type="text/javascript">
                                $("label[for=\''.$id.'\']").hide();
                                $("label[for=\''.$id.'\']").next().css("margin-left",0);
                            </script>
                        ';
                $return .= '<div></div>';
                return $return;
            }
            function updateBox_export_dokumentasi_mbr_tappr_pd($field, $id, $value, $rowData) {
                $iappr = $rowData['iappr_pd'];
                if(($iappr <> 0) || (!empty($iappr))){
                    $sql_dtapp = "SELECT * FROM reformulasi.`export_dok_mbr` a JOIN hrd.employee b on b.cNip=a.cappr_pd WHERE a.`lDeleted` = 0 AND a.idok_mbr = '".$rowData['idok_mbr']."'";
                    $row = $this->db->query($sql_dtapp)->row_array();
                    
                    if($iappr==2){
                        $st='<i><p style="">Approved';
                        $ret= $st.' oleh '.$row['vName'].' pada '.$row['dappr_pd'].'</br> Alasan: '.$row['tappr_pd'].'</p>';
                    }
                    elseif($iappr==1){
                        $st='<i><p style="color:red;">Rejected';
                        $ret= $st.' oleh '.$row['vName'].' pada '.$row['dappr_pd'].'</br> Alasan: '.$row['tappr_pd'].'</p>';
                    } 
                }
                else{
                    $ret='Waiting for Approval';
                }
                $ret .= "</i><input type='hidden' name='".$field."' id='".$id."'  value='".$value."'/>";
                return $ret;
            }   
            
            function insertBox_export_dokumentasi_mbr_dappr_pd($field, $id) {
                $return = '<input type="text" name="'.$field.'"  id="'.$id.'"  class="input_rows1 required" size="30" />';
                $return .= '<script>
                                $("#'.$id.'").datepicker({  changeMonth:true,
                                        changeYear:true,
                                        dateFormat:"yy-mm-dd"}); 
                             </script>';
                return $return;
            }
            function updateBox_export_dokumentasi_mbr_dappr_pd($field, $id, $value, $rowData) {
                if ($this->input->get('action') == 'view') {
                     $return= $value; 
                }else{
                $return = '<input type="text" name="'.$field.'"  id="'.$id.'"  class="input_rows1 required" size="30" value="'.$value.'"/>';
                $return .= '<script>
                                $("#'.$id.'").datepicker({
                                    changeMonth:true,
                                    changeYear:true,
                                    dateFormat:"yy-mm-dd"
                                });
                             </script>';
                } 
                return $return;
            }   
            
            function insertBox_export_dokumentasi_mbr_dok_mbr_file($field, $id) {
                $data['rows']=array();
                $return = $this->load->view('export/export_dokumentasi_mbr_file',$data,TRUE);
                return $return;
            }
            function updateBox_export_dokumentasi_mbr_dok_mbr_file($field, $id, $value, $rowData) {
                $sq = "SELECT * FROM reformulasi.`export_dok_mbr_file` lr WHERE lr.`lDeleted` = 0 AND lr.`iexport_dok_mbr` ='".$rowData['idok_mbr']."'";
                $data['rows']=$this->db->query($sq)->result_array();
                $return = $this->load->view('export/export_dokumentasi_mbr_file',$data,TRUE);
                return $return;
            }   
            
            function insertBox_export_dokumentasi_mbr_dCreate($field, $id) {
                $return = '<input type="text" name="'.$field.'"  id="'.$id.'"  class="input_rows1 required" size="30" />';
                $return .= '<script>
                                $("#'.$id.'").datepicker({  changeMonth:true,
                                        changeYear:true,
                                        dateFormat:"yy-mm-dd"}); 
                             </script>';
                return $return;
            }
            function updateBox_export_dokumentasi_mbr_dCreate($field, $id, $value, $rowData) {
                if ($this->input->get('action') == 'view') {
                     $return= $value; 
                }else{
                $return = '<input type="text" name="'.$field.'"  id="'.$id.'"  class="input_rows1 required" size="30" value="'.$value.'"/>';
                $return .= '<script>
                                $("#'.$id.'").datepicker({
                                    changeMonth:true,
                                    changeYear:true,
                                    dateFormat:"yy-mm-dd"
                                });
                             </script>';
                } 
                return $return;
            }   
             
            
            
                //Ini Merupakan Standart Approve yang digunakan di erp
 
                function approve_view() {
                    $echo = '<script type="text/javascript">
                                 function submit_ajax(form_id) {
                                    return $.ajax({
                                        url: $("#"+form_id).attr("action"),
                                        type: $("#"+form_id).attr("method"),
                                        data: $("#"+form_id).serialize(),
                                        success: function(data) {
                                            var o = $.parseJSON(data);
                                            var last_id = o.last_id;
                                            var url = "'.base_url().'processor/reformulasi/export_dokumentasi_mbr";                             
                                            if(o.status == true) { 
                                                $("#alert_dialog_form").dialog("close");
                                                     $.get(url+"?action=update&id="+last_id, function(data) {
                                                     $("div#form_export_dokumentasi_mbr").html(data);
                                                     
                                                });
                                                
                                            }
                                                reload_grid("grid_export_dokumentasi_mbr");
                                        }
                                        
                                     })
                                 }
                             </script>';
                    $echo .= '<h1>Approve</h1><br />';
                    $echo .= '<form id="form_export_dokumentasi_mbr_approve" action="'.base_url().'processor/reformulasi/export_dokumentasi_mbr?action=approve_process" method="post">';
                    $echo .= '<div style="vertical-align: top;">';
                    $echo .= 'Remark : 
                            <input type="hidden" name="idok_mbr" value="'.$this->input->get('idok_mbr').'" />
                            <input type="hidden" name="lvl" value="'.$this->input->get('lvl').'" />
                            <input type="hidden" name="group_id" value="'.$this->input->get('group_id').'" />
                            <input type="hidden" name="modul_id" value="'.$this->input->get('modul_id').'" />
                            <textarea name="vRemark"></textarea>
                    <button type="button" onclick="submit_ajax(\'form_export_dokumentasi_mbr_approve\')">Approve</button>';
                        
                    $echo .= '</div>';
                    $echo .= '</form>';
                    return $echo;
                } 
 
                function approve_process() {
                    $post = $this->input->post();
                    $nip= $this->user->gNIP;
                    $vName= $this->user->gName;
                    $idok_mbr = $post['idok_mbr'];
                    $vRemark = $post['vRemark'];
                    $lvl = $post['lvl'];
 
                    //Letakan Query Update approve disini
                    $skg=date('Y-m-d H:i:s'); 
                    $this->db->where('idok_mbr', $post['idok_mbr']);
                    $this->db->update('reformulasi.export_dok_mbr', array('iappr_pd'=>2,'cappr_pd'=>$nip,'dappr_pd'=>$skg,'tappr_pd'=>$vRemark));

                    $data['status']  = true;
                    $data['last_id'] = $post['idok_mbr'];
                    return json_encode($data);
                }
            

        
            
                //Ini Merupakan Standart Reject yang digunakan di erp

                function reject_view() {
                    $echo = '<script type="text/javascript">
                                 function submit_ajax(form_id) {
                                    var remark = $("#export_dokumentasi_mbr_remark").val();
                                    if (remark=="") {
                                        alert("Remark tidak boleh kosong ");
                                        return
                                    }

                                    return $.ajax({
                                        url: $("#"+form_id).attr("action"),
                                        type: $("#"+form_id).attr("method"),
                                        data: $("#"+form_id).serialize(),
                                        success: function(data) {
                                            var o = $.parseJSON(data);
                                            var last_id = o.last_id;
                                            var url = "'.base_url().'processor/reformulasi/export_dokumentasi_mbr";                             
                                            if(o.status == true) { 
                                                $("#alert_dialog_form").dialog("close");
                                                     $.get(url+"?action=update&id="+last_id, function(data) {
                                                     $("div#form_export_dokumentasi_mbr").html(data);
                                                     
                                                });
                                                
                                            }
                                                reload_grid("grid_export_dokumentasi_mbr");
                                        }
                                        
                                     })
                                 }
                             </script>';
                    $echo .= '<h1>Reject</h1><br />';
                    $echo .= '<form id="form_export_dokumentasi_mbr_reject" action="'.base_url().'processor/reformulasi/export_dokumentasi_mbr?action=reject_process" method="post">';
                    $echo .= '<div style="vertical-align: top;">';
                    $echo .= 'Remark : 
                            <input type="hidden" name="idok_mbr" value="'.$this->input->get('idok_mbr').'" />
                            <input type="hidden" name="lvl" value="'.$this->input->get('lvl').'" />
                            <input type="hidden" name="group_id" value="'.$this->input->get('group_id').'" />
                            <input type="hidden" name="modul_id" value="'.$this->input->get('modul_id').'" />
                            <textarea name="vRemark" id="reject_export_dokumentasi_mbr_remark"></textarea>
                    <button type="button" onclick="submit_ajax(\'form_export_dokumentasi_mbr_reject\')">Reject</button>';
                        
                    $echo .= '</div>';
                    $echo .= '</form>';
                    return $echo;
                }


                
                function reject_process() {
                    $post = $this->input->post();
                    $nip= $this->user->gNIP;
                    $vName= $this->user->gName;
                    $idok_mbr = $post['idok_mbr'];
                    $vRemark = $post['vRemark'];
                    $lvl = $post['lvl'];
 
                    //Letakan Query Update approve disini
                    $skg=date('Y-m-d H:i:s'); 
                    $this->db->where('idok_mbr', $post['idok_mbr']);
                    $this->db->update('reformulasi.export_dok_mbr', array('iappr_pd'=>1,'cappr_pd'=>$nip,'dappr_pd'=>$skg,'tappr_pd'=>$vRemark));

                    $data['status']  = true;
                    $data['last_id'] = $post['idok_mbr'];
                    return json_encode($data);
                }
            

        
            //Standart Setiap table harus memiliki dCreate , cCreated, dupdate, cUpdate
            function before_insert_processor($row, $postData) {
                $postData['dCreate'] = date('Y-m-d H:i:s');
                $postData['cCreate']=$this->user->gNIP;
                if($postData['isdraft']==true){
                    $postData['isubmit_mbr']=0; 
                } 
                else{
                    $postData['isubmit_mbr']=1; 
                } 
                return $postData;

            }
            function before_update_processor($row, $postData) {
                $postData['dUpdate'] = date('Y-m-d H:i:s');
                $postData['cUpdate'] = $this->user->gNIP;
                if($postData['isdraft']==true){
                    $postData['isubmit_mbr']=0; 
                } 
                else{
                    $postData['isubmit_mbr']=1; 
                } 
                return $postData; 
            }    
        
            function after_insert_processor($fields, $id, $postData) {
                //Example After Insert
                /*
                $cNip = $this->sess_auth->gNIP; 
                $sql = 'Place Query In Here';
                $this->dbset->query($sql);
                */
                        /*$sq = 'select * from reformulasi.export_dok_mbr a where a.idok_mbr = "'.$id.'" ';

                        $sq = '
                                SELECT export_req_refor.iTeamPD,export_req_refor.iTeamAndev
                                ,a.*,b.*,export_request_sample.vRequest_no,plc2_raw_material.vnama
                                FROM (`reformulasi`.`export_request_sample_detail`)
                                INNER JOIN `reformulasi`.`export_request_sample` ON `export_request_sample`.`iexport_request_sample` = `export_request_sample_detail`.`iexport_request_sample`
                                INNER JOIN `reformulasi`.`export_ro_detail` ON `export_ro_detail`.`iexport_request_sample_detail` = `export_request_sample_detail`.`iexport_request_sample_detail`
                                INNER JOIN `reformulasi`.`export_ro` ON `export_ro`.`iexport_ro` = `export_ro_detail`.`iexport_ro`
                                INNER JOIN `plc2`.`plc2_raw_material` ON `plc2_raw_material`.`raw_id` = `export_request_sample_detail`.`raw_id`
                                INNER JOIN `reformulasi`.`export_req_refor` ON `export_req_refor`.`iexport_req_refor` = `export_request_sample`.`iexport_req_refor`
                                INNER JOIN `dossier`.`dossier_upd` ON `dossier_upd`.`idossier_upd_id` = `export_req_refor`.`idossier_upd_id`
                                join reformulasi.export_uji_mikro_bb a on a.iexport_request_sample_detail=export_request_sample_detail.iexport_request_sample_detail
                                join hrd.employee b on b.cNip=a.cPic_uji
                                WHERE `reformulasi`.`export_ro_detail`.`iUji_mikro` =  2
                                and  a.iexport_uji_mikro_bb = '".$id."'


                        ';*/
                        $sq = 'SELECT export_req_refor.iTeamPD,export_req_refor.iTeamAndev
                                ,export_req_refor.*,
                                reformulasi.export_dok_mbr.* FROM (`reformulasi`.`export_dok_mbr`) 
                                INNER JOIN `reformulasi`.`export_req_refor` ON `export_req_refor`.`iexport_req_refor` = `export_dok_mbr`.`vno_request` 
                                INNER JOIN `dossier`.`dossier_upd` ON `dossier_upd`.`idossier_upd_id` = `export_req_refor`.`idossier_upd_id` 
                                INNER JOIN `sales`.`itemas` ON `itemas`.`c_iteno` = `dossier_upd`.`iupb_id` 
                                WHERE `export_dok_mbr`.`idok_mbr` = "'.$id.'" 

                        ';
                        $rsql = $this->db->query($sq)->row_array();
                        if ($rsql['isubmit_mbr']) {
                            // kirim notifikasi message ERp
                            $sqlEmpAr = 'select * from reformulasi.mailsparam a where a.cVariable="export_dokumentasi_mbr "';
                            $dEmpAr =  $this->db->query($sqlEmpAr)->row_array();

                               

                            $to = $dEmpAr['vTo'];
                            $cc = $dEmpAr['vCc'];

                            

                            $pd = $rsql['iTeamPD'];
                            $andev = $rsql['iTeamAndev'];
                            $qa = '10';


                            $jointeam = $pd.','.$andev.','.$qa;
                            $toEmail = $this->lib_utilitas->get_nip_team( $jointeam );
                            $to = $to.','.$toEmail;
                            $cc = $cc.','.$this->user->gNIP;                        

                            $subject = 'Reformulasi - New Dokumentasi MBR '.$rsql['vno_export_req_refor'];
                            $content="
                                Diberitahukan bahwa telah ada Submitted Dokumentasi MBR dengan rincian sebagai berikut :<br><br>  
                                    <table border='0' style='width: 600px;'>
                                        
                                        <tr>
                                                <td><b>No Request Reformulasi  </b></td><td> : </td>
                                                <td>".$rsql['vno_export_req_refor']."</td>
                                        </tr> 
                                        <tr>
                                                <td><b>No Change Control  </b></td><td> : </td>
                                                <td>".$rsql['vno_cc']."</td>
                                        </tr> 
                                        <tr>
                                                <td><b>Tanggal Revisi MBR  </b></td><td> : </td>
                                                <td>".$rsql['drevisi_mbr']."</td>
                                        </tr> 
                                    </table> 

                                <br/> <br/>
                                Demikian, mohon segera follow up  pada aplikasi ERP Reformulasi. Terimakasih.<br><br><br>
                                Post Master"; 

                            $this->sess_auth->send_message_erp($this->uri->segment_array(),$to, $cc, $subject, $content);
                        }


            }
    
            function after_update_processor($fields, $id, $postData) {
                //Example After Update
                /*
                $cNip = $this->sess_auth->gNIP; 
                $sql = 'Place Query In Here';
                $this->dbset->query($sql);
                */

                $sq = 'SELECT export_req_refor.iTeamPD,export_req_refor.iTeamAndev
                                ,export_req_refor.*,
                                reformulasi.export_dok_mbr.* FROM (`reformulasi`.`export_dok_mbr`) 
                                INNER JOIN `reformulasi`.`export_req_refor` ON `export_req_refor`.`iexport_req_refor` = `export_dok_mbr`.`vno_request` 
                                INNER JOIN `dossier`.`dossier_upd` ON `dossier_upd`.`idossier_upd_id` = `export_req_refor`.`idossier_upd_id` 
                                INNER JOIN `sales`.`itemas` ON `itemas`.`c_iteno` = `dossier_upd`.`iupb_id` 
                                WHERE `export_dok_mbr`.`idok_mbr` = "'.$id.'" 

                        ';
                        $rsql = $this->db->query($sq)->row_array();
                        if ($rsql['isubmit_mbr']) {
                            // kirim notifikasi message ERp
                            $sqlEmpAr = 'select * from reformulasi.mailsparam a where a.cVariable="export_dokumentasi_mbr "';
                            $dEmpAr =  $this->db->query($sqlEmpAr)->row_array();

                               

                            $to = $dEmpAr['vTo'];
                            $cc = $dEmpAr['vCc'];

                            

                            $pd = $rsql['iTeamPD'];
                            $andev = $rsql['iTeamAndev'];
                            $qa = '10';


                            $jointeam = $pd.','.$andev.','.$qa;
                            $toEmail = $this->lib_utilitas->get_nip_team( $jointeam );
                            $to = $to.','.$toEmail;
                            $cc = $cc.','.$this->user->gNIP;                        

                            $subject = 'Reformulasi - New Dokumentasi MBR '.$rsql['vno_export_req_refor'];
                            $content="
                                Diberitahukan bahwa telah ada Submitted Dokumentasi MBR dengan rincian sebagai berikut :<br><br>  
                                    <table border='0' style='width: 600px;'>
                                        
                                        <tr>
                                                <td><b>No Request Reformulasi  </b></td><td> : </td>
                                                <td>".$rsql['vno_export_req_refor']."</td>
                                        </tr> 
                                        <tr>
                                                <td><b>No Change Control  </b></td><td> : </td>
                                                <td>".$rsql['vno_cc']."</td>
                                        </tr> 
                                        <tr>
                                                <td><b>Tanggal Revisi MBR  </b></td><td> : </td>
                                                <td>".$rsql['drevisi_mbr']."</td>
                                        </tr> 
                                    </table> 

                                <br/> <br/>
                                Demikian, mohon segera follow up  pada aplikasi ERP Reformulasi. Terimakasih.<br><br><br>
                                Post Master"; 

                            $this->sess_auth->send_message_erp($this->uri->segment_array(),$to, $cc, $subject, $content);
                        }
                        
            }
            function manipulate_insert_button($buttons) {
                unset($buttons['save']);
                $js = $this->load->view('export/js/export_dokumentasi_mbr_js'); 

                $save_draft = '<button onclick="javascript:save_draft_btn_multiupload(\'export_dokumentasi_mbr\', \''.base_url().'processor/reformulasi/export/dokumentasi/mbr?draft=true\', this, true)" class="ui-button-text icon-save" id="button_save_draft_export_dokumentasi_mbr_js">Save as Draft</button>';
                $save = '<button onclick="javascript:save_btn_multiupload(\'export_dokumentasi_mbr\', \''.base_url().'processor/reformulasi/export/dokumentasi/mbr?company_id='.$this->input->get('company_id').'&group_id='.$this->input->get('group_id').'&modul_id='.$this->input->get('modul_id').'\', this)" class="ui-button-text icon-save" id="button_save_export_dokumentasi_mbr_js">Save &amp Submit</button>';
                 
                
                $buttons['save'] = $save_draft.$save.$js; 

                return $buttons;
            }
            function manipulate_update_button($buttons, $rowData) { 
                //Load Javascript In Here 
                if ($this->input->get('action') == 'view') {
                    unset($buttons['update_back']);
                    unset($buttons['update']);
                }
                else{ 
                    $cNip= $this->user->gNIP;
            
                    $js = $this->load->view('export/js/export_dokumentasi_mbr_js'); 
                    $update = '<button onclick="javascript:update_btn_back(\'export_dokumentasi_mbr\', \''.base_url().'processor/reformulasi/export/dokumentasi/mbr?company_id='.$this->input->get('company_id').'&group_id='.$this->input->get('group_id').'&modul_id='.$this->input->get('modul_id').'\', this)" class="ui-button-text icon-save" id="button_update_export_dokumentasi_mbr_js">Update & Submit</button>';
                    $updatedraft = '<button onclick="javascript:update_draft_btn(\'export_dokumentasi_mbr\', \''.base_url().'processor/reformulasi/export/dokumentasi/mbr?company_id='.$this->input->get('company_id').'&draft=true&group_id='.$this->input->get('group_id').'&modul_id='.$this->input->get('modul_id').'\', this, true)" class="ui-button-text icon-save" id="button_save_export_dokumentasi_mbr_js">Update as Draft</button>';
                    
                    $approve = '<button onclick="javascript:load_popup(\''.base_url().'processor/reformulasi/export/dokumentasi/mbr?action=approve&idok_mbr='.$rowData['idok_mbr'].'&cNip='.$cNip.'&lvl=1&status=1&group_id='.$this->input->get('group_id').'&modul_id='.$this->input->get('modul_id').'\')" class="ui-button-text icon-save" id="button_approve_export_dokumentasi_mbr">Approve</button>';
                    $reject = '<button onclick="javascript:load_popup(\''.base_url().'processor/reformulasi/export/dokumentasi/mbr?action=reject&idok_mbr='.$rowData['idok_mbr'].'&cNip='.$cNip.'&lvl=1&status=2&group_id='.$this->input->get('group_id').'&modul_id='.$this->input->get('modul_id').'\')" class="ui-button-text icon-save" id="button_reject_export_dokumentasi_mbr">Reject</button>';

                    $user = $this->auth_export->user();
    
                    unset($buttons['update_back']);
                    unset($buttons['update']);
                    $type = '';
                    if($this->auth_export->is_manager()){
                        $x=$this->auth_export->tipe();
                        $manager=$x['manager'];
                        if(in_array('PD', $manager)){
                            $type='PD';
                        }
                        else{
                            $type='';
                        }
                    } 

                    if($rowData['isubmit_mbr']!=1){
                        $buttons['update'] = $updatedraft.$update.$js;   
                    }else{
                        if($rowData['iappr_pd']<>0){
                            unset($buttons['update_back']);
                            unset($buttons['update']);
                        }else{
                            if($this->auth_export->is_manager() && $type=='PD'){
                                $buttons['update'] = $approve.$js;  
                            }else{
                                unset($buttons['update_back']);
                                unset($buttons['update']);
                            } 
                        }
                       
                    }

                }
                
                return $buttons;
            }

            function download($filename) {
                $this->load->helper('download');        
                $name = $_GET['file'];
                $id = $_GET['id'];
                $file = $_GET['filepath'];
                $path = file_get_contents('./files/reformulasi/export/dok_mbr/'.$id.'/'.$name);   
                force_download($name, $path);
            }

            //Output
            public function output(){
                $this->index($this->input->get('action'));
            }
        }